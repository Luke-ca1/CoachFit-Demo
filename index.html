<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CoachFit Demo (Pitch + Personal Tracking)</title>
  <style>
    :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f6f7fb;color:#111;line-height:1.35}
    body{margin:0}
    header{background:#fff;border-bottom:1px solid #e6e8ef;position:sticky;top:0;z-index:10}
    .bar{max-width:1120px;margin:0 auto;padding:12px 16px;display:flex;justify-content:space-between;align-items:center;gap:12px}
    .brand{font-weight:900;letter-spacing:.2px}
    .pill{font-size:12px;padding:2px 8px;border:1px solid #e6e8ef;border-radius:999px;background:#fafbff}
    main{max-width:1120px;margin:0 auto;padding:16px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:980px){.grid{grid-template-columns:360px 1fr}}
    .card{background:#fff;border:1px solid #e6e8ef;border-radius:14px;padding:14px;box-shadow:0 2px 10px rgba(0,0,0,.04)}
    h1,h2,h3{margin:0 0 10px 0}
    h1{font-size:24px}
    h2{font-size:18px}
    h3{font-size:14px;color:#333}
    label{display:block;font-size:12px;color:#444;margin-top:8px}
    input,select,textarea{width:100%;padding:9px 10px;border:1px solid #d9dbe3;border-radius:10px;background:#fff;font-size:14px}
    textarea{min-height:72px}
    button{padding:10px 12px;border:1px solid #d9dbe3;border-radius:12px;background:#fff;cursor:pointer}
    button.primary{background:#111;color:#fff;border-color:#111}
    button.small{padding:6px 10px;border-radius:10px;font-size:12px}
    button.danger{background:#fff0f0;border-color:#ffc2c2}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:8px 10px;border-radius:999px;border:1px solid #e6e8ef;background:#fff;cursor:pointer;font-size:13px}
    .tab.active{background:#111;color:#fff;border-color:#111}
    .muted{color:#666;font-size:13px}
    .tablewrap{overflow:auto;border:1px solid #e6e8ef;border-radius:12px}
    table{border-collapse:collapse;width:100%;min-width:1200px;background:#fff}
    th,td{padding:10px;border-bottom:1px solid #eef0f6;text-align:left;font-size:13px;vertical-align:top}
    th{font-size:12px;color:#555;background:#fafbff;position:sticky;top:0}
    .kpi{display:flex;gap:10px;flex-wrap:wrap}
    .kpi .box{border:1px solid #e6e8ef;border-radius:12px;padding:10px;background:#fafbff}
    .tag{display:inline-block;font-size:11px;padding:2px 8px;border:1px solid #e6e8ef;border-radius:999px;background:#fff;margin:2px 4px 0 0}
    .tag.attn{background:#fff8e6;border-color:#ffe2a3}
    .split{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:980px){.split{grid-template-columns:1fr 1fr}}
    .warn{background:#fff8e6;border:1px solid #ffe2a3}
    .ok{background:#eefbf1;border:1px solid #bfe9c8}
    .nav{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .nav a{font-size:13px;color:#111;text-decoration:none;padding:8px 10px;border-radius:999px;border:1px solid #e6e8ef;background:#fff}
    .nav a.active{background:#111;color:#fff;border-color:#111}
    .hr{border:none;border-top:1px solid #eef0f6;margin:14px 0}
  </style>
</head>
<body>
<header>
  <div class="bar">
    <div class="row">
      <div class="brand">CoachFit</div>
      <span class="pill">Pitch + Tracking Demo</span>
      <span class="pill" id="envPill">local</span>
    </div>

    <div class="nav" id="topNav" style="display:none;">
      <a href="#" data-nav="landing">Landing</a>
      <a href="#" data-nav="pricing">Pricing</a>
      <a href="#" data-nav="coach">Coach</a>
      <a href="#" data-nav="client">Client</a>
      <a href="#" data-nav="progress">Progress</a>
      <a href="#" data-nav="messages">Messages</a>
    </div>

    <div class="row">
      <span class="muted" id="whoami"></span>
      <button class="small" id="logoutBtn" style="display:none;">Log out</button>
    </div>
  </div>
</header>

<main>
  <div id="app"></div>
</main>

<script>
const LS_KEY = "coachfit_demo_pitch_v3";
const todayISO = () => new Date().toISOString().slice(0,10);
const addDays = (iso, delta) => {
  const d = new Date(iso + "T00:00:00");
  d.setDate(d.getDate() + delta);
  return d.toISOString().slice(0,10);
};
const fmt = (n) => (n === null || n === undefined || n === "" ? "—" : n);
const rand = (min,max)=>Math.round(min + Math.random()*(max-min));

function el(html){
  const t = document.createElement("template");
  t.innerHTML = html.trim();
  return t.content.firstChild;
}
function setEnvPill(){
  const host = location.host || "";
  document.getElementById("envPill").textContent = host.includes("vercel") || host.includes("netlify") ? "deployed" : "local";
}
function load() {
  const raw = localStorage.getItem(LS_KEY);
  if (raw) return JSON.parse(raw);
  const seed = seedData();
  localStorage.setItem(LS_KEY, JSON.stringify(seed));
  return seed;
}
function save(state){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

/** Seed */
function seedClient(id, name, email, notes, constraints){
  const t = todayISO();
  const daily = {};
  for (let i=0;i<21;i++){
    const date = addDays(t, -i);
    daily[date] = {
      steps: rand(6500, 12000),
      sleepHrs: rand(6,8),
      rhr: rand(50,64),
      stressAvg: rand(18,42),
      bodyBatteryStart: rand(70,96),
      bodyBatteryEnd: rand(15,58),
      activeCals: rand(250, 900),
      workoutDone: i%2===0,
      workoutMins: i%2===0 ? 45 : 0,
      nutritionCompliancePct: i%3===0 ? 90 : 75,
      bodyWeightKg: (70 + (Math.random()*2-1)).toFixed(1),
      waistCm: (82 + (Math.random()*2-1)).toFixed(1),
      dayNote: "",
      selfReport:{ soreness: rand(2,6), mood: rand(6,9), energy: rand(6,9), digestion: rand(3,8) }
    };
  }
  return {
    id, name, email, role:"client", coachId:"u1",
    profile:{ age:40, sex:"Male", heightCm:172, weightKg:72, constraints: constraints || [], notes: notes || "" },
    macroTargets:{ training:{kcal:2500,p:160,c:260,f:70}, rest:{kcal:2300,p:160,c:200,f:80} },
    assignedTemplateId:"mt1",
    daily
  };
}

function seedData(){
  const clients = [
    seedClient("c1","Luke (Client)","client@demo.com","Back/knee/hip history; coeliac; gut dysbiosis",["coeliac"]),
    seedClient("c2","Ava (Client)","ava@demo.com","Running focus; sleep inconsistent",["dairy_free"]),
    seedClient("c3","Noah (Client)","noah@demo.com","Strength + body comp; high stress week",[])
  ];

  const users = [
    { id:"u1", name:"Coach (Demo)", email:"coach@demo.com", role:"coach", pass:"demo" },
    { id:"c1u", name:"Luke (Client)", email:"client@demo.com", role:"client", pass:"demo", clientId:"c1" }
  ];

  const mealTemplates = [
    { id:"mt1", name:"GF High-Protein Training Day", tags:["gluten_free","high_protein"], meals:[
      { slot:"Breakfast", items:[{food:"Eggs (2)", kcal:140,p:12,c:1,f:10},{food:"Greek yogurt (200g)",kcal:140,p:20,c:8,f:0}] },
      { slot:"Lunch", items:[{food:"Chicken breast (180g)",kcal:300,p:55,c:0,f:6},{food:"Rice (250g cooked)",kcal:325,p:6,c:70,f:1}] },
      { slot:"Dinner", items:[{food:"Salmon (180g)",kcal:360,p:38,c:0,f:22},{food:"Potato (300g)",kcal:260,p:7,c:60,f:0}] },
      { slot:"Snack", items:[{food:"Whey isolate (1 scoop)",kcal:110,p:25,c:1,f:1}] },
    ]},
    { id:"mt2", name:"Simple Fat-Loss Template", tags:["high_fibre"], meals:[
      { slot:"Breakfast", items:[{food:"Oats (60g)",kcal:230,p:8,c:40,f:4},{food:"Whey (1 scoop)",kcal:110,p:25,c:1,f:1}] },
      { slot:"Lunch", items:[{food:"Lean mince (180g)",kcal:330,p:40,c:0,f:18},{food:"Salad + olive oil",kcal:200,p:2,c:10,f:18}] },
      { slot:"Dinner", items:[{food:"White fish (200g)",kcal:220,p:44,c:0,f:2},{food:"Veg + rice (200g cooked)",kcal:260,p:5,c:55,f:1}] },
      { slot:"Snack", items:[{food:"Fruit + nuts",kcal:220,p:4,c:22,f:12}] },
    ]}
  ];

  const workoutPlan = [
    { day:"Mon", name:"Upper A", exercises:["Bench Press","Row","Incline DB","Lateral Raise"] },
    { day:"Tue", name:"Lower A", exercises:["Squat","RDL","Split Squat","Calf Raise"] },
    { day:"Wed", name:"Upper B", exercises:["OHP","Pull-up","Cable Fly","Curl"] },
    { day:"Thu", name:"Lower B", exercises:["Deadlift","Leg Press","Ham Curl","Core"] },
    { day:"Fri", name:"Full Body", exercises:["Front Squat","DB Bench","Lat Pulldown","Carry"] },
  ];

  const workoutLogs = {}; // date -> clientId -> {exercise -> sets[]}
  const messages = [
    { id:"m1", from:"u1", to:"c1", at:new Date().toISOString(), text:"Welcome! Log today’s workout + quick check-in." }
  ];

  return {
    users, clients, mealTemplates, workoutPlan, workoutLogs, messages,
    session:null,
    ui:{ view:"landing", selectedClientId:"c1", coach:{ alertsOnly:false } }
  };
}

/** Session header + nav */
function setHeaderSession(state){
  const who = document.getElementById("whoami");
  const btn = document.getElementById("logoutBtn");
  const nav = document.getElementById("topNav");

  if (!state.session){
    who.textContent="";
    btn.style.display="none";
    nav.style.display="none";
    return;
  }
  const u = state.users.find(x=>x.id===state.session.userId);
  who.textContent = `${u.name} • ${u.role}`;
  btn.style.display="";
  nav.style.display="flex";
  btn.onclick = () => { state.session=null; state.ui.view="landing"; save(state); render(); };
}

function wireTopNav(state){
  const nav = document.getElementById("topNav");
  nav.querySelectorAll("a[data-nav]").forEach(a=>{
    a.onclick = (e) => {
      e.preventDefault();
      state.ui.view = a.dataset.nav;
      save(state);
      render();
    };
  });
  nav.querySelectorAll("a[data-nav]").forEach(a=>a.classList.toggle("active", a.dataset.nav===state.ui.view));
}

/** Ensure today exists for a client */
function ensureClientToday(client){
  const t = todayISO();
  client.daily = client.daily || {};
  if (!client.daily[t]) {
    client.daily[t] = {
      steps: rand(6500, 11000),
      sleepHrs: rand(6,8),
      rhr: rand(52,62),
      stressAvg: rand(20,40),
      bodyBatteryStart: rand(70,95),
      bodyBatteryEnd: rand(20,55),
      activeCals: rand(300,800),
      workoutDone: false,
      workoutMins: 0,
      nutritionCompliancePct: 75,
      bodyWeightKg: "",
      waistCm: "",
      dayNote: "",
      selfReport:{ soreness: 4, mood: 7, energy: 7, digestion: 6 }
    };
  }
}

/** Flags + aggregates */
function flagRow(day){
  const flags = [];
  if (!day) return flags;
  if (day.sleepHrs !== undefined && Number(day.sleepHrs) <= 6) flags.push("Low sleep");
  if (day.stressAvg !== undefined && Number(day.stressAvg) >= 38) flags.push("High stress");
  if (day.steps !== undefined && Number(day.steps) <= 7000) flags.push("Low steps");
  if (day.workoutDone === false) flags.push("Missed workout");
  if (day.nutritionCompliancePct !== undefined && Number(day.nutritionCompliancePct) < 70) flags.push("Low nutrition");
  return flags;
}
function compute7d(client){
  const t = todayISO();
  const days = [];
  for (let i=0;i<7;i++){
    const d = addDays(t, -i);
    days.push({ date:d, ...(client.daily[d] || {}) });
  }
  const avg = (k)=> Math.round(days.reduce((s,x)=>s+(x?.[k] ? Number(x[k]) : 0),0)/days.length);
  const avgFloat = (k)=> {
    const vals = days.map(x => x?.[k]).filter(v => v!==undefined && v!==null && v!=="").map(Number);
    if (!vals.length) return null;
    return (vals.reduce((a,b)=>a+b,0)/vals.length);
  };
  return {
    avgSleep: avg("sleepHrs"),
    avgSteps: avg("steps"),
    avgStress: avg("stressAvg"),
    avgRHR: avg("rhr"),
    avgCompliance: avg("nutritionCompliancePct"),
    avgWeight: avgFloat("bodyWeightKg"),
    avgWaist: avgFloat("waistCm"),
    workouts: days.reduce((s,x)=>s+(x?.workoutDone?1:0),0),
    days
  };
}

/** Export / Backup */
function downloadText(filename, text){
  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([text], {type:"text/plain"}));
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
}
function exportTodayCSV(state){
  const t = todayISO();
  const header = [
    "date","client","sleepHrs","rhr","stressAvg","bodyBatteryStart","bodyBatteryEnd","steps",
    "workoutDone","workoutMins","kcalTarget","protein","carbs","fat",
    "nutritionCompliancePct","bodyWeightKg","waistCm","dayNote",
    "soreness","mood","energy","digestion","flags"
  ];
  const rows = [header.join(",")];

  state.clients.forEach(c=>{
    ensureClientToday(c);
    const d = c.daily[t];
    const trg = c.macroTargets?.training || {kcal:"",p:"",c:"",f:""};
    const flags = flagRow(d).join("|");
    const line = [
      t,
      `"${c.name.replaceAll('"','""')}"`,
      d.sleepHrs, d.rhr, d.stressAvg, d.bodyBatteryStart, d.bodyBatteryEnd, d.steps,
      d.workoutDone ? "Yes":"No",
      d.workoutMins,
      trg.kcal, trg.p, trg.c, trg.f,
      d.nutritionCompliancePct,
      d.bodyWeightKg ?? "",
      d.waistCm ?? "",
      `"${(d.dayNote||"").replaceAll('"','""')}"`,
      d.selfReport?.soreness ?? "",
      d.selfReport?.mood ?? "",
      d.selfReport?.energy ?? "",
      d.selfReport?.digestion ?? "",
      `"${flags.replaceAll('"','""')}"`
    ];
    rows.push(line.join(","));
  });

  downloadText(`coachfit-today-${t}.csv`, rows.join("\n"));
}
function exportAllCSV(state){
  const header = [
    "date","clientId","client","sleepHrs","rhr","stressAvg","steps","workoutDone","workoutMins",
    "nutritionCompliancePct","bodyWeightKg","waistCm","dayNote","soreness","mood","energy","digestion"
  ];
  const rows = [header.join(",")];
  state.clients.forEach(c=>{
    Object.keys(c.daily || {}).sort().forEach(date=>{
      const d = c.daily[date];
      rows.push([
        date,
        c.id,
        `"${c.name.replaceAll('"','""')}"`,
        d.sleepHrs ?? "", d.rhr ?? "", d.stressAvg ?? "", d.steps ?? "",
        d.workoutDone ? "Yes":"No",
        d.workoutMins ?? "",
        d.nutritionCompliancePct ?? "",
        d.bodyWeightKg ?? "",
        d.waistCm ?? "",
        `"${(d.dayNote||"").replaceAll('"','""')}"`,
        d.selfReport?.soreness ?? "",
        d.selfReport?.mood ?? "",
        d.selfReport?.energy ?? "",
        d.selfReport?.digestion ?? ""
      ].join(","));
    });
  });
  downloadText(`coachfit-all-data-${todayISO()}.csv`, rows.join("\n"));
}
function exportBackupJSON(state){
  downloadText(`coachfit-backup-${todayISO()}.json`, JSON.stringify(state, null, 2));
}
function importBackupJSON(file){
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const obj = JSON.parse(reader.result);
      localStorage.setItem(LS_KEY, JSON.stringify(obj));
      alert("Backup restored. Reloading…");
      location.reload();
    } catch(e){
      alert("Could not import JSON. Make sure it’s a CoachFit backup file.");
    }
  };
  reader.readAsText(file);
}

/** Views */
function viewLogin(state){
  const root = document.getElementById("app");
  root.innerHTML = "";
  root.appendChild(el(`
    <div class="grid">
      <div class="card">
        <h1>CoachFit</h1>
        <p class="muted">Pitch + personal tracking demo. Use demo accounts below.</p>
        <div class="row">
          <span class="tag">coach@demo.com / demo</span>
          <span class="tag">client@demo.com / demo</span>
        </div>
        <label>Email</label>
        <input id="email" placeholder="coach@demo.com" />
        <label>Password</label>
        <input id="pass" type="password" placeholder="demo" />
        <div class="row" style="margin-top:10px;">
          <button class="primary" id="loginBtn">Login</button>
          <button id="resetBtn">Reset demo data</button>
          <button id="gotoLandingBtn">View landing</button>
        </div>
        <p class="muted" style="margin-top:10px;">If anything looks weird after an update, click Reset demo data once.</p>
      </div>

      <div class="card">
        <h2>New tracking features</h2>
        <div class="row">
          <span class="tag">Bodyweight</span>
          <span class="tag">Waist</span>
          <span class="tag">Daily notes</span>
          <span class="tag">Progress screen</span>
          <span class="tag">Backup/restore</span>
          <span class="tag">Alerts-only</span>
          <span class="tag">Notes column</span>
        </div>
      </div>
    </div>
  `));

  root.querySelector("#gotoLandingBtn").onclick = () => { state.ui.view="landing"; save(state); render(); };

  root.querySelector("#loginBtn").onclick = () => {
    const email = root.querySelector("#email").value.trim().toLowerCase();
    const pass = root.querySelector("#pass").value.trim();
    const user = state.users.find(u=>u.email===email && u.pass===pass);
    if (!user) return alert("Invalid demo credentials.");
    state.session = { userId:user.id };
    state.ui.view = user.role==="coach" ? "coach" : "client";
    if (user.role==="client") state.ui.selectedClientId = user.clientId || "c1";
    save(state);
    render();
  };

  root.querySelector("#resetBtn").onclick = () => {
    localStorage.removeItem(LS_KEY);
    render();
  };
}

function viewLanding(state){
  const root = document.getElementById("app");
  root.innerHTML = "";
  root.appendChild(el(`
    <div class="card">
      <h1>High-performance coaching, made scalable</h1>
      <p class="muted">Clients log training + nutrition + recovery daily. Coaches scan a Today table with flags and trends.</p>
      <div class="row">
        <span class="tag">Targets-first nutrition</span>
        <span class="tag">Workout logging</span>
        <span class="tag">Daily check-in</span>
        <span class="tag">Progress tracking</span>
        <span class="tag">Backup/restore</span>
      </div>
      <div class="row" style="margin-top:12px;">
        <button class="primary" id="ctaPricing">See pricing</button>
        <button id="ctaLogin">Login (demo)</button>
      </div>
    </div>
  `));
  root.querySelector("#ctaPricing").onclick = () => { state.ui.view="pricing"; save(state); render(); };
  root.querySelector("#ctaLogin").onclick = () => { state.ui.view="login"; save(state); render(); };
}

function viewPricing(state){
  const root = document.getElementById("app");
  root.innerHTML = "";
  root.appendChild(el(`
    <div class="grid">
      <div class="card">
        <h1>Pricing</h1>
        <p class="muted">Example: setup fee + monthly subscription + per-session in-person.</p>
        <div class="split">
          <div class="card" style="border-radius:12px;margin:0;">
            <h2>Starter</h2>
            <div class="row"><span class="tag">Setup: $199</span><span class="tag">Monthly: $39</span></div>
            <ul class="muted">
              <li>Targets + templates</li>
              <li>Workout logging</li>
              <li>Daily check-ins</li>
              <li>Messaging</li>
            </ul>
          </div>
          <div class="card ok" style="border-radius:12px;margin:0;">
            <h2>Pro</h2>
            <div class="row"><span class="tag">Setup: $399</span><span class="tag">Monthly: $79</span></div>
            <ul class="muted">
              <li>Coach Today + 7-day</li>
              <li>Flags + alerts-only</li>
              <li>Progress tracking</li>
              <li>CSV export</li>
            </ul>
          </div>
        </div>
        <div class="row" style="margin-top:12px;">
          <button class="primary" id="toLogin">Login (demo)</button>
          <button id="toLanding">Back</button>
        </div>
      </div>
      <div class="card">
        <h2>Demo note</h2>
        <div class="muted">This is static/localStorage. Full-stack comes later (real accounts + DB + Garmin + Stripe).</div>
      </div>
    </div>
  `));
  root.querySelector("#toLogin").onclick = () => { state.ui.view="login"; save(state); render(); };
  root.querySelector("#toLanding").onclick = () => { state.ui.view="landing"; save(state); render(); };
}

/** Coach view */
function viewCoach(state){
  const root = document.getElementById("app");
  root.innerHTML = "";

  state.clients.forEach(ensureClientToday);

  const selectedId = state.ui.selectedClientId || state.clients[0]?.id;
  const selected = state.clients.find(c=>c.id===selectedId) || state.clients[0];

  const header = el(`
    <div class="row" style="justify-content:space-between;margin-bottom:12px;">
      <div class="row">
        <span class="tag">Coach</span>
        <span class="tag">Clients: ${state.clients.length}</span>
        <span class="tag">Selected: ${selected ? selected.name : "—"}</span>
      </div>
      <div class="row">
        <label class="row" style="margin:0;gap:6px;">
          <input id="alertsOnly" type="checkbox" style="width:auto;" ${state.ui.coach?.alertsOnly ? "checked":""}>
          <span class="muted">Alerts only</span>
        </label>
        <button class="small" id="csvBtn">Export Today CSV</button>
        <button class="small" id="allCsvBtn">Export All CSV</button>
        <button class="small" id="addClientBtn">Add client</button>
      </div>
    </div>
  `);

  const sidebar = el(`
    <div class="card">
      <h2>Clients</h2>
      <label>Search</label>
      <input id="q" placeholder="Type a name..." />
      <div id="clientList" style="margin-top:10px;display:flex;flex-direction:column;gap:6px;"></div>

      <hr class="hr">
      <h3>Selected client</h3>
      <div class="row">
        <span class="tag" id="selName">${selected?.name || ""}</span>
        <span class="tag">${selected?.profile?.constraints?.join(", ") || "no constraints"}</span>
      </div>

      <label>Nutrition targets (training day)</label>
      <div class="row">
        <input id="kcal" style="max-width:110px" value="${selected.macroTargets.training.kcal}" />
        <input id="p" style="max-width:110px" value="${selected.macroTargets.training.p}" />
        <input id="c" style="max-width:110px" value="${selected.macroTargets.training.c}" />
        <input id="f" style="max-width:110px" value="${selected.macroTargets.training.f}" />
      </div>
      <div class="muted">kcal / P / C / F</div>
      <button class="primary" id="saveTargetsBtn" style="margin-top:10px;">Save targets</button>

      <label style="margin-top:14px;">Assign meal template (optional)</label>
      <select id="tplSel">
        ${state.mealTemplates.map(tpl=>`<option value="${tpl.id}" ${tpl.id===selected.assignedTemplateId?"selected":""}>${tpl.name}</option>`).join("")}
      </select>
      <button id="assignTplBtn" style="margin-top:10px;">Assign template</button>

      <hr class="hr">
      <div class="row">
        <button id="editClientBtn">Edit client</button>
        <button class="danger" id="delClientBtn">Delete</button>
      </div>
      <div class="row" style="margin-top:8px;">
        <button id="toClientBtn">Open client view</button>
        <button id="toProgressBtn">Open progress</button>
        <button id="toMessagesBtn">Open messages</button>
      </div>
    </div>
  `);

  const right = el(`
    <div class="row" style="flex-direction:column;gap:12px;">
      <div class="row" style="justify-content:space-between;">
        <div class="tabs">
          <button class="tab active" data-tab="today">Today</button>
          <button class="tab" data-tab="week">Rolling 7 days</button>
        </div>
        <div class="muted">Click a row to select.</div>
      </div>

      <div class="card" id="todayCard">
        <h2>Today (${todayISO()})</h2>
        <p class="muted">Notes column added + Alerts-only filter.</p>
        <div class="tablewrap">
          <table>
            <thead>
              <tr>
                <th>Client</th>
                <th>Status</th>
                <th>Sleep</th>
                <th>RHR</th>
                <th>Stress</th>
                <th>Steps</th>
                <th>Workout</th>
                <th>Nutrition %</th>
                <th>Weight</th>
                <th>Waist</th>
                <th>Notes</th>
                <th>Flags</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="tbodyToday"></tbody>
          </table>
        </div>
      </div>

      <div class="card" id="weekCard" style="display:none;">
        <h2>Rolling 7 days (${selected.name})</h2>
        <p class="muted">Weekly averages include weight + waist if logged.</p>
        <div id="weekKPIs"></div>
        <div class="tablewrap" style="margin-top:12px;">
          <table>
            <thead>
              <tr>
                <th>Date</th><th>Sleep</th><th>RHR</th><th>Stress</th><th>Steps</th><th>Workout</th><th>Nutrition %</th><th>Weight</th><th>Waist</th><th>Note</th>
              </tr>
            </thead>
            <tbody id="tbodyWeek"></tbody>
          </table>
        </div>
      </div>
    </div>
  `);

  root.appendChild(header);
  const grid = el(`<div class="grid"></div>`);
  grid.appendChild(sidebar);
  grid.appendChild(right);
  root.appendChild(grid);

  // client list
  const list = root.querySelector("#clientList");
  function paintClientList(filter=""){
    list.innerHTML = "";
    const q = filter.trim().toLowerCase();
    state.clients
      .filter(c=>!q || c.name.toLowerCase().includes(q) || c.email.toLowerCase().includes(q))
      .forEach(c=>{
        const isSel = c.id===state.ui.selectedClientId;
        const row = el(`
          <button class="${isSel?'primary':''}" style="text-align:left;">
            <b>${c.name}</b><div class="muted">${c.email}</div>
          </button>
        `);
        row.onclick = () => { state.ui.selectedClientId = c.id; save(state); render(); };
        list.appendChild(row);
      });
  }
  paintClientList();
  root.querySelector("#q").oninput = (e)=>paintClientList(e.target.value);

  // Alerts-only toggle
  root.querySelector("#alertsOnly").onchange = (e) => {
    state.ui.coach = state.ui.coach || {};
    state.ui.coach.alertsOnly = !!e.target.checked;
    save(state);
    render();
  };

  // today table
  const t = todayISO();
  const tbody = root.querySelector("#tbodyToday");
  tbody.innerHTML = "";
  state.clients.forEach(c=>{
    ensureClientToday(c);
    const day = c.daily[t];
    const flags = flagRow(day);
    const needsAttention = flags.length > 0;
    if (state.ui.coach?.alertsOnly && !needsAttention) return;

    const tr = el(`
      <tr style="cursor:pointer;">
        <td><b>${c.name}</b><div class="muted">${c.profile.notes || ""}</div></td>
        <td>${needsAttention ? `<span class="tag attn">Needs attention</span>` : `<span class="tag">OK</span>`}</td>
        <td>${fmt(day.sleepHrs)}h</td>
        <td>${fmt(day.rhr)}</td>
        <td>${fmt(day.stressAvg)}</td>
        <td>${fmt(day.steps)}</td>
        <td>${day.workoutDone ? "Done" : "Not done"} <div class="muted">${day.workoutMins?day.workoutMins+"m":""}</div></td>
        <td>${fmt(day.nutritionCompliancePct)}%</td>
        <td>${fmt(day.bodyWeightKg)}</td>
        <td>${fmt(day.waistCm)}</td>
        <td class="muted">${(day.dayNote || "—").slice(0,60)}</td>
        <td>${flags.length ? flags.map(f=>`<span class="tag">${f}</span>`).join("") : '<span class="tag">OK</span>'}</td>
        <td>
          <div class="row">
            <button class="small" data-sync>Sim sync</button>
            <button class="small" data-msg>Message</button>
          </div>
        </td>
      </tr>
    `);

    tr.onclick = (ev) => {
      if (ev.target && ev.target.closest("button")) return;
      state.ui.selectedClientId = c.id; save(state); render();
    };

    tr.querySelector("[data-sync]").onclick = () => {
      ensureClientToday(c);
      c.daily[t].steps = rand(7000, 14000);
      c.daily[t].sleepHrs = rand(6, 8);
      c.daily[t].rhr = rand(50, 64);
      c.daily[t].stressAvg = rand(18, 42);
      c.daily[t].bodyBatteryStart = rand(70, 96);
      c.daily[t].bodyBatteryEnd = rand(15, 58);
      c.daily[t].activeCals = rand(250, 900);
      save(state);
      alert(`Simulated sync for ${c.name}`);
      render();
    };
    tr.querySelector("[data-msg]").onclick = () => {
      state.ui.selectedClientId = c.id;
      state.ui.view = "messages";
      save(state);
      render();
    };

    tbody.appendChild(tr);
  });

  // week view for selected
  function paintWeek(){
    const sel = state.clients.find(x=>x.id===state.ui.selectedClientId) || state.clients[0];
    ensureClientToday(sel);
    const wk = compute7d(sel);

    const kpi = root.querySelector("#weekKPIs");
    kpi.innerHTML = "";
    kpi.appendChild(el(`
      <div class="kpi">
        <div class="box"><div class="muted">Avg sleep</div><div><b>${wk.avgSleep}</b> h</div></div>
        <div class="box"><div class="muted">Avg steps</div><div><b>${wk.avgSteps}</b></div></div>
        <div class="box"><div class="muted">Avg stress</div><div><b>${wk.avgStress}</b></div></div>
        <div class="box"><div class="muted">Avg RHR</div><div><b>${wk.avgRHR}</b></div></div>
        <div class="box"><div class="muted">Workouts</div><div><b>${wk.workouts}</b>/7</div></div>
        <div class="box"><div class="muted">Nutrition</div><div><b>${wk.avgCompliance}</b>%</div></div>
        <div class="box"><div class="muted">Avg weight</div><div><b>${wk.avgWeight ? wk.avgWeight.toFixed(1) : "—"}</b> kg</div></div>
        <div class="box"><div class="muted">Avg waist</div><div><b>${wk.avgWaist ? wk.avgWaist.toFixed(1) : "—"}</b> cm</div></div>
      </div>
    `));

    const tbodyW = root.querySelector("#tbodyWeek");
    tbodyW.innerHTML = "";
    wk.days.forEach(d=>{
      tbodyW.appendChild(el(`
        <tr>
          <td><b>${d.date}</b></td>
          <td>${fmt(d.sleepHrs)}h</td>
          <td>${fmt(d.rhr)}</td>
          <td>${fmt(d.stressAvg)}</td>
          <td>${fmt(d.steps)}</td>
          <td>${d.workoutDone ? "Done" : "No"}</td>
          <td>${fmt(d.nutritionCompliancePct)}%</td>
          <td>${fmt(d.bodyWeightKg)}</td>
          <td>${fmt(d.waistCm)}</td>
          <td class="muted">${(d.dayNote || "—").slice(0,60)}</td>
        </tr>
      `));
    });
  }
  paintWeek();

  // tabs
  const todayCard = root.querySelector("#todayCard");
  const weekCard = root.querySelector("#weekCard");
  const tabBtns = root.querySelectorAll(".tab");
  tabBtns.forEach(btn=>{
    btn.onclick = () => {
      tabBtns.forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      const which = btn.dataset.tab;
      todayCard.style.display = which==="today" ? "" : "none";
      weekCard.style.display = which==="week" ? "" : "none";
      if (which==="week") paintWeek();
    };
  });

  // coach actions
  root.querySelector("#csvBtn").onclick = () => exportTodayCSV(state);
  root.querySelector("#allCsvBtn").onclick = () => exportAllCSV(state);

  root.querySelector("#saveTargetsBtn").onclick = () => {
    const sel = state.clients.find(x=>x.id===state.ui.selectedClientId) || state.clients[0];
    const kcal = Number(root.querySelector("#kcal").value);
    const p = Number(root.querySelector("#p").value);
    const c = Number(root.querySelector("#c").value);
    const f = Number(root.querySelector("#f").value);
    sel.macroTargets.training = { kcal,p,c,f };
    save(state);
    alert("Saved training-day targets (demo).");
    render();
  };
  root.querySelector("#assignTplBtn").onclick = () => {
    const sel = state.clients.find(x=>x.id===state.ui.selectedClientId) || state.clients[0];
    sel.assignedTemplateId = root.querySelector("#tplSel").value;
    save(state);
    alert("Template assigned (demo).");
    render();
  };

  root.querySelector("#toClientBtn").onclick = () => { state.ui.view = "client"; save(state); render(); };
  root.querySelector("#toProgressBtn").onclick = () => { state.ui.view = "progress"; save(state); render(); };
  root.querySelector("#toMessagesBtn").onclick = () => { state.ui.view = "messages"; save(state); render(); };

  root.querySelector("#addClientBtn").onclick = () => openClientModal(state, {mode:"add"});
  root.querySelector("#editClientBtn").onclick = () => openClientModal(state, {mode:"edit", clientId: state.ui.selectedClientId});
  root.querySelector("#delClientBtn").onclick = () => {
    const sel = state.clients.find(x=>x.id===state.ui.selectedClientId);
    if (!sel) return;
    if (!confirm(`Delete ${sel.name}?`)) return;
    state.clients = state.clients.filter(c=>c.id!==sel.id);
    state.ui.selectedClientId = state.clients[0]?.id || "";
    save(state);
    render();
  };
}

/** Client view (selected client) */
function viewClient(state){
  const root = document.getElementById("app");
  root.innerHTML = "";

  const clientId = state.ui.selectedClientId || "c1";
  const client = state.clients.find(c=>c.id===clientId) || state.clients[0];
  ensureClientToday(client);

  const t = todayISO();
  const day = client.daily[t];

  const top = el(`
    <div class="row" style="justify-content:space-between;margin-bottom:12px;">
      <div class="row">
        <span class="tag">Client</span>
        <span class="tag">${client.name}</span>
        <span class="tag">${t}</span>
      </div>
      <div class="row">
        <button class="small" id="toCoachBtn">Coach</button>
        <button class="small" id="toProgressBtn">Progress</button>
        <button class="small" id="toMsgBtn">Messages</button>
      </div>
    </div>
  `);

  const tpl = state.mealTemplates.find(x=>x.id===client.assignedTemplateId);
  const targets = client.macroTargets.training;

  const left = el(`
    <div class="card">
      <h2>Today’s targets</h2>
      <div class="kpi">
        <div class="box"><div class="muted">Calories</div><div><b>${targets.kcal}</b> kcal</div></div>
        <div class="box"><div class="muted">Protein</div><div><b>${targets.p}</b> g</div></div>
        <div class="box"><div class="muted">Carbs</div><div><b>${targets.c}</b> g</div></div>
        <div class="box"><div class="muted">Fat</div><div><b>${targets.f}</b> g</div></div>
      </div>

      <label style="margin-top:12px;">Nutrition compliance (%)</label>
      <input id="comp" type="number" min="0" max="100" value="${day.nutritionCompliancePct}" />

      <hr class="hr">

      <h3>Body metrics</h3>
      <div class="row">
        <input id="bw" style="max-width:160px" placeholder="Bodyweight (kg)" value="${day.bodyWeightKg ?? ""}" />
        <input id="waist" style="max-width:160px" placeholder="Waist (cm)" value="${day.waistCm ?? ""}" />
      </div>

      <label>Daily note</label>
      <textarea id="dayNote" placeholder="Energy, digestion, stressors, anything notable...">${day.dayNote ?? ""}</textarea>

      <button class="primary" id="saveDailyBtn" style="margin-top:10px;">Save today</button>

      <hr class="hr">

      <h3>Daily check-in (1–10)</h3>
      <div class="row">
        <input id="sore" style="max-width:110px" value="${day.selfReport.soreness}" />
        <input id="mood" style="max-width:110px" value="${day.selfReport.mood}" />
        <input id="ener" style="max-width:110px" value="${day.selfReport.energy}" />
        <input id="dig"  style="max-width:110px" value="${day.selfReport.digestion}" />
      </div>
      <div class="muted">Soreness / Mood / Energy / Digestion</div>
      <button id="saveCheckBtn" style="margin-top:10px;">Save check-in</button>

      <hr class="hr">
      <div class="muted">Constraints: <b>${client.profile.constraints.join(", ") || "—"}</b></div>
    </div>
  `);

  const right = el(`
    <div class="card">
      <h2>Meal template (optional)</h2>
      <p class="muted">${tpl ? tpl.name : "No template assigned yet."}</p>
      <div id="tplArea"></div>

      <hr class="hr">

      <h2>Workout logging</h2>
      <p class="muted">Log sets/reps/weight (demo).</p>
      <div id="wArea"></div>
    </div>
  `);

  root.appendChild(top);
  const grid = el(`<div class="split"></div>`);
  grid.appendChild(left);
  grid.appendChild(right);
  root.appendChild(grid);

  // template
  const tplArea = root.querySelector("#tplArea");
  if (!tpl){
    tplArea.appendChild(el(`<div class="card warn" style="border-radius:12px;"><b>No template</b><div class="muted">You can still follow macro targets.</div></div>`));
  } else {
    tpl.meals.forEach(m=>{
      let kcal=0,p=0,c=0,f=0;
      m.items.forEach(i=>{kcal+=i.kcal;p+=i.p;c+=i.c;f+=i.f;});
      tplArea.appendChild(el(`
        <div class="card" style="border-radius:12px;margin:10px 0;">
          <b>${m.slot}</b>
          <div class="muted">${m.items.map(i=>`${i.food} (${i.kcal}kcal)`).join(" • ")}</div>
          <div class="row" style="margin-top:6px;">
            <span class="tag">${kcal} kcal</span>
            <span class="tag">P ${p}</span>
            <span class="tag">C ${c}</span>
            <span class="tag">F ${f}</span>
          </div>
        </div>
      `));
    });
  }

  // workout logger
  const wArea = root.querySelector("#wArea");
  const plan = state.workoutPlan;
  const dayIdx = (new Date()).getDay();
  const mapped = {1:"Mon",2:"Tue",3:"Wed",4:"Thu",5:"Fri"};
  const dow = mapped[dayIdx] || "Mon";
  const session = plan.find(p=>p.day===dow) || plan[0];

  const logKey = t;
  state.workoutLogs[logKey] = state.workoutLogs[logKey] || {};
  state.workoutLogs[logKey][client.id] = state.workoutLogs[logKey][client.id] || {};
  wArea.appendChild(el(`<div class="tag">Today: ${session.day} • ${session.name}</div>`));

  session.exercises.forEach(ex=>{
    const sets = state.workoutLogs[logKey][client.id][ex] || [{reps:"",weight:""}];
    const block = el(`
      <div class="card" style="border-radius:12px;margin-top:10px;">
        <b>${ex}</b>
        <div class="muted">Sets</div>
        <div class="sets"></div>
        <div class="row" style="margin-top:8px;">
          <button class="small" data-add>Add set</button>
          <button class="small" data-save>Save</button>
        </div>
      </div>
    `);
    const setsDiv = block.querySelector(".sets");

    function renderSets(){
      setsDiv.innerHTML = "";
      sets.forEach((s, idx)=>{
        const line = el(`
          <div class="row" style="margin-top:6px;">
            <span class="tag">#${idx+1}</span>
            <input style="max-width:110px" placeholder="reps" value="${s.reps}">
            <input style="max-width:140px" placeholder="weight" value="${s.weight}">
            <button class="small" data-del>Delete</button>
          </div>
        `);
        line.querySelector("[data-del]").onclick = () => { sets.splice(idx,1); if(!sets.length) sets.push({reps:"",weight:""}); renderSets(); };
        setsDiv.appendChild(line);
      });
    }
    block.querySelector("[data-add]").onclick = () => { sets.push({reps:"",weight:""}); renderSets(); };
    block.querySelector("[data-save]").onclick = () => {
      const rows = setsDiv.querySelectorAll(".row");
      const newSets = [];
      rows.forEach(r=>{
        const inputs = r.querySelectorAll("input");
        newSets.push({ reps: inputs[0].value, weight: inputs[1].value });
      });
      state.workoutLogs[logKey][client.id][ex] = newSets;
      client.daily[t].workoutDone = true;
      client.daily[t].workoutMins = 45;
      save(state);
      alert("Saved workout sets (demo).");
    };
    renderSets();
    wArea.appendChild(block);
  });

  // save today (weight/waist/note + compliance)
  root.querySelector("#saveDailyBtn").onclick = () => {
    client.daily[t].nutritionCompliancePct = Math.max(0, Math.min(100, Number(root.querySelector("#comp").value)));
    client.daily[t].bodyWeightKg = root.querySelector("#bw").value.trim();
    client.daily[t].waistCm = root.querySelector("#waist").value.trim();
    client.daily[t].dayNote = root.querySelector("#dayNote").value.trim();
    save(state);
    alert("Saved today (demo).");
  };

  // save check-in
  root.querySelector("#saveCheckBtn").onclick = () => {
    client.daily[t].selfReport = {
      soreness: Number(root.querySelector("#sore").value),
      mood: Number(root.querySelector("#mood").value),
      energy: Number(root.querySelector("#ener").value),
      digestion: Number(root.querySelector("#dig").value)
    };
    save(state);
    alert("Saved check-in (demo).");
  };

  root.querySelector("#toCoachBtn").onclick = () => { state.ui.view = "coach"; save(state); render(); };
  root.querySelector("#toProgressBtn").onclick = () => { state.ui.view = "progress"; save(state); render(); };
  root.querySelector("#toMsgBtn").onclick = () => { state.ui.view = "messages"; save(state); render(); };
}

/** Progress view (selected client) */
function viewProgress(state){
  const root = document.getElementById("app");
  root.innerHTML = "";

  const clientId = state.ui.selectedClientId || "c1";
  const client = state.clients.find(c=>c.id===clientId) || state.clients[0];
  ensureClientToday(client);

  const t = todayISO();
  const last14 = [];
  for (let i=0;i<14;i++){
    const d = addDays(t, -i);
    last14.push({ date:d, ...(client.daily[d] || {}) });
  }

  const wk = compute7d(client);

  function delta(a,b){
    if (a===null || a===undefined || b===null || b===undefined) return "—";
    const diff = a-b;
    const s = diff>0 ? "+" : "";
    return `${s}${diff.toFixed(1)}`;
  }
  const today = client.daily[t];
  const sevenAgo = client.daily[addDays(t,-7)] || {};

  root.appendChild(el(`
    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div class="row">
          <span class="tag">Progress</span>
          <span class="tag">${client.name}</span>
          <span class="tag">Today: ${t}</span>
        </div>
        <div class="row">
          <button class="small" id="exportJson">Backup JSON</button>
          <button class="small" id="exportAllCsv">Export All CSV</button>
          <label class="row" style="margin:0;gap:6px;">
            <input id="importFile" type="file" accept=".json" style="width:auto;">
            <span class="muted">Restore JSON</span>
          </label>
          <button class="small" id="toCoach">Coach</button>
          <button class="small" id="toClient">Client</button>
        </div>
      </div>

      <hr class="hr">

      <h2>Weekly snapshot</h2>
      <div class="kpi">
        <div class="box"><div class="muted">Avg weight (7d)</div><div><b>${wk.avgWeight ? wk.avgWeight.toFixed(1) : "—"}</b> kg</div></div>
        <div class="box"><div class="muted">Avg waist (7d)</div><div><b>${wk.avgWaist ? wk.avgWaist.toFixed(1) : "—"}</b> cm</div></div>
        <div class="box"><div class="muted">Weight change (7d)</div><div><b>${delta(Number(today?.bodyWeightKg||0)||null, Number(sevenAgo?.bodyWeightKg||0)||null)}</b> kg</div></div>
        <div class="box"><div class="muted">Waist change (7d)</div><div><b>${delta(Number(today?.waistCm||0)||null, Number(sevenAgo?.waistCm||0)||null)}</b> cm</div></div>
        <div class="box"><div class="muted">Avg nutrition</div><div><b>${wk.avgCompliance}</b>%</div></div>
        <div class="box"><div class="muted">Workouts</div><div><b>${wk.workouts}</b>/7</div></div>
      </div>

      <hr class="hr">

      <h2>Last 14 days</h2>
      <div class="tablewrap">
        <table>
          <thead>
            <tr>
              <th>Date</th><th>Weight</th><th>Waist</th><th>Sleep</th><th>Steps</th><th>Nutrition%</th><th>Workout</th><th>Check-in</th><th>Note</th>
            </tr>
          </thead>
          <tbody id="p14"></tbody>
        </table>
      </div>

      <p class="muted" style="margin-top:10px;">
        Tip: Use Backup JSON weekly so you never lose progress if browser storage clears.
      </p>
    </div>
  `));

  const tbody = root.querySelector("#p14");
  last14.forEach(d=>{
    tbody.appendChild(el(`
      <tr>
        <td><b>${d.date}</b></td>
        <td>${fmt(d.bodyWeightKg)}</td>
        <td>${fmt(d.waistCm)}</td>
        <td>${fmt(d.sleepHrs)}h</td>
        <td>${fmt(d.steps)}</td>
        <td>${fmt(d.nutritionCompliancePct)}%</td>
        <td>${d.workoutDone ? "Done":"No"}</td>
        <td class="muted">S:${fmt(d.selfReport?.soreness)} M:${fmt(d.selfReport?.mood)} E:${fmt(d.selfReport?.energy)} D:${fmt(d.selfReport?.digestion)}</td>
        <td class="muted">${(d.dayNote || "—").slice(0,80)}</td>
      </tr>
    `));
  });

  root.querySelector("#exportJson").onclick = () => exportBackupJSON(state);
  root.querySelector("#exportAllCsv").onclick = () => exportAllCSV(state);
  root.querySelector("#importFile").onchange = (e) => {
    const f = e.target.files?.[0];
    if (f) importBackupJSON(f);
  };
  root.querySelector("#toCoach").onclick = () => { state.ui.view="coach"; save(state); render(); };
  root.querySelector("#toClient").onclick = () => { state.ui.view="client"; save(state); render(); };
}

/** Messages (coach ↔ selected client) */
function viewMessages(state){
  const root = document.getElementById("app");
  root.innerHTML = "";

  const clientId = state.ui.selectedClientId || "c1";
  const client = state.clients.find(c=>c.id===clientId) || state.clients[0];

  const header = el(`
    <div class="row" style="justify-content:space-between;margin-bottom:12px;">
      <div class="row">
        <span class="tag">Messages</span>
        <span class="tag">Thread: Coach ↔ ${client.name}</span>
      </div>
      <div class="row">
        <button class="small" id="backBtn">Back</button>
      </div>
    </div>
  `);

  const card = el(`
    <div class="card">
      <div id="msgs" style="display:flex;flex-direction:column;gap:8px;"></div>
      <div class="row" style="margin-top:10px;">
        <input id="msgInput" placeholder="Type a message..." />
        <button class="primary" id="sendBtn">Send</button>
      </div>
    </div>
  `);

  root.appendChild(header);
  root.appendChild(card);

  function renderMsgs(){
    const box = card.querySelector("#msgs");
    box.innerHTML = "";
    state.messages
      .slice()
      .sort((a,b)=>a.at.localeCompare(b.at))
      .filter(m => (m.to===client.id || m.from===client.id))
      .forEach(m=>{
        const from = state.users.find(u=>u.id===m.from) || {name:"Coach/Client"};
        const mine = m.from===state.session.userId;
        box.appendChild(el(`
          <div class="card ${mine?'ok':'warn'}" style="border-radius:12px;margin:0;align-self:${mine?'flex-end':'flex-start'};max-width:78%;">
            <div class="muted" style="font-size:12px;"><b>${from.name}</b> • ${new Date(m.at).toLocaleString()}</div>
            <div>${m.text}</div>
          </div>
        `));
      });
  }
  renderMsgs();

  card.querySelector("#sendBtn").onclick = () => {
    const text = card.querySelector("#msgInput").value.trim();
    if (!text) return;
    state.messages.push({ id:"m"+(state.messages.length+1), from:state.session.userId, to:client.id, at:new Date().toISOString(), text });
    card.querySelector("#msgInput").value = "";
    save(state);
    renderMsgs();
  };

  header.querySelector("#backBtn").onclick = () => { state.ui.view = "coach"; save(state); render(); };
}

/** Client add/edit modal */
function openClientModal(state, {mode, clientId}){
  const existing = mode==="edit" ? state.clients.find(c=>c.id===clientId) : null;

  const overlay = el(`
    <div style="position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;padding:16px;z-index:50;">
      <div class="card" style="max-width:720px;width:100%;">
        <h2>${mode==="add" ? "Add client" : "Edit client"}</h2>
        <div class="split">
          <div>
            <label>Name</label>
            <input id="name" value="${existing?.name || ""}" placeholder="e.g., Luke Abbey" />
            <label>Email</label>
            <input id="email" value="${existing?.email || ""}" placeholder="e.g., luke@example.com" />
            <label>Notes</label>
            <textarea id="notes" placeholder="Goals, injuries, key context...">${existing?.profile?.notes || ""}</textarea>
          </div>
          <div>
            <label>Constraints (comma separated)</label>
            <input id="constraints" value="${(existing?.profile?.constraints || []).join(", ")}" placeholder="e.g., coeliac, dairy_free" />
            <label>Age</label>
            <input id="age" type="number" value="${existing?.profile?.age || 30}" />
            <label>Height (cm)</label>
            <input id="height" type="number" value="${existing?.profile?.heightCm || 170}" />
            <label>Weight (kg)</label>
            <input id="weight" type="number" value="${existing?.profile?.weightKg || 70}" />
          </div>
        </div>
        <div class="row" style="justify-content:flex-end;margin-top:10px;">
          <button id="cancel">Cancel</button>
          <button class="primary" id="save">${mode==="add" ? "Add" : "Save"}</button>
        </div>
      </div>
    </div>
  `);

  overlay.querySelector("#cancel").onclick = () => overlay.remove();
  overlay.querySelector("#save").onclick = () => {
    const name = overlay.querySelector("#name").value.trim();
    const email = overlay.querySelector("#email").value.trim().toLowerCase();
    if (!name || !email) return alert("Name + email required.");
    const notes = overlay.querySelector("#notes").value.trim();
    const constraints = overlay.querySelector("#constraints").value.split(",").map(s=>s.trim()).filter(Boolean);

    const age = Number(overlay.querySelector("#age").value) || 30;
    const heightCm = Number(overlay.querySelector("#height").value) || 170;
    const weightKg = Number(overlay.querySelector("#weight").value) || 70;

    if (mode==="add"){
      const newId = "c" + (Math.max(0, ...state.clients.map(c=>Number(c.id.slice(1))||0)) + 1);
      const c = seedClient(newId, name, email, notes, constraints);
      c.profile.age = age; c.profile.heightCm = heightCm; c.profile.weightKg = weightKg;
      state.clients.push(c);
      state.ui.selectedClientId = c.id;
    } else {
      existing.name = name;
      existing.email = email;
      existing.profile.notes = notes;
      existing.profile.constraints = constraints;
      existing.profile.age = age;
      existing.profile.heightCm = heightCm;
      existing.profile.weightKg = weightKg;
    }

    save(state);
    overlay.remove();
    render();
  };

  document.body.appendChild(overlay);
}

/** Router */
function render(){
  setEnvPill();
  const state = load();
  state.ui = state.ui || { view:"landing", selectedClientId: state.clients?.[0]?.id || "", coach:{alertsOnly:false} };

  if (state.clients?.length && (!state.ui.selectedClientId || !state.clients.find(c=>c.id===state.ui.selectedClientId))){
    state.ui.selectedClientId = state.clients[0].id;
    save(state);
  }

  setHeaderSession(state);
  if (state.session) wireTopNav(state);

  if (!state.session){
    if (state.ui.view==="landing") return viewLanding(state);
    if (state.ui.view==="pricing") return viewPricing(state);
    state.ui.view="login"; save(state);
    return viewLogin(state);
  }

  const user = state.users.find(u=>u.id===state.session.userId);

  if (state.ui.view==="landing") return viewLanding(state);
  if (state.ui.view==="pricing") return viewPricing(state);
  if (state.ui.view==="messages") return viewMessages(state);
  if (state.ui.view==="progress") return viewProgress(state);

  if (user.role==="coach"){
    if (state.ui.view==="client") return viewClient(state);
    state.ui.view="coach"; save(state);
    return viewCoach(state);
  }

  // client role
  state.ui.selectedClientId = user.clientId || "c1";
  state.ui.view = "client";
  save(state);
  return viewClient(state);
}

// logout
document.getElementById("logoutBtn").onclick = () => {
  const state = load();
  state.session = null;
  state.ui.view = "landing";
  save(state);
  render();
};

render();
</script>
</body>
</html>
