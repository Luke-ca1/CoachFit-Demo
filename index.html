<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>CoachFit â€“ Diet Templates</title>
<style>
  body { font-family: system-ui; background:#f6f7fb; padding:20px; }
  .card { background:#fff; padding:16px; border-radius:12px; margin-bottom:16px; }
  .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  input, button, select { padding:6px 8px; }
  button { cursor:pointer; }
  h2, h3 { margin:6px 0; }
  .meal { border:1px solid #ddd; padding:10px; border-radius:10px; margin-top:10px; }
  .food { display:flex; gap:6px; margin-top:6px; }
</style>
</head>

<body>

<h2>Diet Templates</h2>

<div class="card">
  <button onclick="newTemplate()">âž• New Template</button>
</div>

<div id="templates"></div>

<script>
/* ------------------ STATE ------------------ */
const KEY = "coachfit_diet_state";

function loadState() {
  try {
    const raw = JSON.parse(localStorage.getItem(KEY));
    if (!raw || typeof raw !== "object") throw 0;
    if (!Array.isArray(raw.templates)) raw.templates = [];
    return raw;
  } catch {
    const seed = { templates: [] };
    localStorage.setItem(KEY, JSON.stringify(seed));
    return seed;
  }
}

function saveState(state) {
  localStorage.setItem(KEY, JSON.stringify(state));
}

let state = loadState();

/* ------------------ UI ------------------ */
function render() {
  const root = document.getElementById("templates");
  root.innerHTML = "";

  state.templates.forEach((t, idx) => {
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <b>${t.name}</b><br>
      kcal: ${t.kcal} | P ${t.p} / C ${t.c} / F ${t.f}<br>
      <button onclick="editTemplate(${idx})">Edit</button>
      <button onclick="deleteTemplate(${idx})">Delete</button>
    `;
    root.appendChild(div);
  });
}

/* ------------------ TEMPLATE CRUD ------------------ */
function newTemplate() {
  state.templates.push({
    name: "New Diet",
    meals: [],
    kcal: 0, p: 0, c: 0, f: 0
  });
  saveState(state);
  render();
  editTemplate(state.templates.length - 1);
}

function deleteTemplate(i) {
  state.templates.splice(i,1);
  saveState(state);
  render();
}

/* ------------------ EDITOR ------------------ */
function editTemplate(i) {
  const t = state.templates[i];
  document.body.innerHTML = `
    <h2>Edit Diet Template</h2>

    <div class="card">
      Name: <input id="name" value="${t.name}">
      <button onclick="addMeal(${i})">âž• Add Meal</button>
      <button onclick="autoCalc(${i})">âš¡ Auto-Calc</button>
      <button onclick="saveAndExit(${i})">ðŸ’¾ Save</button>
    </div>

    <div id="meals"></div>
  `;
  renderMeals(i);
}

function saveAndExit(i) {
  state.templates[i].name = document.getElementById("name").value;
  saveState(state);
  location.reload();
}

/* ------------------ MEALS ------------------ */
function addMeal(i) {
  state.templates[i].meals.push({ name:"Meal", foods:[] });
  saveState(state);
  renderMeals(i);
}

function renderMeals(i) {
  const root = document.getElementById("meals");
  root.innerHTML = "";

  state.templates[i].meals.forEach((m, mi) => {
    const div = document.createElement("div");
    div.className = "meal";
    div.innerHTML = `
      Meal: <input value="${m.name}" onchange="renameMeal(${i},${mi},this.value)">
      <button onclick="addFood(${i},${mi})">âž• Food</button>
      <div id="foods-${mi}"></div>
    `;
    root.appendChild(div);

    const foods = div.querySelector(`#foods-${mi}`);
    m.foods.forEach((f, fi) => {
      const row = document.createElement("div");
      row.className = "food";
      row.innerHTML = `
        <input placeholder="Food" value="${f.name}" onchange="upd(${i},${mi},${fi},'name',this.value)">
        <input placeholder="kcal" type="number" value="${f.kcal}" onchange="upd(${i},${mi},${fi},'kcal',this.value)">
        <input placeholder="P" type="number" value="${f.p}" onchange="upd(${i},${mi},${fi},'p',this.value)">
        <input placeholder="C" type="number" value="${f.c}" onchange="upd(${i},${mi},${fi},'c',this.value)">
        <input placeholder="F" type="number" value="${f.f}" onchange="upd(${i},${mi},${fi},'f',this.value)">
      `;
      foods.appendChild(row);
    });
  });
}

function renameMeal(i, mi, v) {
  state.templates[i].meals[mi].name = v;
  saveState(state);
}

function addFood(i, mi) {
  state.templates[i].meals[mi].foods.push({name:"",kcal:0,p:0,c:0,f:0});
  saveState(state);
  renderMeals(i);
}

function upd(i,mi,fi,k,v) {
  state.templates[i].meals[mi].foods[fi][k] = Number(v)||v;
  saveState(state);
}

/* ------------------ AUTO CALC ------------------ */
function autoCalc(i) {
  let kcal=0,p=0,c=0,f=0;
  state.templates[i].meals.forEach(m=>{
    m.foods.forEach(x=>{
      kcal+=x.kcal||0;
      p+=x.p||0; c+=x.c||0; f+=x.f||0;
    });
  });
  Object.assign(state.templates[i],{kcal,p,c,f});
  saveState(state);
  alert("Totals updated");
}

render();
</script>
</body>
</html>
