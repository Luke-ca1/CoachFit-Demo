<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CoachFit Demo (Pitch + Tracking + PRs + History)</title>
  <style>
    :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f6f7fb;color:#111;line-height:1.35}
    body{margin:0}
    header{background:#fff;border-bottom:1px solid #e6e8ef;position:sticky;top:0;z-index:10}
    .bar{max-width:1120px;margin:0 auto;padding:12px 16px;display:flex;justify-content:space-between;align-items:center;gap:12px}
    .brand{font-weight:900;letter-spacing:.2px}
    .pill{font-size:12px;padding:2px 8px;border:1px solid #e6e8ef;border-radius:999px;background:#fafbff}
    main{max-width:1120px;margin:0 auto;padding:16px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:980px){.grid{grid-template-columns:360px 1fr}}
    .card{background:#fff;border:1px solid #e6e8ef;border-radius:14px;padding:14px;box-shadow:0 2px 10px rgba(0,0,0,.04)}
    h1,h2,h3{margin:0 0 10px 0}
    h1{font-size:24px}
    h2{font-size:18px}
    h3{font-size:14px;color:#333}
    label{display:block;font-size:12px;color:#444;margin-top:8px}
    input,select,textarea{width:100%;padding:9px 10px;border:1px solid #d9dbe3;border-radius:10px;background:#fff;font-size:14px}
    textarea{min-height:72px}
    button{padding:10px 12px;border:1px solid #d9dbe3;border-radius:12px;background:#fff;cursor:pointer}
    button.primary{background:#111;color:#fff;border-color:#111}
    button.small{padding:6px 10px;border-radius:10px;font-size:12px}
    button.danger{background:#fff0f0;border-color:#ffc2c2}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:8px 10px;border-radius:999px;border:1px solid #e6e8ef;background:#fff;cursor:pointer;font-size:13px}
    .tab.active{background:#111;color:#fff;border-color:#111}
    .muted{color:#666;font-size:13px}
    .tablewrap{overflow:auto;border:1px solid #e6e8ef;border-radius:12px}
    table{border-collapse:collapse;width:100%;min-width:1200px;background:#fff}
    th,td{padding:10px;border-bottom:1px solid #eef0f6;text-align:left;font-size:13px;vertical-align:top}
    th{font-size:12px;color:#555;background:#fafbff;position:sticky;top:0}
    .kpi{display:flex;gap:10px;flex-wrap:wrap}
    .kpi .box{border:1px solid #e6e8ef;border-radius:12px;padding:10px;background:#fafbff}
    .tag{display:inline-block;font-size:11px;padding:2px 8px;border:1px solid #e6e8ef;border-radius:999px;background:#fff;margin:2px 4px 0 0}
    .tag.attn{background:#fff8e6;border-color:#ffe2a3}
    .split{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:980px){.split{grid-template-columns:1fr 1fr}}
    .warn{background:#fff8e6;border:1px solid #ffe2a3}
    .ok{background:#eefbf1;border:1px solid #bfe9c8}
    .nav{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .nav a{font-size:13px;color:#111;text-decoration:none;padding:8px 10px;border-radius:999px;border:1px solid #e6e8ef;background:#fff}
    .nav a.active{background:#111;color:#fff;border-color:#111}
    .hr{border:none;border-top:1px solid #eef0f6;margin:14px 0}
    .hint{font-size:12px;color:#666;margin-top:6px}
  
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
@media (max-width:900px){.grid2{grid-template-columns:1fr}}
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="row">
      <div class="brand">CoachFit</div>
      <span class="pill">Pitch + Tracking Demo</span>
      <span class="pill" id="envPill">local</span>
    </div>

    <div class="nav" id="topNav" style="display:none;">
      <a href="#" data-nav="landing">Landing</a>
      <a href="#" data-nav="pricing">Pricing</a>
      <a href="#" data-nav="coach">Coach</a>
      <a href="#" data-nav="client">Client</a>
      <a href="#" data-nav="progress">Progress</a>
      <a href="#" data-nav="history">History</a>
      <a href="#" data-nav="messages">Messages</a>
      <a href="#" data-nav="diet">Diet</a>
    </div>

    <div class="row">
      <span class="muted" id="whoami"></span>
      <button class="small" id="logoutBtn" style="display:none;">Log out</button>
    </div>
  </div>
</header>

<main>
  <div id="app"></div>
</main>

<script>

// ---- guard: ensure helpers exist even if older cached code paths reference them ----
if (typeof window.isoDate !== "function") {
  window.isoDate = function(d){
    const pad = (n)=> String(n).padStart(2,"0");
    return d.getFullYear()+"-"+pad(d.getMonth()+1)+"-"+pad(d.getDate());
  };
}
if (typeof window.last7CompletionCount !== "function") {
  window.last7CompletionCount = function(client){
    const cs = (client && client.completedSessions) ? client.completedSessions : {};
    let n = 0;
    const d = new Date();
    for (let i=0;i<7;i++){
      const dd = new Date(d); dd.setDate(d.getDate()-i);
      const key = window.isoDate(dd);
      if (cs[key]) n++;
    }
    return n;
  };
}

if (typeof window.esc !== "function") {
  window.esc = function(s){
    return String(s==null?"":s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  };
}


const FOOD_LIBRARY = [
  {name:"Chicken breast (100g)", category:"Protein", kcal:165, p:31, c:0, f:3.6},
  {name:"Lean beef mince (100g)", category:"Protein", kcal:170, p:26, c:0, f:7},
  {name:"Salmon (100g)", category:"Protein", kcal:208, p:20, c:0, f:13},
  {name:"Egg (1 large)", category:"Protein", kcal:72, p:6, c:0.4, f:5},
  {name:"Greek yogurt 0% (200g)", category:"Protein", kcal:118, p:20, c:7, f:0},
  {name:"Whey protein (1 scoop)", category:"Protein", kcal:120, p:24, c:3, f:2},
  {name:"Oats (50g)", category:"Carb", kcal:194, p:8, c:33, f:3.5},
  {name:"Rice cooked (150g)", category:"Carb", kcal:195, p:4, c:43, f:0.4},
  {name:"Potato (250g)", category:"Carb", kcal:215, p:6, c:49, f:0},
  {name:"Banana (1 medium)", category:"Carb", kcal:105, p:1.3, c:27, f:0.4},
  {name:"Olive oil (1 tbsp)", category:"Fat", kcal:119, p:0, c:0, f:13.5},
  {name:"Avocado (100g)", category:"Fat", kcal:160, p:2, c:9, f:15},
  {name:"Almonds (30g)", category:"Fat", kcal:174, p:6, c:6, f:15},
  {name:"Broccoli (150g)", category:"Veg", kcal:50, p:4, c:10, f:0.6},

  {name:"Pasta cooked (180g)", category:"Carb", kcal:270, p:10, c:54, f:2},
  {name:"White bread (2 slices)", category:"Carb", kcal:160, p:6, c:28, f:2},
  {name:"Peanut butter (1 tbsp)", category:"Fat", kcal:95, p:4, c:3, f:8},
  {name:"Cheddar cheese (30g)", category:"Fat", kcal:120, p:7, c:0.5, f:10},
  {name:"Apple (1 medium)", category:"Carb", kcal:95, p:0.5, c:25, f:0.3},

];

function findFoodByName(name){
  const key = String(name||"").trim().toLowerCase();
  if (!key) return null;
  return FOOD_LIBRARY.find(f => f.name.toLowerCase() === key) || null;
}

function getFoodLibrary(state){
  const base = Array.isArray(FOOD_LIBRARY) ? FOOD_LIBRARY : [];
  const custom = Array.isArray(state?.customFoods) ? state.customFoods : [];
  // Custom foods override base if same name
  const map = new Map();
  base.forEach(f=> map.set(String(f.name).toLowerCase(), f));
  custom.forEach(f=> map.set(String(f.name).toLowerCase(), f));
  return Array.from(map.values());
}
function addCustomFood(state, food){
  state.customFoods = Array.isArray(state.customFoods) ? state.customFoods : [];
  const key = String(food?.name||"").trim();
  if (!key) return false;
  const clean = {
    name: key,
    category: (food.category||"General"),
    kcal: Number(food.kcal)||0,
    p: Number(food.p)||0,
    c: Number(food.c)||0,
    f: Number(food.f)||0
  };
  // remove existing with same name (case-insensitive)
  state.customFoods = state.customFoods.filter(x=>String(x.name).toLowerCase() !== key.toLowerCase());
  state.customFoods.unshift(clean);
  return true;
}
function removeCustomFood(state, name){
  if (!Array.isArray(state.customFoods)) return;
  const key = String(name||"").toLowerCase();
  state.customFoods = state.customFoods.filter(x=>String(x.name).toLowerCase() !== key);
}




  function renderCustomFoodsList(){
    const mount = overlay.querySelector('#customFoodsList');
    if (!mount) return;
    const custom = Array.isArray(state.customFoods) ? state.customFoods : [];
    if (!custom.length){
      mount.innerHTML = '<div class="hint">No custom foods yet.</div>';
      return;
    }
    mount.innerHTML = `
      <hr class="hr">
      <b>‚≠ê Your custom foods</b>
      <div class="hint" style="margin-top:6px;">These are saved in your browser (localStorage) for quick reuse.</div>
      ${custom.slice(0,10).map((f,i)=>`
        <div class="row" style="justify-content:space-between;gap:10px;align-items:center;margin-top:8px;">
          <div style="flex:1;">
            <b>${esc(f.name)}</b>
            <div class="hint">${esc(f.category||"General")} ‚Ä¢ ${esc(f.kcal)} kcal ‚Ä¢ P ${esc(f.p)} / C ${esc(f.c)} / F ${esc(f.f)}</div>
          </div>
          <div class="row" style="gap:8px;">
            <button class="small" data-add-custom="${i}">Add</button>
            <button class="small" data-edit-custom="${i}">Edit</button>
            <button class="small" data-del-custom="${i}">Delete</button>
          </div>
        </div>
      `).join("")}
    `;

    mount.querySelectorAll('[data-add-custom]').forEach(btn=>{
      btn.onclick = ()=>{
        const i = Number(btn.getAttribute('data-add-custom'));
        const item = custom[i];
        if (!item) return;
        const target = Number(overlay.querySelector('#foodMealTarget')?.value || 0);
        working.meals = working.meals || [];
        if (!working.meals.length) working.meals.push({slot:"Meal 1", items:[]});
        const mi = isFinite(target) ? Math.min(Math.max(target,0), working.meals.length-1) : 0;
        working.meals[mi].items = working.meals[mi].items || [];
        working.meals[mi].items.push({food:item.name, kcal:item.kcal, p:item.p, c:item.c, f:item.f});
        renderMealsUI(working.meals);
        refreshMealTargetOptions();
        renderFoodLibrary();
        syncJsonFromWorking(true);
      };
    });


    mount.querySelectorAll('[data-edit-custom]').forEach(btn=>{
      btn.onclick = ()=>{
        const i = Number(btn.getAttribute('data-edit-custom'));
        const item = custom[i];
        if (!item) return;
        openCustomFoodModal(state, item);
      };
    });

    mount.querySelectorAll('[data-del-custom]').forEach(btn=>{
      btn.onclick = ()=>{
        const i = Number(btn.getAttribute('data-del-custom'));
        const item = custom[i];
        if (!item) return;
        if (!confirm(`Delete custom food: ${item.name}?`)) return;
        removeCustomFood(state, item.name);
        save(state);
        renderFoodLibrary();
        renderCustomFoodsList();
        // refresh datalist too
        const dl = document.getElementById("foodLibList");
        if (dl) dl.innerHTML = getFoodLibrary(state).map(f=>`<option value="${esc(f.name)}"></option>`).join("");
      };
    });
  }

  // ----------------------------------------------

  // ----- Food library quick add -----
  function refreshMealTargetOptions(){
    const sel = overlay.querySelector('#foodMealTarget');
    if (!sel) return;
    const meals = working.meals || [];
    const opts = meals.map((m,i)=>{
      const label = (m.slot && m.slot.trim()) ? m.slot.trim() : ("Meal " + (i+1));
      return `<option value="${i}">Add to: ${esc(label)}</option>`;
    }).join("");
    sel.innerHTML = opts || '<option value="0">Add to: first meal</option>';
  }

  function renderFoodLibrary(){
    const results = overlay.querySelector('#foodResults');
    const q = (overlay.querySelector('#foodSearch')?.value || "").trim().toLowerCase();
    const cat = overlay.querySelector('#foodCat')?.value || "All";
    const target = Number(overlay.querySelector('#foodMealTarget')?.value || 0);

    if (!results) return;
    const lib = getFoodLibrary(state);
    const filtered = lib.filter(f=>{
      const inCat = (cat==="All") ? true : (f.category===cat);
      const inQ = !q ? true : (f.name.toLowerCase().includes(q));
      return inCat && inQ;
    }).slice(0, 12);

    results.innerHTML = filtered.map((f, idx)=>`
      <div class="row" style="justify-content:space-between;gap:10px;align-items:center;margin-top:8px;">
        <div style="flex:1;">
          <b>${esc(f.name)}</b>
          <div class="hint">${esc(f.category)} ‚Ä¢ ${esc(f.kcal)} kcal ‚Ä¢ P ${esc(f.p)} / C ${esc(f.c)} / F ${esc(f.f)}</div>
        </div>
        <button class="small" data-quickadd="${idx}">Add</button>
      </div>
    `).join("") || '<div class="hint">No matches. Try another search.</div>';

    results.querySelectorAll('[data-quickadd]').forEach(btn=>{
      btn.onclick = ()=>{
        const idx = Number(btn.getAttribute('data-quickadd'));
        const item = filtered[idx];
        if (!item) return;

        working.meals = working.meals || [];
        if (!working.meals.length){
          working.meals.push({slot:"Meal 1", items:[]});
        }
        const mi = isFinite(target) ? Math.min(Math.max(target,0), working.meals.length-1) : 0;
        working.meals[mi].items = working.meals[mi].items || [];
        working.meals[mi].items.push({food:item.name, kcal:item.kcal, p:item.p, c:item.c, f:item.f});

        renderMealsUI(working.meals);
        refreshMealTargetOptions();
        renderFoodLibrary();
        syncJsonFromWorking(true);
      };
    });
  }
  // ----------------------------------
/** ========= Basics ========= */
const LS_KEY = "coachfit_demo_pitch_v6_genetics"; // changed -> reset recommended
const todayISO = () => new Date().toISOString().slice(0,10);
const addDays = (iso, delta) => {
  const d = new Date(iso + "T00:00:00");
  d.setDate(d.getDate() + delta);
  return d.toISOString().slice(0,10);
};
const fmt = (n) => (n === null || n === undefined || n === "" ? "‚Äî" : n);
const rand = (min,max)=>Math.round(min + Math.random()*(max-min));

function el(html){
  const t = document.createElement("template");
  t.innerHTML = html.trim();
  return t.content.firstChild;
}
function setEnvPill(){
  const host = location.host || "";
  document.getElementById("envPill").textContent = host.includes("vercel") || host.includes("netlify") ? "deployed" : "local";
}
function load() {
  const raw = localStorage.getItem(LS_KEY);
  if (raw) return JSON.parse(raw);
  const seed = seedData();
  localStorage.setItem(LS_KEY, JSON.stringify(seed));
  return seed;
}

function migrateState(state){
  // Ensure workout templates exist even for older localStorage saves
  if (!state.workoutTemplates || !Array.isArray(state.workoutTemplates) || state.workoutTemplates.length < 6) {
    state.workoutTemplates = [
    {id:"w_up_a", name:"Upper A", focus:"upper", exercises:["Bench Press","Pull-up / Lat Pulldown","DB Shoulder Press","Seated Row","Lateral Raise","Triceps Pushdown","Biceps Curl"]},
    {id:"w_up_b", name:"Upper B", focus:"upper", exercises:["Incline DB Press","Barbell Row","Push-up / Dip","Chest-Supported Row","Face Pull","Overhead Triceps Extension","Hammer Curl"]},
    {id:"w_back", name:"Back", focus:"back", exercises:["Deadlift / Trap Bar Deadlift","Pull-up / Lat Pulldown","Single-Arm DB Row","Seated Row","Back Extension","Face Pull","Farmer Carry"]},
    {id:"w_chest", name:"Chest", focus:"chest", exercises:["Bench Press","Incline Press","DB Fly / Cable Fly","Dip / Push-up","Chest Press Machine","Lateral Raise","Triceps Pushdown"]},
    {id:"w_leg_a", name:"Legs A", focus:"legs", exercises:["Back Squat","Romanian Deadlift (RDL)","Leg Press","Walking Lunge","Leg Curl","Calf Raise","Core: Plank"]},
    {id:"w_leg_b", name:"Legs B", focus:"legs", exercises:["Front Squat / Goblet Squat","Hip Thrust","Split Squat","Leg Extension","Hamstring Curl","Calf Raise","Core: Hanging Knee Raise"]}
  ];
  }
  // Ensure weekly schedule exists
  if (!state.weeklySchedule) {
    state.weeklySchedule = {
    mon:"w_up_a",
    tue:"w_leg_a",
    wed:"w_back",
    thu:"w_up_b",
    fri:"w_chest",
    sat:"w_leg_b",
    sun:"rest"
  };
  }
  // Ensure UI fields exist
  state.ui = state.ui || {};
  if (!state.ui.selectedWorkoutTemplateId) state.ui.selectedWorkoutTemplateId = "w_up_a";
  
  // Ensure each client has genetics structure
  if (Array.isArray(state.clients)) {
    state.clients.forEach(c=>{
      c.genetics = c.genetics || {};
      c.genetics.performance = c.genetics.performance || {};
      c.genetics.nutrition = c.genetics.nutrition || {};
      c.resolvedWarnings = c.resolvedWarnings || [];
      c.completedSessions = c.completedSessions || {};
    });
  }
  if (!Array.isArray(state.customFoods)) state.customFoods = [];
return state;
}

function save(state){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

/** ========= Seed ========= */
function seedClient(id, name, email, notes, constraints){
  const t = todayISO();
  const daily = {};
  for (let i=0;i<28;i++){
    const date = addDays(t, -i);
    daily[date] = {
      steps: rand(6500, 12000),
      sleepHrs: rand(6,8),
      rhr: rand(50,64),
      stressAvg: rand(18,42),
      bodyBatteryStart: rand(70,96),
      bodyBatteryEnd: rand(15,58),
      activeCals: rand(250, 900),
      workoutDone: i%2===0,
      workoutMins: i%2===0 ? 45 : 0,
      nutritionCompliancePct: i%3===0 ? 90 : 75,
      bodyWeightKg: (70 + (Math.random()*2-1)).toFixed(1),
      waistCm: (82 + (Math.random()*2-1)).toFixed(1),
      dayNote: "",
      selfReport:{ soreness: rand(2,6), mood: rand(6,9), energy: rand(6,9), digestion: rand(3,8) }
    };
  }
  return {
    completedSessions:{},
    genetics:{
      performance:{fastTwitchBias:'Not assessed',recoverySpeed:'Not assessed',injuryRisk:[],notes:''},
      nutrition:{carbTolerance:'Not assessed',fatTolerance:'Not assessed',proteinRequirement:'Not assessed',caffeineSensitivity:'Not assessed',notes:''}
    },
    id, name, email, role:"client", coachId:"u1",
    profile:{ age:40, sex:"Male", heightCm:172, weightKg:72, constraints: constraints || [], notes: notes || "" },
    macroTargets:{ training:{kcal:2500,p:160,c:260,f:70}, rest:{kcal:2300,p:160,c:200,f:80} },
    assignedTemplateId:"mt1",
    activeDietPlan:null,
    dietPlanHistory:[],
    daily
  };
}

function seedData(){
  const clients = [
    seedClient("c1","Luke (Client)","client@demo.com","Back/knee/hip history; coeliac; gut dysbiosis",["coeliac"]),
    seedClient("c2","Ava (Client)","ava@demo.com","Running focus; sleep inconsistent",["dairy_free"]),
    seedClient("c3","Noah (Client)","noah@demo.com","Strength + body comp; high stress week",[])
  ];

  const users = [
    { id:"u1", name:"Coach (Demo)", email:"coach@demo.com", role:"coach", pass:"demo" },
    // client user points to clientId c1
    { id:"c1u", name:"Luke (Client)", email:"client@demo.com", role:"client", pass:"demo", clientId:"c1" }
  ];

  const dietTemplates = [
    { id:"mt1", name:"GF High-Protein Training Day", tags:["gluten_free","high_protein"], meals:[
      { slot:"Breakfast", items:[{food:"Eggs (2)", kcal:140,p:12,c:1,f:10},{food:"Greek yogurt (200g)",kcal:140,p:20,c:8,f:0}] },
      { slot:"Lunch", items:[{food:"Chicken breast (180g)",kcal:300,p:55,c:0,f:6},{food:"Rice (250g cooked)",kcal:325,p:6,c:70,f:1}] },
      { slot:"Dinner", items:[{food:"Salmon (180g)",kcal:360,p:38,c:0,f:22},{food:"Potato (300g)",kcal:260,p:7,c:60,f:0}] },
      { slot:"Snack", items:[{food:"Whey isolate (1 scoop)",kcal:110,p:25,c:1,f:1}] },
    ]},
    { id:"mt2", name:"Simple Fat-Loss Template", tags:["high_fibre"], meals:[
      { slot:"Breakfast", items:[{food:"Oats (60g)",kcal:230,p:8,c:40,f:4},{food:"Whey (1 scoop)",kcal:110,p:25,c:1,f:1}] },
      { slot:"Lunch", items:[{food:"Lean mince (180g)",kcal:330,p:40,c:0,f:18},{food:"Salad + olive oil",kcal:200,p:2,c:10,f:18}] },
      { slot:"Dinner", items:[{food:"White fish (200g)",kcal:220,p:44,c:0,f:2},{food:"Veg + rice (200g cooked)",kcal:260,p:5,c:55,f:1}] },
      { slot:"Snack", items:[{food:"Fruit + nuts",kcal:220,p:4,c:22,f:12}] },
    ]}
  ];

  const workoutPlan = [
    { day:"Mon", name:"Upper A", exercises:["Bench Press","Row","Incline DB","Lateral Raise"] },
    { day:"Tue", name:"Lower A", exercises:["Squat","RDL","Split Squat","Calf Raise"] },
    { day:"Wed", name:"Upper B", exercises:["OHP","Pull-up","Cable Fly","Curl"] },
    { day:"Thu", name:"Lower B", exercises:["Deadlift","Leg Press","Ham Curl","Core"] },
    { day:"Fri", name:"Full Body", exercises:["Front Squat","DB Bench","Lat Pulldown","Carry"] },
  ];

  // workoutLogs[date][clientId][exercise] = [{reps, weight}, ...]
  const workoutLogs = {};

  // seed a few historical logs so PRs/histories show right away
  const seedLifts = [
    { ex:"Bench Press", sets:[{reps:5,weight:90},{reps:5,weight:90},{reps:4,weight:92.5}] },
    { ex:"Squat", sets:[{reps:5,weight:140},{reps:5,weight:140},{reps:3,weight:150}] },
    { ex:"Deadlift", sets:[{reps:3,weight:180},{reps:3,weight:185},{reps:2,weight:190}] },
    { ex:"OHP", sets:[{reps:6,weight:60},{reps:6,weight:60},{reps:5,weight:62.5}] },
    { ex:"Row", sets:[{reps:8,weight:90},{reps:8,weight:90},{reps:7,weight:95}] },
  ];
  const t = todayISO();
  for (let i=3;i<=18;i+=5){
    const d = addDays(t, -i);
    workoutLogs[d] = workoutLogs[d] || {};
    workoutLogs[d]["c1"] = workoutLogs[d]["c1"] || {};
    seedLifts.forEach(l=>{
      workoutLogs[d]["c1"][l.ex] = l.sets.map(s=>({reps:String(s.reps), weight:String(s.weight)}));
    });
  }

  const messages = [
    { id:"m1", from:"u1", to:"c1", at:new Date().toISOString(), text:"Welcome! Log today‚Äôs workout + quick check-in." }
  ];

  return {
    users, clients, dietTemplates, workoutPlan, workoutLogs, messages,
    session:null,
    ui:{ view:"landing", selectedClientId:"c1", coach:{ alertsOnly:false }, selectedExercise:"Bench Press", scrollTo:null, showResolvedWarnings:false, selectedWorkoutTemplateId:'w_up_a', geneticsEditingClientId:null }
  };
}

/** ========= Session header + nav ========= */
function setHeaderSession(state){
  const who = document.getElementById("whoami");
  const btn = document.getElementById("logoutBtn");
  const nav = document.getElementById("topNav");

  if (!state.session){
    who.textContent="";
    btn.style.display="none";
    nav.style.display="none";
    return;
  }
  const u = state.users.find(x=>x.id===state.session.userId);
  who.textContent = `${u.name} ‚Ä¢ ${u.role}`;
  btn.style.display="";
  nav.style.display="flex";
}
function wireTopNav(state){
  const nav = document.getElementById("topNav");
  nav.querySelectorAll("a[data-nav]").forEach(a=>{
    a.onclick = (e) => {
      e.preventDefault();
      state.ui.view = a.dataset.nav;
      save(state);
      render();
    };
  });
  nav.querySelectorAll("a[data-nav]").forEach(a=>a.classList.toggle("active", a.dataset.nav===state.ui.view));
}

/** ========= Ensure client has today's daily row ========= */
function ensureClientToday(client){
  const t = todayISO();
  client.daily = client.daily || {};
  if (!client.daily[t]) {
    client.daily[t] = {
      steps: rand(6500, 11000),
      sleepHrs: rand(6,8),
      rhr: rand(52,62),
      stressAvg: rand(20,40),
      bodyBatteryStart: rand(70,95),
      bodyBatteryEnd: rand(20,55),
      activeCals: rand(300,800),
      workoutDone: false,
      workoutMins: 0,
      nutritionCompliancePct: 75,
      bodyWeightKg: "",
      waistCm: "",
      dayNote: "",
      selfReport:{ soreness: 4, mood: 7, energy: 7, digestion: 6 }
    };
  }
}

/** ========= Flags + aggregates ========= */
function flagRow(day){
  const flags = [];
  if (!day) return flags;
  if (day.sleepHrs !== undefined && Number(day.sleepHrs) <= 6) flags.push("Low sleep");
  if (day.stressAvg !== undefined && Number(day.stressAvg) >= 38) flags.push("High stress");
  if (day.steps !== undefined && Number(day.steps) <= 7000) flags.push("Low steps");
  if (day.workoutDone === false) flags.push("Missed workout");
  if (day.nutritionCompliancePct !== undefined && Number(day.nutritionCompliancePct) < 70) flags.push("Low nutrition");
  return flags;
}

/** ========= Genetics ‚Üí Program Warnings ========= */
function computeProgramWarnings(state, client){
  const warns = [];
  const g = client?.genetics || {};
  const gp = g.performance || {};
  const gn = g.nutrition || {};

  const targets = client?.macroTargets?.training || {};
  const kcal = Number(targets.kcal);
  const p = Number(targets.p);
  const c = Number(targets.c);
  const f = Number(targets.f);

  const fatPct = (isFinite(kcal) && kcal>0 && isFinite(f)) ? (f*9)/kcal : null;
  const carbPct = (isFinite(kcal) && kcal>0 && isFinite(c)) ? (c*4)/kcal : null;

  const add = (text, action) => {
    // stable-ish id derived from action + text
    const id = "w_" + hashString(action + "|" + text);
    warns.push({ id, text, action });
  };

  if (gn.fatTolerance === "Low" && ( (fatPct!==null && fatPct>0.35) || (isFinite(f) && f>=90) )){
    add("Low fat tolerance but fats are high (consider reducing fat % or grams).", "macros");
  }
  if (gn.carbTolerance === "Low" && ( (carbPct!==null && carbPct>0.55) || (isFinite(c) && c>=300) )){
    add("Low carb tolerance but carbs are high (consider lowering carbs / distributing around training).", "macros");
  }

  const bw = Number(client?.profile?.weightKg);
  const minHighProtein = (isFinite(bw) && bw>0) ? (bw*1.8) : null;
  if (gn.proteinRequirement === "High" && minHighProtein!==null && isFinite(p) && p>0 && p < minHighProtein){
    add(`Protein marked High but target is low for bodyweight (aim ~${Math.round(minHighProtein)}g/day).`, "macros");
  }

  const sched = state?.weeklySchedule || {};
  const sessionsPerWeek = Object.values(sched).filter(x=>x && x!=="rest").length;
  if (gp.recoverySpeed === "Slow" && sessionsPerWeek>=5){
    add("Slow recovery but training frequency is high (consider adding a rest day or lowering volume).", "schedule");
  }

  const risk = (gp.injuryRisk || []).map(x=>String(x).toLowerCase());
  const planText = (state?.workoutTemplates || []).map(p=>`${p.name} ${p.exercises?.join(" ")||""}`).join(" ").toLowerCase();

  if (risk.some(r=>r.includes("knee")) && (planText.includes("squat") || planText.includes("split squat") || planText.includes("leg press"))){
    add("Knee injury risk flagged and plan includes knee-dominant lifts (monitor pain/volume).", "plan");
  }
  if (risk.some(r=>r.includes("achilles")) && (planText.includes("calf") || planText.includes("carry") || planText.includes("run") || planText.includes("jump"))){
    add("Achilles injury risk flagged (be cautious with calf volume, running, and plyometrics).", "plan");
  }
  if (risk.some(r=>r.includes("back")) && (planText.includes("deadlift") || planText.includes("rdl") || planText.includes("good morning"))){
    add("Back injury risk flagged and plan includes hinge work (prioritise technique, manage load).", "plan");
  }

  return warns;
}
function hashString(str){
  let h = 5381;
  for (let i=0;i<str.length;i++){
    h = ((h<<5)+h) + str.charCodeAt(i);
    h = h >>> 0;
  }
  return h.toString(16);
}
function warningsBadgeHTML(n){
  if (!n) return "";
  return `<span class="tag attn">‚ö† ${n} warning${n===1?"":"s"}</span>`;
}




function isoDate(d){
  const pad = (n)=> String(n).padStart(2,"0");
  return d.getFullYear()+"-"+pad(d.getMonth()+1)+"-"+pad(d.getDate());
}

function last7CompletionCount(client){
  const cs = (client && client.completedSessions) ? client.completedSessions : {};
  let n = 0;
  const d = new Date();
  for (let i=0;i<7;i++){
    const dd = new Date(d); dd.setDate(d.getDate()-i);
    const key = isoDate(dd);
    if (cs[key]) n++;
  }
  return n;
}


function getTomorrowRecommendedTemplateId(state){
  const d = new Date();
  d.setDate(d.getDate()+1);
  const k = dayKey(d);
  return (state.weeklySchedule && state.weeklySchedule[k]) ? state.weeklySchedule[k] : "rest";
}
function isCompletedForDate(client, dateStr){
  return !!(client?.completedSessions && client.completedSessions[dateStr]);
}

function dayKey(d){
  const k = ["sun","mon","tue","wed","thu","fri","sat"];
  return k[d.getDay()];
}
function getRecommendedTemplateId(state){
  const k = dayKey(new Date());
  return (state.weeklySchedule && state.weeklySchedule[k]) ? state.weeklySchedule[k] : "rest";
}
function getTemplateById(state, id){
  return (state.workoutTemplates||[]).find(t=>t.id===id) || null;
}

function getSelectedWorkoutTemplate(state){
  const id = state?.ui?.selectedWorkoutTemplateId || "w_up_a";
  return (state.workoutTemplates || []).find(x=>x.id===id) || (state.workoutTemplates||[])[0];
}

function explainWhyThisPlan(state, client){
  const lines = [];
  const g = client.genetics || {};
  const gp = g.performance || {};
  const gn = g.nutrition || {};

  // Nutrition reasoning
  if (gn.carbTolerance === "High") lines.push("Carbohydrates are emphasized because you tend to tolerate carbs well and they support training output.");
  if (gn.carbTolerance === "Low") lines.push("Carbohydrates are moderated because your profile suggests lower carb tolerance.");
  if (gn.fatTolerance === "Low") lines.push("Dietary fats are kept controlled due to lower fat tolerance.");
  if (gn.proteinRequirement === "High") lines.push("Protein intake is set higher to support recovery and muscle maintenance.");

  // Training/recovery reasoning
  if (gp.recoverySpeed === "Slow") lines.push("Training load and recovery are managed carefully due to slower recovery characteristics.");
  if (gp.fastTwitchBias === "High") lines.push("Training includes strength/power emphasis that aligns with your muscle fiber profile.");

  if (!lines.length) lines.push("Your plan is built around your goals, current training status, and ongoing progress.");

  lines.push("These decisions are based on tendencies and trends, not fixed limitations, and will adapt as your progress changes.");
  return lines;
}

function warningsListHTML(state, client){
  const all = computeProgramWarnings(state, client);
  const resolved = new Set(client?.resolvedWarnings || []);
  const showResolved = !!(state?.ui?.showResolvedWarnings);

  const unresolved = all.filter(w=>!resolved.has(w.id));
  const shown = showResolved ? all : unresolved;

  if (!all.length) return `<div class="muted" style="margin-top:8px;">No program warnings detected.</div>`;

  const line = (w) => {
    const isResolved = resolved.has(w.id);
    const label = w.action==="macros" ? "Adjust targets" : w.action==="plan" ? "Review plan" : w.action==="schedule" ? "Adjust schedule" : "Edit genetics";
    return `<div class="muted" style="display:flex;gap:8px;align-items:flex-start;opacity:${isResolved?0.55:1};">
      <label style="display:flex;gap:8px;align-items:flex-start;cursor:pointer;">
        <input type="checkbox" data-warncheck="${w.id}" ${isResolved?"checked":""} style="margin-top:3px;">
        <span><a href="#" data-warnline="${w.action}" data-warnid="${w.id}" style="text-decoration:underline;">${w.text}</a> <span class="hint">(${label})</span></span>
      </label>
    </div>`;
  };

  const headerBadge = warningsBadgeHTML(unresolved.length);
  const resolvedCount = resolved.size;

  return `
    <div style="margin-top:8px;">
      <div class="row" style="margin-bottom:6px;justify-content:space-between;gap:10px;flex-wrap:wrap;">
        <div class="row" style="gap:8px;flex-wrap:wrap;align-items:center;">
          ${headerBadge}
          <span class="hint">${resolvedCount ? `${resolvedCount} resolved` : ""}</span>
        </div>
        <div class="row" style="gap:8px;flex-wrap:wrap;align-items:center;">
          <button class="small" id="resolveAllWarnings">Resolve all</button>
          <button class="small" id="clearResolvedWarnings">Clear resolved</button>
          <label class="hint" style="display:flex;gap:8px;align-items:center;cursor:pointer;">
            <input type="checkbox" id="toggleResolvedWarnings" ${showResolved?"checked":""}>
            Show resolved
          </label>
        </div>
      </div>
      ${(shown.length ? shown.slice(0,10).map(line).join("") : `<div class="muted">All warnings resolved ‚úÖ</div>`)}
      ${shown.length>10 ? `<div class="muted">+ ${shown.length-10} more‚Ä¶</div>` : ""}
    </div>
  `;
}

function compute7d(client){
  const t = todayISO();
  const days = [];
  for (let i=0;i<7;i++){
    const d = addDays(t, -i);
    days.push({ date:d, ...(client.daily[d] || {}) });
  }
  const avg = (k)=> Math.round(days.reduce((s,x)=>s+(x?.[k] ? Number(x[k]) : 0),0)/days.length);
  const avgFloat = (k)=> {
    const vals = days.map(x => x?.[k]).filter(v => v!==undefined && v!==null && v!=="").map(Number);
    if (!vals.length) return null;
    return (vals.reduce((a,b)=>a+b,0)/vals.length);
  };
  return {
    avgSleep: avg("sleepHrs"),
    avgSteps: avg("steps"),
    avgStress: avg("stressAvg"),
    avgRHR: avg("rhr"),
    avgCompliance: avg("nutritionCompliancePct"),
    avgWeight: avgFloat("bodyWeightKg"),
    avgWaist: avgFloat("waistCm"),
    workouts: days.reduce((s,x)=>s+(x?.workoutDone?1:0),0),
    days
  };
}

/** ========= PR tracking + Exercise history ========= */
// e1RM formula: Epley
function e1rmEpley(weight, reps){
  const w = Number(weight);
  const r = Number(reps);
  if (!isFinite(w) || !isFinite(r) || w <= 0 || r <= 0) return null;
  const rc = Math.min(20, r);
  return w * (1 + rc / 30);
}
function parseSetInputs(repsStr, weightStr){
  const reps = Number(String(repsStr ?? "").replace(/[^\d.]/g, ""));
  const weight = Number(String(weightStr ?? "").replace(/[^\d.]/g, ""));
  if (!isFinite(reps) || !isFinite(weight)) return null;
  if (reps <= 0 || weight <= 0) return null;
  return { reps, weight };
}

// PRs: best e1RM per exercise across all dates
function computePRsForClient(state, clientId){
  const prs = {}; // exercise -> {exercise, bestE1rm, bestSet, date}
  const logs = state.workoutLogs || {};

  Object.keys(logs).forEach(date=>{
    const byClient = logs[date];
    if (!byClient || !byClient[clientId]) return;
    const exMap = byClient[clientId];

    Object.keys(exMap).forEach(exercise=>{
      const sets = exMap[exercise] || [];
      sets.forEach(s=>{
        const parsed = parseSetInputs(s.reps, s.weight);
        if (!parsed) return;
        const e1 = e1rmEpley(parsed.weight, parsed.reps);
        if (!e1) return;

        const current = prs[exercise];
        const bestSetStr = `${parsed.weight} x ${parsed.reps}`;
        if (!current || e1 > current.bestE1rm){
          prs[exercise] = { exercise, bestE1rm: e1, bestSet: bestSetStr, date };
        }
      });
    });
  });

  return Object.values(prs).sort((a,b)=>b.bestE1rm - a.bestE1rm);
}

// Session PRs for a given date (best per exercise)
function computeTodaysPRs(state, clientId, dateISO){
  const byDate = state.workoutLogs?.[dateISO]?.[clientId] || {};
  const out = [];
  Object.keys(byDate).forEach(exercise=>{
    let best = null;
    (byDate[exercise]||[]).forEach(s=>{
      const parsed = parseSetInputs(s.reps, s.weight);
      if (!parsed) return;
      const e1 = e1rmEpley(parsed.weight, parsed.reps);
      if (!e1) return;
      if (!best || e1 > best.bestE1rm){
        best = { exercise, bestE1rm: e1, bestSet: `${parsed.weight} x ${parsed.reps}`, date: dateISO };
      }
    });
    if (best) out.push(best);
  });
  return out.sort((a,b)=>b.bestE1rm-a.bestE1rm);
}

// Exercise history: best e1RM per date, plus best set
function computeExerciseHistory(state, clientId, exercise){
  const logs = state.workoutLogs || {};
  const items = [];

  Object.keys(logs).forEach(date=>{
    const exMap = logs[date]?.[clientId];
    if (!exMap) return;
    const sets = exMap[exercise];
    if (!sets || !sets.length) return;

    let bestE1 = null;
    let bestSet = null;

    sets.forEach(s=>{
      const parsed = parseSetInputs(s.reps, s.weight);
      if (!parsed) return;
      const e1 = e1rmEpley(parsed.weight, parsed.reps);
      if (!e1) return;
      if (bestE1 === null || e1 > bestE1){
        bestE1 = e1;
        bestSet = `${parsed.weight} x ${parsed.reps}`;
      }
    });

    if (bestE1 !== null){
      items.push({ date, bestSet, bestE1rm: bestE1, setCount: sets.length });
    }
  });

  // sort by date desc (ISO sorts lexicographically)
  items.sort((a,b)=>b.date.localeCompare(a.date));
  return items;
}

// list available exercises from logs for client
function listExercisesForClient(state, clientId){
  const ex = new Set();
  const logs = state.workoutLogs || {};
  Object.keys(logs).forEach(date=>{
    const exMap = logs[date]?.[clientId];
    if (!exMap) return;
    Object.keys(exMap).forEach(k=>ex.add(k));
  });
  return Array.from(ex).sort((a,b)=>a.localeCompare(b));
}

/** ========= Export / Backup ========= */
function downloadText(filename, text){
  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([text], {type:"text/plain"}));
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
}
function exportTodayCSV(state){
  const t = todayISO();
  const header = [
    "date","client","sleepHrs","rhr","stressAvg","bodyBatteryStart","bodyBatteryEnd","steps",
    "workoutDone","workoutMins","kcalTarget","protein","carbs","fat",
    "nutritionCompliancePct","bodyWeightKg","waistCm","dayNote",
    "soreness","mood","energy","digestion","flags"
  ];
  const rows = [header.join(",")];

  state.clients.forEach(c=>{
    ensureClientToday(c);
    const d = c.daily[t];
    const trg = c.macroTargets?.training || {kcal:"",p:"",c:"",f:""};
    const flags = flagRow(d).join("|");
    const line = [
      t,
      `"${c.name.replaceAll('"','""')}"`,
      d.sleepHrs, d.rhr, d.stressAvg, d.bodyBatteryStart, d.bodyBatteryEnd, d.steps,
      d.workoutDone ? "Yes":"No",
      d.workoutMins,
      trg.kcal, trg.p, trg.c, trg.f,
      d.nutritionCompliancePct,
      d.bodyWeightKg ?? "",
      d.waistCm ?? "",
      `"${(d.dayNote||"").replaceAll('"','""')}"`,
      d.selfReport?.soreness ?? "",
      d.selfReport?.mood ?? "",
      d.selfReport?.energy ?? "",
      d.selfReport?.digestion ?? "",
      `"${flags.replaceAll('"','""')}"`
    ];
    rows.push(line.join(","));
  });

  downloadText(`coachfit-today-${t}.csv`, rows.join("\n"));
}
function exportAllCSV(state){
  const header = [
    "date","clientId","client","sleepHrs","rhr","stressAvg","steps","workoutDone","workoutMins",
    "nutritionCompliancePct","bodyWeightKg","waistCm","dayNote","soreness","mood","energy","digestion"
  ];
  const rows = [header.join(",")];
  state.clients.forEach(c=>{
    Object.keys(c.daily || {}).sort().forEach(date=>{
      const d = c.daily[date];
      rows.push([
        date,
        c.id,
        `"${c.name.replaceAll('"','""')}"`,
        d.sleepHrs ?? "", d.rhr ?? "", d.stressAvg ?? "", d.steps ?? "",
        d.workoutDone ? "Yes":"No",
        d.workoutMins ?? "",
        d.nutritionCompliancePct ?? "",
        d.bodyWeightKg ?? "",
        d.waistCm ?? "",
        `"${(d.dayNote||"").replaceAll('"','""')}"`,
        d.selfReport?.soreness ?? "",
        d.selfReport?.mood ?? "",
        d.selfReport?.energy ?? "",
        d.selfReport?.digestion ?? ""
      ].join(","));
    });
  });
  downloadText(`coachfit-all-data-${todayISO()}.csv`, rows.join("\n"));
}
function exportBackupJSON(state){
  downloadText(`coachfit-backup-${todayISO()}.json`, JSON.stringify(state, null, 2));
}
function importBackupJSON(file){
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const obj = JSON.parse(reader.result);
      localStorage.setItem(LS_KEY, JSON.stringify(obj));
      alert("Backup restored. Reloading‚Ä¶");
      location.reload();
    } catch(e){
      alert("Could not import JSON. Make sure it‚Äôs a CoachFit backup file.");
    }
  };
  reader.readAsText(file);
}

/** ========= Views ========= */
function viewLogin(state){
  const root = document.getElementById("app");
  root.innerHTML = "";
  root.appendChild(el(`
    <div class="grid">
      <div class="card">
        <h1>CoachFit</h1>
        <p class="muted">Pitch + personal tracking demo (localStorage). Use demo accounts below.</p>
        <div class="row">
          <span class="tag">coach@demo.com / demo</span>
          <span class="tag">client@demo.com / demo</span>
        </div>
        <label>Email</label>
        <input id="email" placeholder="coach@demo.com" />
        <label>Password</label>
        <input id="pass" type="password" placeholder="demo" />
        <div class="row" style="margin-top:10px;">
          <button class="primary" id="loginBtn">Login</button>
          <button id="resetBtn">Reset demo data</button>
          <button id="gotoLandingBtn">View landing</button>
        </div>
        <p class="hint">After code updates, click <b>Reset demo data</b> once if anything looks odd.</p>
      </div>

      <div class="card">
        <h2>Includes</h2>
        <div class="row">
          <span class="tag">Coach Today + 7-day</span>
          <span class="tag">Alerts-only</span>
          <span class="tag">Bodyweight + waist</span>
          <span class="tag">Progress + backups</span>
          <span class="tag">PRs (e1RM)</span>
          <span class="tag">Exercise history</span>
          <span class="tag">Workout logging</span>
          <span class="tag">Messaging</span>
        </div>
      </div>
    </div>
  `));

  root.querySelector("#gotoLandingBtn").onclick = () => { state.ui.view="landing"; save(state); render(); };

  root.querySelector("#loginBtn").onclick = () => {
    const email = root.querySelector("#email").value.trim().toLowerCase();
    const pass = root.querySelector("#pass").value.trim();
    const user = state.users.find(u=>u.email===email && u.pass===pass);
    if (!user) return alert("Invalid demo credentials.");
    state.session = { userId:user.id };
    state.ui.view = user.role==="coach" ? "coach" : "client";
    if (user.role==="client") state.ui.selectedClientId = user.clientId || "c1";
    save(state);
    render();
  };

  root.querySelector("#resetBtn").onclick = () => {
    localStorage.removeItem(LS_KEY);
    location.reload();
  };
}

function viewLanding(state){
  const root = document.getElementById("app");
  root.innerHTML = "";
  root.appendChild(el(`
    <div class="card">
      <h1>High-performance coaching, made scalable</h1>
      <p class="muted">Clients log training + nutrition + recovery daily. Coaches scan a Today table with flags, PRs, and trends.</p>
      <div class="row">
        <span class="tag">Targets-first nutrition</span>
        <span class="tag">Workout logging</span>
        <span class="tag">Daily check-in</span>
        <span class="tag">PR tracking</span>
        <span class="tag">Exercise history</span>
      </div>
      <div class="row" style="margin-top:12px;">
        <button class="primary" id="ctaPricing">See pricing</button>
        <button id="ctaLogin">Login (demo)</button>
      </div>
    </div>
  `));
  root.querySelector("#ctaPricing").onclick = () => { state.ui.view="pricing"; save(state); render(); };
  root.querySelector("#ctaLogin").onclick = () => { state.ui.view="login"; save(state); render(); };
}

function viewPricing(state){
  const root = document.getElementById("app");
  root.innerHTML = "";
  root.appendChild(el(`
    <div class="grid">
      <div class="card">
        <h1>Pricing</h1>
        <p class="muted">Example: setup fee + monthly subscription + per-session in-person.</p>
        <div class="split">
          <div class="card" style="border-radius:12px;margin:0;">
            <h2>Starter</h2>
            <div class="row"><span class="tag">Setup: $199</span><span class="tag">Monthly: $39</span></div>
            <ul class="muted">
              <li>Targets + templates</li>
              <li>Workout logging</li>
              <li>Daily check-ins</li>
              <li>Messaging</li>
            </ul>
          </div>
          <div class="card ok" style="border-radius:12px;margin:0;">
            <h2>Pro</h2>
            <div class="row"><span class="tag">Setup: $399</span><span class="tag">Monthly: $79</span></div>
            <ul class="muted">
              <li>Coach Today + 7-day</li>
              <li>Flags + alerts-only</li>
              <li>Progress + PRs</li>
              <li>Exercise history</li>
              <li>CSV export</li>
            </ul>
          </div>
        </div>
        <div class="row" style="margin-top:12px;">
          <button class="primary" id="toLogin">Login (demo)</button>
          <button id="toLanding">Back</button>
        </div>
      </div>
      <div class="card">
        <h2>Demo note</h2>
        <div class="muted">This is static/localStorage. Full-stack comes later (real accounts + DB + Garmin + Stripe).</div>
      </div>
    </div>
  `));
  root.querySelector("#toLogin").onclick = () => { state.ui.view="login"; save(state); render(); };
  root.querySelector("#toLanding").onclick = () => { state.ui.view="landing"; save(state); render(); };
}

/** ========= Coach view ========= */

function ensureGenetics(client){
  client.genetics = client.genetics || {};
  client.genetics.performance = client.genetics.performance || {};
  client.genetics.nutrition = client.genetics.nutrition || {};
  const p = client.genetics.performance;
  const n = client.genetics.nutrition;

  p.fastTwitchBias = p.fastTwitchBias || "Not assessed";
  p.recoverySpeed = p.recoverySpeed || "Not assessed";
  p.injuryRisk = Array.isArray(p.injuryRisk) ? p.injuryRisk : [];
  p.notes = p.notes || "";

  n.carbTolerance = n.carbTolerance || "Not assessed";
  n.fatTolerance = n.fatTolerance || "Not assessed";
  n.proteinRequirement = n.proteinRequirement || "Not assessed";
  n.notes = n.notes || "";
}

function renderGeneticsModal(state, root){
  const id = state?.ui?.geneticsEditingClientId;
  if (!id) return;
  const client = state.clients.find(c=>c.id===id);
  if (!client) { state.ui.geneticsEditingClientId=null; save(state); return; }
  ensureGenetics(client);

  const p = client.genetics.performance;
  const n = client.genetics.nutrition;

  const overlay = document.createElement("div");
  overlay.style.position = "fixed";
  overlay.style.inset = "0";
  overlay.style.background = "rgba(0,0,0,0.45)";
  overlay.style.zIndex = "9999";
  overlay.style.display = "flex";
  overlay.style.alignItems = "center";
  overlay.style.justifyContent = "center";
  overlay.style.padding = "16px";

  const card = document.createElement("div");
  card.className = "card";
  card.style.maxWidth = "760px";
  card.style.width = "100%";
  card.style.maxHeight = "85vh";
  card.style.overflow = "auto";
  card.style.borderRadius = "18px";

  card.innerHTML = `
    <div class="row" style="justify-content:space-between;gap:12px;align-items:flex-start;">
      <div>
        <div class="hint">Editing genetics for</div>
        <h2 style="margin:4px 0 0 0;">${esc(client.name || "Client")}</h2>
      </div>
      <button class="small" id="genClose">‚úï</button>
    </div>

    <hr class="hr">

    <div class="grid2">
      <div>
        <h3 style="margin:0 0 8px 0;">üèãÔ∏è Performance traits</h3>

        <div class="muted" style="margin-bottom:6px;">Muscle fiber bias</div>
        <select id="gFast" style="width:100%;">
          ${["Not assessed","High","Moderate","Low"].map(v=>`<option value="${v}" ${p.fastTwitchBias===v?"selected":""}>${v}</option>`).join("")}
        </select>

        <div class="muted" style="margin:12px 0 6px;">Recovery speed</div>
        <select id="gRec" style="width:100%;">
          ${["Not assessed","Fast","Moderate","Slow"].map(v=>`<option value="${v}" ${p.recoverySpeed===v?"selected":""}>${v}</option>`).join("")}
        </select>

        <div class="muted" style="margin:12px 0 6px;">Injury risk tags</div>
        <div class="row" style="gap:8px;flex-wrap:wrap;">
          ${["knee","shoulder","lower back","ankle","wrist"].map(tag=>`
            <label class="hint" style="display:flex;gap:8px;align-items:center;cursor:pointer;">
              <input type="checkbox" data-inj="${tag}" ${p.injuryRisk.includes(tag)?"checked":""}>
              ${tag}
            </label>
          `).join("")}
        </div>
        <div class="hint" style="margin-top:6px;">Add custom tags (comma-separated)</div>
        <input id="gInjCustom" placeholder="e.g. elbow, hip" value="" style="width:100%;margin-top:6px;">

        <div class="muted" style="margin:12px 0 6px;">Notes (optional)</div>
        <textarea id="gPNotes" rows="3" style="width:100%;">${esc(p.notes||"")}</textarea>
      </div>

      <div>
        <h3 style="margin:0 0 8px 0;">ü•ó Dietary traits</h3>

        <div class="muted" style="margin-bottom:6px;">Carb tolerance</div>
        <select id="gCarb" style="width:100%;">
          ${["Not assessed","High","Moderate","Low"].map(v=>`<option value="${v}" ${n.carbTolerance===v?"selected":""}>${v}</option>`).join("")}
        </select>

        <div class="muted" style="margin:12px 0 6px;">Fat tolerance</div>
        <select id="gFat" style="width:100%;">
          ${["Not assessed","High","Moderate","Low"].map(v=>`<option value="${v}" ${n.fatTolerance===v?"selected":""}>${v}</option>`).join("")}
        </select>

        <div class="muted" style="margin:12px 0 6px;">Protein requirement</div>
        <select id="gProt" style="width:100%;">
          ${["Not assessed","High","Moderate","Low"].map(v=>`<option value="${v}" ${n.proteinRequirement===v?"selected":""}>${v}</option>`).join("")}
        </select>

        <div class="muted" style="margin:12px 0 6px;">Notes (optional)</div>
        <textarea id="gNNotes" rows="3" style="width:100%;">${esc(n.notes||"")}</textarea>

        <div class="hint" style="margin-top:10px;">Genetics indicate predisposition, not prescription.</div>
      </div>
    </div>

    <hr class="hr">

    <div class="row" style="justify-content:flex-end;gap:10px;flex-wrap:wrap;">
      <button class="small" id="genCancel">Cancel</button>
      <button class="small" id="genSave">Save genetics</button>
    </div>
  `;

  overlay.appendChild(card);
  document.body.appendChild(overlay);

  const close = ()=>{
    state.ui.geneticsEditingClientId = null;
    save(state);
    overlay.remove();
  };

  overlay.addEventListener("click", (e)=>{
    if (e.target === overlay) close();
  });

  card.querySelector("#genClose").onclick = (e)=>{ e.preventDefault?.(); close(); };
  card.querySelector("#genCancel").onclick = (e)=>{ e.preventDefault?.(); close(); };

  card.querySelector("#genSave").onclick = (e)=>{
    e.preventDefault?.();

    p.fastTwitchBias = card.querySelector("#gFast").value;
    p.recoverySpeed = card.querySelector("#gRec").value;

    // injury tags
    const chosen = Array.from(card.querySelectorAll("[data-inj]")).filter(x=>x.checked).map(x=>x.getAttribute("data-inj"));
    const custom = (card.querySelector("#gInjCustom").value || "").split(",").map(s=>s.trim()).filter(Boolean);
    p.injuryRisk = Array.from(new Set(chosen.concat(custom)));

    p.notes = card.querySelector("#gPNotes").value || "";

    n.carbTolerance = card.querySelector("#gCarb").value;
    n.fatTolerance = card.querySelector("#gFat").value;
    n.proteinRequirement = card.querySelector("#gProt").value;
    n.notes = card.querySelector("#gNNotes").value || "";

    save(state);
    close();
    render();
  };
}


function roundTo(n, step){
  step = step || 1;
  return Math.round(n/step)*step;
}

function buildAdjustmentProposal(state, client, action){
  const proposal = { type: action, title: "", details: "", before: {}, after: {}, apply: null };

  const targets = client?.macroTargets?.training || {};
  const kcal = Number(targets.kcal)||0;
  const P = Number(targets.p)||0;
  const C = Number(targets.c)||0;
  const F = Number(targets.f)||0;

  const bw = Number(client?.profile?.weightKg);
  const g = client?.genetics || {};
  const gp = g.performance || {};
  const gn = g.nutrition || {};

  const kcalFrom = (p,c,f)=> (p*4)+(c*4)+(f*9);
  const clamp = (v, lo, hi)=> Math.max(lo, Math.min(hi, v));

  proposal.before = { kcal: kcal, p: P, c: C, f: F };

  if (action === "macros"){
    // Priority: low fat, low carb, high protein (first matching)
    if (gn.fatTolerance === "Low"){
      proposal.title = "Adjust macros for low fat tolerance";
      const newF = clamp(roundTo(F*0.75, 5), 40, 80);
      const deltaKcal = (F - newF)*9;
      const newC = clamp(roundTo(C + (deltaKcal/4), 5), 80, 450);
      proposal.after = { kcal: kcal, p: P, c: newC, f: newF };
      proposal.details = "Reduce fats and shift calories into carbs while keeping kcal stable.";
    } else if (gn.carbTolerance === "Low"){
      proposal.title = "Adjust macros for low carb tolerance";
      const newC = clamp(roundTo(C*0.75, 5), 120, 280);
      const deltaKcal = (C - newC)*4;
      const newF = clamp(roundTo(F + (deltaKcal/9), 5), 40, 110);
      proposal.after = { kcal: kcal, p: P, c: newC, f: newF };
      proposal.details = "Reduce carbs and shift calories into fats while keeping kcal stable.";
    } else if (gn.proteinRequirement === "High" && isFinite(bw) && bw>0){
      proposal.title = "Adjust macros for high protein requirement";
      const minP = roundTo(bw*1.8, 5);
      const newP = clamp(Math.max(P, minP), 120, 260);
      const deltaKcal = (newP - P)*4;
      // reduce carbs first, then fats if needed
      let newC = C;
      let newF = F;
      if (deltaKcal > 0){
        const canDropC = Math.max(0, C - 120);
        const dropC = Math.min(canDropC, deltaKcal/4);
        newC = roundTo(C - dropC, 5);
        const rem = deltaKcal - dropC*4;
        if (rem > 0){
          const canDropF = Math.max(0, F - 40);
          const dropF = Math.min(canDropF, rem/9);
          newF = roundTo(F - dropF, 5);
        }
      }
      proposal.after = { kcal: kcal, p: newP, c: newC, f: newF };
      proposal.details = "Increase protein toward ~1.8 g/kg and rebalance carbs/fats to keep kcal stable.";
    } else {
      proposal.title = "No macro adjustment suggested";
      proposal.details = "No matching genetics-triggered macro rule was found.";
      proposal.after = { kcal: kcal, p: P, c: C, f: F };
    }

    proposal.apply = () => {
      client.macroTargets = client.macroTargets || {};
      client.macroTargets.training = client.macroTargets.training || {};
      client.macroTargets.training.kcal = proposal.after.kcal;
      client.macroTargets.training.p = proposal.after.p;
      client.macroTargets.training.c = proposal.after.c;
      client.macroTargets.training.f = proposal.after.f;
    };
    return proposal;
  }

  if (action === "schedule"){
    proposal.title = "Adjust weekly schedule for recovery";
    const sched = Object.assign({}, state.weeklySchedule||{});
    const before = Object.assign({}, sched);

    // pick a day to convert to rest (Wed preferred)
    const order = ["wed","sat","sun","tue","thu","fri","mon"];
    let changedDay = null;
    for (const d of order){
      if (sched[d] && sched[d] !== "rest"){
        sched[d] = "rest";
        changedDay = d;
        break;
      }
    }
    proposal.before = before;
    proposal.after = sched;
    proposal.details = changedDay ? `Set ${changedDay.toUpperCase()} as a rest day to support slow recovery.` : "No suitable day found to convert to rest.";
    proposal.apply = () => {
      state.weeklySchedule = sched;
    };
    return proposal;
  }

  if (action === "plan"){
    proposal.title = "Review plan";
    proposal.details = "This warning is informational. Consider exercise swaps or volume adjustments.";
    proposal.after = proposal.before;
    proposal.apply = () => {};
    return proposal;
  }

  // genetics action -> open editor
  proposal.title = "Edit genetics";
  proposal.details = "Open genetics editor to update traits.";
  proposal.apply = () => {};
  return proposal;
}

function openAdjustmentModal(state, clientId, action){
  state.ui = state.ui || {};
  state.ui.adjustmentModal = { clientId, action };
  save(state);
  render();
}

function renderAdjustmentModal(state){
  const modal = state?.ui?.adjustmentModal;
  if (!modal) return;

  const client = state.clients.find(c=>c.id===modal.clientId);
  if (!client){ state.ui.adjustmentModal=null; save(state); return; }

  const proposal = buildAdjustmentProposal(state, client, modal.action);

  const overlay = document.createElement("div");
  overlay.style.position="fixed";
  overlay.style.inset="0";
  overlay.style.background="rgba(0,0,0,0.45)";
  overlay.style.zIndex="9999";
  overlay.style.display="flex";
  overlay.style.alignItems="center";
  overlay.style.justifyContent="center";
  overlay.style.padding="16px";

  const card = document.createElement("div");
  card.className="card";
  card.style.maxWidth="720px";
  card.style.width="100%";
  card.style.borderRadius="18px";
  card.style.maxHeight="85vh";
  card.style.overflow="auto";

  const close = ()=>{
    state.ui.adjustmentModal = null;
    save(state);
    overlay.remove();
  };

  const renderMacroRows = (obj)=>{
    if (!obj) return "";
    const keys = ["kcal","p","c","f"];
    return keys.map(k=>`<div class="row" style="justify-content:space-between;"><span class="hint">${k.toUpperCase()}</span><b>${esc(obj[k])}</b></div>`).join("");
  };

  const renderSchedule = (sched)=>{
    if (!sched) return "";
    const days=[["mon","Mon"],["tue","Tue"],["wed","Wed"],["thu","Thu"],["fri","Fri"],["sat","Sat"],["sun","Sun"]];
    return days.map(([k,l])=>{
      const v = sched[k] || "rest";
      const name = v==="rest" ? "Rest" : (getTemplateById(state, v)?.name || v);
      return `<div class="row" style="justify-content:space-between;"><span class="hint">${l}</span><b>${esc(name)}</b></div>`;
    }).join("");
  };

  const isSchedule = proposal.type==="schedule";
  const left = isSchedule ? renderSchedule(proposal.before) : renderMacroRows(proposal.before);
  const right = isSchedule ? renderSchedule(proposal.after) : renderMacroRows(proposal.after);

  card.innerHTML = `
    <div class="row" style="justify-content:space-between;gap:12px;align-items:flex-start;">
      <div>
        <div class="hint">Proposed change for</div>
        <h2 style="margin:4px 0 0 0;">${esc(client.name || "Client")}</h2>
        <div class="muted" style="margin-top:6px;"><b>${esc(proposal.title)}</b></div>
        <div class="hint" style="margin-top:6px;">${esc(proposal.details)}</div>
      </div>
      <button class="small" id="adjClose">‚úï</button>
    </div>

    <hr class="hr">

    <div class="grid2">
      <div>
        <div class="hint">Before</div>
        <div class="card" style="border-radius:14px;margin-top:6px;">${left}</div>
      </div>
      <div>
        <div class="hint">After</div>
        <div class="card" style="border-radius:14px;margin-top:6px;">${right}</div>
      </div>
    </div>

    <hr class="hr">

    <div class="row" style="justify-content:flex-end;gap:10px;flex-wrap:wrap;">
      <button class="small" id="adjCancel">Cancel</button>
      <button class="small" id="adjApply">Apply</button>
    </div>
  `;

  overlay.appendChild(card);
  document.body.appendChild(overlay);

  overlay.addEventListener("click", (e)=>{ if (e.target===overlay) close(); });
  card.querySelector("#adjClose").onclick = (e)=>{ e.preventDefault?.(); close(); };
  card.querySelector("#adjCancel").onclick = (e)=>{ e.preventDefault?.(); close(); };
  card.querySelector("#adjApply").onclick = (e)=>{
    e.preventDefault?.();
    try { proposal.apply && proposal.apply(); } catch(err){ console.error(err); }
    // Mark relevant warning resolved if it still exists
    const warns = computeProgramWarnings(state, client);
    const w = warns.find(x=>x.action===modal.action);
    if (w){
      client.resolvedWarnings = client.resolvedWarnings || [];
      if (!client.resolvedWarnings.includes(w.id)) client.resolvedWarnings.push(w.id);
    }
    save(state);
    close();
    render();
  };
}

function openCustomFoodModal(state, existing){
  state.ui = state.ui || {};
  const ex = existing || {};
  state.ui.customFoodModal = {name: ex.name||"", category: ex.category||"Other", kcal: ex.kcal||0, p: ex.p||0, c: ex.c||0, f: ex.f||0, originalName: ex.name||""};
  save(state);
  render();
}

function renderCustomFoodModal(state){
  const m = state?.ui?.customFoodModal;
  if (!m) return;

  const overlay = document.createElement("div");
  overlay.style.position="fixed";
  overlay.style.inset="0";
  overlay.style.background="rgba(0,0,0,0.45)";
  overlay.style.zIndex="9999";
  overlay.style.display="flex";
  overlay.style.alignItems="center";
  overlay.style.justifyContent="center";
  overlay.style.padding="16px";

  const card = document.createElement("div");
  card.className="card";
  card.style.maxWidth="560px";
  card.style.width="100%";
  card.style.borderRadius="18px";

  const cats = ["Other","Protein","Carb","Fat","Veg"];
  card.innerHTML = `
    <div class="row" style="justify-content:space-between;gap:12px;align-items:flex-start;">
      <div>
        <div class="hint">Food library</div>
        <h2 style="margin:4px 0 0 0;">${(m.originalName && String(m.originalName).trim()) ? 'Edit custom food' : 'Add custom food'}</h2>
      </div>
      <button class="small" id="cfClose">‚úï</button>
    </div>

    <hr class="hr">

    <div class="muted">Food name</div>
    <input id="cfName" placeholder="e.g. My Granola (50g)" value="${esc(m.name||"")}" style="width:100%;margin-top:6px;">

    <div class="muted" style="margin-top:12px;">Category</div>
    <select id="cfCat" style="width:100%;margin-top:6px;">
      ${cats.map(v=>`<option value="${v}" ${String(m.category||"Other")===v?"selected":""}>${v}</option>`).join("")}
    </select>

    <div class="grid2" style="margin-top:12px;">
      <div>
        <div class="muted">Calories (kcal)</div>
        <input id="cfKcal" type="number" step="1" value="${esc(m.kcal)}" style="width:100%;margin-top:6px;">
      </div>
      <div>
        <div class="muted">Protein (g)</div>
        <input id="cfP" type="number" step="0.1" value="${esc(m.p)}" style="width:100%;margin-top:6px;">
      </div>
      <div>
        <div class="muted">Carbs (g)</div>
        <input id="cfC" type="number" step="0.1" value="${esc(m.c)}" style="width:100%;margin-top:6px;">
      </div>
      <div>
        <div class="muted">Fat (g)</div>
        <input id="cfF" type="number" step="0.1" value="${esc(m.f)}" style="width:100%;margin-top:6px;">
      </div>
    </div>

    <hr class="hr">

    <div class="row" style="justify-content:flex-end;gap:10px;flex-wrap:wrap;">
      <button class="small" id="cfCancel">Cancel</button>
      <button class="small" id="cfSave">Save food</button>
    </div>
  `;

  overlay.appendChild(card);
  document.body.appendChild(overlay);

  const close = ()=>{
    state.ui.customFoodModal = null;
    save(state);
    overlay.remove();
  };

  overlay.addEventListener("click", (e)=>{ if (e.target===overlay) close(); });
  card.querySelector("#cfClose").onclick = (e)=>{ e.preventDefault?.(); close(); };
  card.querySelector("#cfCancel").onclick = (e)=>{ e.preventDefault?.(); close(); };

  card.querySelector("#cfSave").onclick = (e)=>{
    e.preventDefault?.();
    const name = String(card.querySelector("#cfName").value||"").trim();
    if (!name) return alert("Please enter a food name.");
    const food = {
      name,
      category: card.querySelector("#cfCat").value || "Other",
      kcal: Number(card.querySelector("#cfKcal").value)||0,
      p: Number(card.querySelector("#cfP").value)||0,
      c: Number(card.querySelector("#cfC").value)||0,
      f: Number(card.querySelector("#cfF").value)||0,
    };
    if (m.originalName && String(m.originalName).trim() && String(m.originalName).toLowerCase() !== String(food.name).toLowerCase()) {
      // rename: remove old entry first
      removeCustomFood(state, m.originalName);
    }
    addCustomFood(state, food);
    save(state);
    close();
    render();
  };
}




function bindProgramWarnings(state, root, selected){
  const gw = root.querySelector("#geneticsWarnings");
  if (!gw || !selected) return;

  // clicks on warning lines
  gw.querySelectorAll("[data-warnline]").forEach(a=>{
    a.onclick = (ev)=>{
      ev.preventDefault?.();
      ev.stopPropagation();
      const action = a.getAttribute("data-warnline");
      if (action === "genetics"){
        openGeneticsEditor(state, selected.id);
        return;
      }
      if (action === "plan"){
        // for now, jump to schedule as the closest editable plan surface
        state.ui.scrollTo = "weeklySchedule";
        save(state);
        render();
        return;
      }
      openAdjustmentModal(state, selected.id, action);
    };
  });

  // checkbox resolve/unresolve
  gw.querySelectorAll("[data-warncheck]").forEach(ch=>{
    ch.onchange = ()=>{
      const id = ch.getAttribute("data-warncheck");
      selected.resolvedWarnings = selected.resolvedWarnings || [];
      const set = new Set(selected.resolvedWarnings);
      if (ch.checked) set.add(id); else set.delete(id);
      selected.resolvedWarnings = Array.from(set);
      save(state);
      render();
    };
  });

  const resolveAll = gw.querySelector("#resolveAllWarnings");
  if (resolveAll) resolveAll.onclick = (ev)=>{
    ev.preventDefault?.();
    const all = computeProgramWarnings(state, selected);
    selected.resolvedWarnings = selected.resolvedWarnings || [];
    const set = new Set(selected.resolvedWarnings);
    all.forEach(w=>set.add(w.id));
    selected.resolvedWarnings = Array.from(set);
    save(state);
    render();
  };

  const clearResolved = gw.querySelector("#clearResolvedWarnings");
  if (clearResolved) clearResolved.onclick = (ev)=>{
    ev.preventDefault?.();
    selected.resolvedWarnings = [];
    save(state);
    render();
  };

  const toggle = gw.querySelector("#toggleResolvedWarnings");
  if (toggle) toggle.onchange = ()=>{
    state.ui.showResolvedWarnings = !!toggle.checked;
    save(state);
    render();
  };
}

function viewCoach(state){
  const root = document.getElementById("app");
  root.innerHTML = "";

  state.clients.forEach(ensureClientToday);

  const selectedId = state.ui.selectedClientId || state.clients[0]?.id;
  const selected = state.clients.find(c=>c.id===selectedId) || state.clients[0];

  const header = el(`
    <div class="row" style="justify-content:space-between;margin-bottom:12px;">
      <div class="row">
        <span class="tag">Coach</span>
        <span class="tag">Clients: ${state.clients.length}</span>
        <span class="tag">Selected: ${selected ? selected.name : "‚Äî"}</span>
      </div>
      <div class="row">
        <label class="row" style="margin:0;gap:6px;">
          <input id="alertsOnly" type="checkbox" style="width:auto;" ${state.ui.coach?.alertsOnly ? "checked":""}>
          <span class="muted">Alerts only</span>
        </label>
        <button class="small" id="csvBtn">Export Today CSV</button>
        <button class="small" id="allCsvBtn">Export All CSV</button>
        <button class="small" id="addClientBtn">Add client</button>
      </div>
    </div>
  `);

  const sidebar = el(`
    <div class="card">
      <h2>Clients</h2>
      <label>Search</label>
      <input id="q" placeholder="Type a name..." />
      <div id="clientList" style="margin-top:10px;display:flex;flex-direction:column;gap:6px;"></div>

      <hr class="hr">
      <h3>Selected client</h3>
      <div class="row">
        <span class="tag" id="selName">${selected?.name || ""}</span>
        <span class="tag">${selected?.profile?.constraints?.join(", ") || "no constraints"}</span>
      </div>

      <div style="display:flex;align-items:center;gap:8px;margin:12px 0;">
        <span style="font-size:18px;">üß¨</span>
        <h3 style="margin:0;">Genetics profile</h3>
      </div>
      <div class="card warn" style="border-radius:12px;margin-bottom:12px;">
        <div class="muted">
          Genetic traits guide training & nutrition decisions.<br>
          <b>Predispositions, not guarantees.</b>
        </div>

        <div style="margin-top:10px;">
          <div class="muted"><b>Training</b></div>
          <div class="row" style="margin-top:6px;">
            <span class="tag">${selected?.genetics?.performance?.fastTwitchBias || "Not assessed"}</span>
            <span class="tag">${(selected?.genetics?.performance?.recoverySpeed || "Not assessed")} recovery</span>
          </div>
          <div class="muted" style="margin-top:6px;">Injury risk: ${(selected?.genetics?.performance?.injuryRisk||[]).join(", ") || "‚Äî"}</div>

          <div id="geneticsWarnings">${warningsListHTML(state, selected)}</div>

          <div class="muted" style="margin-top:10px;"><b>Nutrition</b></div>
          <div class="row" style="margin-top:6px;">
            <span class="tag">Carbs: ${selected?.genetics?.nutrition?.carbTolerance || "Not assessed"}</span>
            <span class="tag">Fat: ${selected?.genetics?.nutrition?.fatTolerance || "Not assessed"}</span>
            <span class="tag">Protein: ${selected?.genetics?.nutrition?.proteinRequirement || "Not assessed"}</span>
          </div>
        </div>

        <button id="editGeneticsBtn" style="margin-top:10px;">Edit genetics</button>
      </div>

      <label id="macroTargets">Nutrition targets (training day)</label>
      <div class="row">
        <input id="kcal" style="max-width:110px" value="${selected.macroTargets.training.kcal}" />
        <input id="p" style="max-width:110px" value="${selected.macroTargets.training.p}" />
        <input id="c" style="max-width:110px" value="${selected.macroTargets.training.c}" />
        <input id="f" style="max-width:110px" value="${selected.macroTargets.training.f}" />
      </div>
      <div class="muted">kcal / P / C / F</div>
      <button class="primary" id="saveTargetsBtn" style="margin-top:10px;">Save targets</button>

      <label style="margin-top:14px;">Assign diet template (optional)</label>
      <select id="tplSel">
        ${state.dietTemplates.map(tpl=>`<option value="${tpl.id}" ${tpl.id===selected.assignedTemplateId?"selected":""}>${tpl.name}</option>`).join("")}
      </select>
      <button id="assignTplBtn" style="margin-top:10px;">Assign template</button>

      <div class="row" style="margin-top:8px;">
        <button class="small" id="manageDietBtn">Manage templates</button>
        <button class="small" id="editPlanBtn">Edit active plan</button>
      </div>

      <hr class="hr">
      <div class="row">
        <button id="editClientBtn">Edit client</button>
        <button class="danger" id="delClientBtn">Delete</button>
      </div>
      <div class="row" style="margin-top:8px;">
        <button id="toClientBtn">Open client</button>
        <button id="toProgressBtn">Progress</button>
        <button id="toHistoryBtn">History</button>
        <button id="toMessagesBtn">Messages</button>
      </div>
    </div>
  `);

  const right = el(`
    <div class="row" style="flex-direction:column;gap:12px;">
      <div class="row" style="justify-content:space-between;">
        <div class="tabs">
          <button class="tab active" data-tab="today">Today</button>
          <button class="tab" data-tab="week">Rolling 7 days</button>
        </div>
        <div class="muted">Click a row to select.</div>
      </div>

      <div class="card" id="todayCard">
        <h2>Today (${todayISO()})</h2>
        <p class="muted">Notes column + Alerts-only filter. Use ‚ÄúSim sync‚Äù as Garmin placeholder.</p>
        <div class="tablewrap">
          <table>
            <thead>
              <tr>
                <th>Client</th>
                <th>Genetics</th>
                <th>Adherence</th>
                <th>Status</th>
                <th>Sleep</th>
                <th>RHR</th>
                <th>Stress</th>
                <th>Steps</th>
                <th>Workout</th>
                <th>Nutrition %</th>
                <th>Weight</th>
                <th>Waist</th>
                <th>Notes</th>
                <th>Flags</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="tbodyToday"></tbody>
          </table>
        </div>
      </div>

      <div class="card" id="weekCard" style="display:none;">
        <h2>Rolling 7 days (${selected.name})</h2>
        <p class="muted">Weekly averages include weight + waist if logged.</p>
        <div id="weekKPIs"></div>
        <div class="tablewrap" style="margin-top:12px;">
          <table>
            <thead>
              <tr>
                <th>Date</th><th>Sleep</th><th>RHR</th><th>Stress</th><th>Steps</th><th>Workout</th><th>Nutrition %</th><th>Weight</th><th>Waist</th><th>Note</th>
              </tr>
            </thead>
            <tbody id="tbodyWeek"></tbody>
          </table>
        </div>
      </div>
    </div>
  `);

  root.appendChild(header);
  const grid = el(`<div class="grid"></div>`);
  grid.appendChild(sidebar);
  grid.appendChild(right);
  root.appendChild(grid);

  // client list
  const list = root.querySelector("#clientList");
  function paintClientList(filter=""){
    list.innerHTML = "";
    const q = filter.trim().toLowerCase();
    state.clients
      .filter(c=>!q || c.name.toLowerCase().includes(q) || c.email.toLowerCase().includes(q))
      .forEach(c=>{
        const isSel = c.id===state.ui.selectedClientId;
        const row = el(`
          <button class="${isSel?'primary':''}" style="text-align:left;">
            <b>${c.name}</b><div class="muted">${c.email}</div>
          </button>
        `);
        row.onclick = () => { state.ui.selectedClientId = c.id; save(state); render(); };
        list.appendChild(row);
      });
  }
  paintClientList();
  root.querySelector("#q").oninput = (e)=>paintClientList(e.target.value);

  // Alerts-only toggle
  root.querySelector("#alertsOnly").onchange = (e) => {
    state.ui.coach = state.ui.coach || {};
    state.ui.coach.alertsOnly = !!e.target.checked;
    save(state);
    render();
  };

  // today table
  const t = todayISO();
  const tbody = root.querySelector("#tbodyToday");
  tbody.innerHTML = "";
  state.clients.forEach(c=>{
    ensureClientToday(c);
    const day = c.daily[t];
    const flags = flagRow(day);
    const needsAttention = flags.length > 0;

    const g = c.genetics || {performance:{}, nutrition:{}};
    const gP = g.performance || {};
    const gN = g.nutrition || {};
    const gAssessed = (gP.fastTwitchBias && gP.fastTwitchBias !== "Not assessed") ||
                      (gP.recoverySpeed && gP.recoverySpeed !== "Not assessed") ||
                      (gN.carbTolerance && gN.carbTolerance !== "Not assessed") ||
                      (gN.fatTolerance && gN.fatTolerance !== "Not assessed") ||
                      (gN.proteinRequirement && gN.proteinRequirement !== "Not assessed");
    const _allW = computeProgramWarnings(state, c);
    const _resW = new Set((c.resolvedWarnings||[]));
    const wCount = _allW.filter(w=>!_resW.has(w.id)).length;
    const adh7 = last7CompletionCount(c);
    const adhTarget = 6; // based on 6 templates/week (excluding rest)
    const adhLabel = `${adh7}/${adhTarget}`;

    const gTags = gAssessed
      ? [
          gP.fastTwitchBias && gP.fastTwitchBias !== "Not assessed" ? `FT: ${gP.fastTwitchBias}` : null,
          gP.recoverySpeed && gP.recoverySpeed !== "Not assessed" ? `Rec: ${gP.recoverySpeed}` : null,
          gN.carbTolerance && gN.carbTolerance !== "Not assessed" ? `Carbs: ${gN.carbTolerance}` : null
        ].filter(Boolean).slice(0,3)
      : [];
    if (state.ui.coach?.alertsOnly && !needsAttention) return;

    const tr = el(`
      <tr style="cursor:pointer;">
        <td><b>${gAssessed ? "üß¨ " : ""}${c.name}</b><div class="muted">${c.profile.notes || ""}</div></td>
        <td>${gAssessed ? `<div class="row" data-genopen style="gap:6px;flex-wrap:wrap;">${gTags.map(t=>`<span class=\\\"tag\\\">${t}</span>`).join("")}${wCount?`<span class=\\\"tag attn\\\" data-warnopen>‚ö† ${wCount}</span>`:`<span class=\\\"tag\\\">‚úÖ</span>`}</div><div class="hint" style="margin-top:6px;"><a href="#" data-genopen style="text-decoration:none;">Edit genetics</a></div>` : `<div class="row" data-genopen style="gap:6px;flex-wrap:wrap;align-items:center;"><span class="tag attn">Not assessed</span><span class="hint">Click to add</span></div>`}</td>
                <td><a href="#" data-adhopen style="text-decoration:none;"><span class="tag">${adhLabel}</span> <span class="hint">${Math.round((adh7/adhTarget)*100)}%</span></a></td>
        <td>${needsAttention ? `<span class="tag attn">Needs attention</span>` : `<span class="tag">OK</span>`}</td>
        <td>${fmt(day.sleepHrs)}h</td>
        <td>${fmt(day.rhr)}</td>
        <td>${fmt(day.stressAvg)}</td>
        <td>${fmt(day.steps)}</td>
        <td>${day.workoutDone ? "Done" : "Not done"} <div class="muted">${day.workoutMins?day.workoutMins+"m":""}</div></td>
        <td>${fmt(day.nutritionCompliancePct)}%</td>
        <td>${fmt(day.bodyWeightKg)}</td>
        <td>${fmt(day.waistCm)}</td>
        <td class="muted">${(day.dayNote || "‚Äî").slice(0,60)}</td>
        <td>${flags.length ? flags.map(f=>`<span class="tag">${f}</span>`).join("") : '<span class="tag">OK</span>'}</td>
        <td>
          <div class="row">
            <button class="small" data-sync>Sim sync</button>
            <button class="small" data-msg>Message</button>
          </div>
        </td>
      </tr>
    `);

    tr.onclick = (ev) => {
      if (ev.target && ev.target.closest("button")) return;
      state.ui.selectedClientId = c.id; save(state); render();
    };

    tr.querySelector("[data-sync]").onclick = () => {
      ensureClientToday(c);
      c.daily[t].steps = rand(7000, 14000);
      c.daily[t].sleepHrs = rand(6, 8);
      c.daily[t].rhr = rand(50, 64);
      c.daily[t].stressAvg = rand(18, 42);
      c.daily[t].bodyBatteryStart = rand(70, 96);
      c.daily[t].bodyBatteryEnd = rand(15, 58);
      c.daily[t].activeCals = rand(250, 900);
      save(state);
      alert(`Simulated sync for ${c.name}`);
      render();
    };
    tr.querySelector("[data-msg]").onclick = () => {
      state.ui.selectedClientId = c.id;
      state.ui.view = "messages";
      save(state);
      render();
    };


    const genOpen = tr.querySelectorAll("[data-genopen]");
    genOpen.forEach(x=>{
      x.onclick = (ev) => {
        ev.preventDefault?.();
        ev.stopPropagation();
        state.ui.selectedClientId = c.id;
        save(state);
        openGeneticsEditor(state, c.id);
      };
    });

    tbody.appendChild(tr);
  });

  // week view for selected
  function paintWeek(){
    const sel = state.clients.find(x=>x.id===state.ui.selectedClientId) || state.clients[0];
    ensureClientToday(sel);
    const wk = compute7d(sel);

    const kpi = root.querySelector("#weekKPIs");
    kpi.innerHTML = "";
    kpi.appendChild(el(`
      <div class="kpi">
        <div class="box"><div class="muted">Avg sleep</div><div><b>${wk.avgSleep}</b> h</div></div>
        <div class="box"><div class="muted">Avg steps</div><div><b>${wk.avgSteps}</b></div></div>
        <div class="box"><div class="muted">Avg stress</div><div><b>${wk.avgStress}</b></div></div>
        <div class="box"><div class="muted">Avg RHR</div><div><b>${wk.avgRHR}</b></div></div>
        <div class="box"><div class="muted">Workouts</div><div><b>${wk.workouts}</b>/7</div></div>
        <div class="box"><div class="muted">Nutrition</div><div><b>${wk.avgCompliance}</b>%</div></div>
        <div class="box"><div class="muted">Avg weight</div><div><b>${wk.avgWeight ? wk.avgWeight.toFixed(1) : "‚Äî"}</b> kg</div></div>
        <div class="box"><div class="muted">Avg waist</div><div><b>${wk.avgWaist ? wk.avgWaist.toFixed(1) : "‚Äî"}</b> cm</div></div>
      </div>
    `));

    const tbodyW = root.querySelector("#tbodyWeek");
    tbodyW.innerHTML = "";
    wk.days.forEach(d=>{
      tbodyW.appendChild(el(`
        <tr>
          <td><b>${d.date}</b></td>
          <td>${fmt(d.sleepHrs)}h</td>
          <td>${fmt(d.rhr)}</td>
          <td>${fmt(d.stressAvg)}</td>
          <td>${fmt(d.steps)}</td>
          <td>${d.workoutDone ? "Done" : "No"}</td>
          <td>${fmt(d.nutritionCompliancePct)}%</td>
          <td>${fmt(d.bodyWeightKg)}</td>
          <td>${fmt(d.waistCm)}</td>
          <td class="muted">${(d.dayNote || "‚Äî").slice(0,60)}</td>
        </tr>
      `));
    });
  }
  paintWeek();

  // tabs
  const todayCard = root.querySelector("#todayCard");
  const weekCard = root.querySelector("#weekCard");
  const tabBtns = root.querySelectorAll(".tab");
  tabBtns.forEach(btn=>{
    btn.onclick = () => {
      tabBtns.forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      const which = btn.dataset.tab;
      todayCard.style.display = which==="today" ? "" : "none";
      weekCard.style.display = which==="week" ? "" : "none";
      if (which==="week") paintWeek();
    };
  });

  // coach actions
  root.querySelector("#csvBtn").onclick = () => exportTodayCSV(state);
  root.querySelector("#allCsvBtn").onclick = () => exportAllCSV(state);

  root.querySelector("#saveTargetsBtn").onclick = () => {
    const sel = state.clients.find(x=>x.id===state.ui.selectedClientId) || state.clients[0];
    const kcal = Number(root.querySelector("#kcal").value);
    const p = Number(root.querySelector("#p").value);
    const c = Number(root.querySelector("#c").value);
    const f = Number(root.querySelector("#f").value);
    sel.macroTargets.training = { kcal,p,c,f };
    save(state);
    alert("Saved training-day targets (demo).");
    render();
  };
  root.querySelector("#assignTplBtn").onclick = () => {
    const sel = state.clients.find(x=>x.id===state.ui.selectedClientId) || state.clients[0];
    const templateId = root.querySelector("#tplSel").value;
    const tpl = (state.dietTemplates||[]).find(t=>t.id===templateId);
    sel.assignedTemplateId = templateId;

    // copy template into client active plan (so later template edits don't retroactively change clients)
    if (tpl){
      const copiedMeals = JSON.parse(JSON.stringify(tpl.meals||[]));
      const macros = tpl.macros || computeMacrosFromMeals(copiedMeals);
      sel.activeDietPlan = {
        planId: uid(),
        sourceTemplateId: tpl.id,
        name: tpl.name,
        notes: tpl.notes || '',
        macros: JSON.parse(JSON.stringify(macros)),
        meals: copiedMeals,
        assignedAt: Date.now(),
        assignedBy: 'coach',
        updatedAt: Date.now(),
      };
      sel.dietPlanHistory = sel.dietPlanHistory || [];
      sel.dietPlanHistory.push({ planId: sel.activeDietPlan.planId, name: sel.activeDietPlan.name, at: Date.now(), note: 'Assigned template' });

      // keep existing macroTargets UI consistent
      sel.macroTargets = sel.macroTargets || {training:{kcal:0,p:0,c:0,f:0}, rest:{kcal:0,p:0,c:0,f:0}};
      sel.macroTargets.training = JSON.parse(JSON.stringify(sel.activeDietPlan.macros));
    }

    save(state);
    alert("Template assigned (demo).\n\nTip: Client view will now show the copied plan under Active diet plan.");
    render();
  };

  root.querySelector("#manageDietBtn").onclick = () => { state.ui.view = "diet"; save(state); render(); };

  root.querySelector("#editPlanBtn").onclick = () => {
    const sel = state.clients.find(x=>x.id===state.ui.selectedClientId) || state.clients[0];
    openClientDietPlanEditor(state, sel.id);
  };

  root.querySelector("#toClientBtn").onclick = () => { state.ui.view = "client"; save(state); render(); };
  root.querySelector("#toProgressBtn").onclick = () => { state.ui.view = "progress"; save(state); render(); };
  root.querySelector("#toHistoryBtn").onclick = () => { state.ui.view = "history"; save(state); render(); };
  root.querySelector("#toMessagesBtn").onclick = () => { state.ui.view = "messages"; save(state); render(); };

  root.querySelector("#addClientBtn").onclick = () => openClientModal(state, {mode:"add"});
  root.querySelector("#editClientBtn").onclick = () => openClientModal(state, {mode:"edit", clientId: state.ui.selectedClientId});
  
  const genBtn = root.querySelector("#editGeneticsBtn");
  if (genBtn) {
    genBtn.onclick = () => openGeneticsEditor(state, state.ui.selectedClientId);
  }

  root.querySelector("#delClientBtn").onclick = () => {
    const sel = state.clients.find(x=>x.id===state.ui.selectedClientId);
    if (!sel) return;
    if (!confirm(`Delete ${sel.name}?`)) return;
    state.clients = state.clients.filter(c=>c.id!==sel.id);
    state.ui.selectedClientId = state.clients[0]?.id || "";
    save(state);
    render();
  };
  // optional scroll target (used by Today table warning badge)
  if (state.ui && state.ui.scrollTo === "geneticsWarnings") {
    // clear first so repeated renders don't keep jumping
    state.ui.scrollTo = null;
    save(state);
    setTimeout(() => {
      const elw = document.getElementById("geneticsWarnings");
      if (elw) elw.scrollIntoView({ behavior: "smooth", block: "start" });
    }, 0);
  }


  if (state.ui && state.ui.scrollTo === "weeklySchedule") {
    state.ui.scrollTo = null;
    save(state);
    setTimeout(() => {
      const elw = document.getElementById("weeklySchedule");
      if (elw) elw.scrollIntoView({ behavior: "smooth", block: "start" });
    }, 0);
  }

  // genetics form modal
  renderGeneticsModal(state, root);
  // genetics ‚Üí program warnings interactions
  bindProgramWarnings(state, root, selected);
  // adjustment preview modal
  renderAdjustmentModal(state);
  renderCustomFoodModal(state);

}

/** ========= Client view ========= */

function initSessionUI(state, client, root){
  const btnMount = root.querySelector("#sessionBtns");
  const hint = root.querySelector("#sessionHint");
  const recTag = root.querySelector("#recSessionTag");
  const useRec = root.querySelector("#useRecLink");

  if (!btnMount || !hint || !recTag) return;

  const recId = getRecommendedTemplateId(state);
  const rec = recId==="rest" ? null : getTemplateById(state, recId);
  recTag.textContent = rec ? rec.name : "Rest day";
  if (useRec) {
    useRec.style.display = (rec ? "inline" : "none");
    useRec.onclick = (ev) => {
      ev.preventDefault?.();
      if (!rec) return;
      state.ui.selectedWorkoutTemplateId = rec.id;
      const t = getSelectedWorkoutTemplate(state);
      if (t?.exercises?.length) state.ui.selectedExercise = t.exercises[0];
      save(state);
      render();
    };
  }

  btnMount.innerHTML = (state.workoutTemplates||[]).map(t=>{
    const active = (state.ui.selectedWorkoutTemplateId===t.id);
    return `<button class="small" data-wtpl="${t.id}" style="border-radius:999px;${active?"border:2px solid #111;":""}">${t.name}</button>`;
  }).join("");

  const sel = getSelectedWorkoutTemplate(state);
  hint.textContent = sel ? ("Exercises: " + (sel.exercises||[]).slice(0,8).join(", ") + ((sel.exercises||[]).length>8 ? "‚Ä¶" : "")) : "";

  btnMount.querySelectorAll("[data-wtpl]").forEach(b=>{
    b.onclick = (ev) => {
      ev.preventDefault?.();
      const id = b.getAttribute("data-wtpl");
      state.ui.selectedWorkoutTemplateId = id;
      const t = getSelectedWorkoutTemplate(state);
      if (t?.exercises?.length) state.ui.selectedExercise = t.exercises[0];
      save(state);
      render();
    };
  });
}

function viewClient(state){
  const root = document.getElementById("app");
  root.innerHTML = "";

  const clientId = state.ui.selectedClientId || "c1";
  const client = state.clients.find(c=>c.id===clientId) || state.clients[0];
  ensureClientToday(client);

  const t = todayISO();
  const day = client.daily[t];

  const top = el(`
    <div class="row" style="justify-content:space-between;margin-bottom:12px;">
      <div class="row">
        <span class="tag">Client</span>
        <span class="tag">${client.name}</span>
        <span class="tag">${t}</span>
      </div>
      <div class="row">
        <button class="small" id="toCoachBtn">Coach</button>
        <button class="small" id="toProgressBtn">Progress</button>
        <button class="small" id="toHistoryBtn">History</button>
        <button class="small" id="toMsgBtn">Messages</button>
      </div>
    </div>
  `);

  const activePlan = client.activeDietPlan || (state.dietTemplates||[]).find(x=>x.id===client.assignedTemplateId);
  const targets = (activePlan && activePlan.macros) ? activePlan.macros : client.macroTargets.training;

  const left = el(`
    <div class="card">
      <h2>Today‚Äôs targets</h2>
      <div class="kpi">
        <div class="box"><div class="muted">Calories</div><div><b>${targets.kcal}</b> kcal</div></div>
        <div class="box"><div class="muted">Protein</div><div><b>${targets.p}</b> g</div></div>
        <div class="box"><div class="muted">Carbs</div><div><b>${targets.c}</b> g</div></div>
        <div class="box"><div class="muted">Fat</div><div><b>${targets.f}</b> g</div></div>
      </div>

      <label style="margin-top:12px;">Nutrition compliance (%)</label>
      <input id="comp" type="number" min="0" max="100" value="${day.nutritionCompliancePct}" />

      <hr class="hr">

      <h3>Body metrics</h3>
      <div class="row">
        <input id="bw" style="max-width:160px" placeholder="Bodyweight (kg)" value="${day.bodyWeightKg ?? ""}" />
        <input id="waist" style="max-width:160px" placeholder="Waist (cm)" value="${day.waistCm ?? ""}" />
      </div>

      <label>Daily note</label>
      <textarea id="dayNote" placeholder="Energy, digestion, stressors, anything notable...">${day.dayNote ?? ""}</textarea>

      <button class="primary" id="saveDailyBtn" style="margin-top:10px;">Save today</button>

      <hr class="hr">

      <h3>Daily check-in (1‚Äì10)</h3>
      <div class="row">
        <input id="sore" style="max-width:110px" value="${day.selfReport.soreness}" />
        <input id="mood" style="max-width:110px" value="${day.selfReport.mood}" />
        <input id="ener" style="max-width:110px" value="${day.selfReport.energy}" />
        <input id="dig"  style="max-width:110px" value="${day.selfReport.digestion}" />
      </div>
      <div class="muted">Soreness / Mood / Energy / Digestion</div>
      <button id="saveCheckBtn" style="margin-top:10px;">Save check-in</button>

      <hr class="hr">
      <div class="muted">Constraints: <b>${client.profile.constraints.join(", ") || "‚Äî"}</b></div>
    </div>
  `);

  const right = el(`
    <div class="card">
      <h2>Diet plan (optional)</h2>
      <p class="muted">${activePlan ? activePlan.name : "No plan assigned yet."} ${activePlan && activePlan.sourceTemplateId ? "‚Ä¢ from template" : ""}</p>
      <div id="tplArea"></div>

      <hr class="hr">

      <h2>üß¨ Genetic insights</h2>
      <div class="row">
        ${((client.genetics?.performance?.fastTwitchBias || "Not assessed") === "Not assessed" &&
           (client.genetics?.nutrition?.carbTolerance || "Not assessed") === "Not assessed")
          ? '<span class="tag attn">Genetics not assessed</span>'
          : ''}
      </div>
      <div class="card" style="border-radius:12px;">
        <b>Training</b>
        <div class="row" style="margin-top:6px;">
          <span class="tag">${client.genetics?.performance?.fastTwitchBias || "Not assessed"}</span>
          <span class="tag">${client.genetics?.performance?.recoverySpeed || "Not assessed"} recovery</span>
        </div>
        <div class="muted" style="margin-top:6px;">Injury risk: ${(client.genetics?.performance?.injuryRisk||[]).join(", ") || "‚Äî"}</div>
        ${client.genetics?.performance?.notes ? '<div class="muted" style="margin-top:6px;">' + client.genetics.performance.notes + '</div>' : ""}
        <hr class="hr">
        <b>Nutrition</b>
        <div class="row" style="margin-top:6px;">
          <span class="tag">Carbs: ${client.genetics?.nutrition?.carbTolerance || "Not assessed"}</span>
          <span class="tag">Fat: ${client.genetics?.nutrition?.fatTolerance || "Not assessed"}</span>
          <span class="tag">Protein: ${client.genetics?.nutrition?.proteinRequirement || "Not assessed"}</span>
        </div>
        ${client.genetics?.nutrition?.notes ? '<div class="muted" style="margin-top:6px;">' + client.genetics.nutrition.notes + '</div>' : ""}
        <div class="hint" style="margin-top:8px;">Genetics indicate predisposition, not prescription.</div>
      </div>

      <hr class="hr">

      <h2>ü§î Why this plan?</h2>
      <div class="card" style="border-radius:12px;">
        ${explainWhyThisPlan(state, client).map(l=>`<div class="muted">‚Ä¢ ${l}</div>`).join("")}
      </div>

      <hr class="hr">

      
      <hr class="hr">

      <h2>üèãÔ∏è Session selection</h2>
      <div class="card" style="border-radius:12px;">
        <b>Today's recommended session</b>
        <div class="row" style="margin-top:8px;gap:8px;flex-wrap:wrap;align-items:center;">
          <span class="tag" id="recSessionTag">‚Äî</span>
          <a href="#" class="hint" id="useRecLink" style="text-decoration:none;">Use recommended</a>
        </div>
        <div class="muted" style="margin-top:8px;">Pick the session you are doing today.</div>

        <hr class="hr">

        <b>Select today‚Äôs session</b>
        <div class="row" id="sessionBtns" style="margin-top:10px;gap:8px;flex-wrap:wrap;"></div>
        <div class="hint" id="sessionHint" style="margin-top:8px;"></div>
      </div>

<h2>Workout logging</h2>
      <p class="muted">Log sets/reps/weight. PR + History update automatically.</p>
      <div id="wArea"></div>
    </div>
  `);

  root.appendChild(top);
  const grid = el(`<div class="split"></div>`);
  grid.appendChild(left);
  grid.appendChild(right);
  root.appendChild(grid);

  // template
  const tplArea = root.querySelector("#tplArea");
  if (!activePlan){
    tplArea.appendChild(el(`<div class="card warn" style="border-radius:12px;"><b>No diet plan</b><div class="muted">You can still follow macro targets.</div></div>`));
  } else {
    (activePlan.meals||[]).forEach(m=>{
      let kcal=0,p=0,c=0,f=0;
      m.items.forEach(i=>{kcal+=i.kcal;p+=i.p;c+=i.c;f+=i.f;});
      tplArea.appendChild(el(`
        <div class="card" style="border-radius:12px;margin:10px 0;">
          <b>${m.slot}</b>
          <div class="muted">${m.items.map(i=>`${i.food} (${i.kcal}kcal)`).join(" ‚Ä¢ ")}</div>
          <div class="row" style="margin-top:6px;">
            <span class="tag">${kcal} kcal</span>
            <span class="tag">P ${p}</span>
            <span class="tag">C ${c}</span>
            <span class="tag">F ${f}</span>
          </div>
        </div>
      `));
    });
  }

  // workout logger
  const wArea = root.querySelector("#wArea");
  const plan = state.workoutTemplates;
  const dayIdx = (new Date()).getDay();
  const mapped = {1:"Mon",2:"Tue",3:"Wed",4:"Thu",5:"Fri"};
  const dow = mapped[dayIdx] || "Mon";
  const session = plan.find(p=>p.day===dow) || plan[0];

  const logKey = t;
  state.workoutLogs[logKey] = state.workoutLogs[logKey] || {};
  state.workoutLogs[logKey][client.id] = state.workoutLogs[logKey][client.id] || {};

  wArea.appendChild(el(`<div class="tag">Today: ${session.day} ‚Ä¢ ${session.name}</div>`));

  // session PRs block
  const prSpot = el(`
    <div class="card" style="border-radius:12px;margin-top:10px;">
      <b>Session best (today)</b>
      <div class="muted">Updates when you save sets. (Epley e1RM)</div>
      <div id="sessionPRs" class="row" style="margin-top:6px;"></div>
    </div>
  `);
  wArea.appendChild(prSpot);

  function renderSessionPRs(){
    const wrap = prSpot.querySelector("#sessionPRs");
    wrap.innerHTML = "";
    const sPRs = computeTodaysPRs(state, client.id, t);
    if (!sPRs.length){
      wrap.appendChild(el(`<span class="tag">No sets saved yet</span>`));
      return;
    }
    sPRs.slice(0, 8).forEach(p=>{
      wrap.appendChild(el(`<span class="tag">${p.exercise}: e1RM ${p.bestE1rm.toFixed(1)} (${p.bestSet})</span>`));
    });
  }
  renderSessionPRs();

  session.exercises.forEach(ex=>{
    const sets = state.workoutLogs[logKey][client.id][ex] || [{reps:"",weight:""}];
    const block = el(`
      <div class="card" style="border-radius:12px;margin-top:10px;">
        <b>${ex}</b>
        <div class="muted">Sets</div>
        <div class="sets"></div>
        <div class="row" style="margin-top:8px;">
          <button class="small" data-add>Add set</button>
          <button class="small" data-save>Save</button>
          <button class="small" data-history>History</button>
        </div>
      </div>
    `);
    const setsDiv = block.querySelector(".sets");

    function renderSets(){
      setsDiv.innerHTML = "";
      sets.forEach((s, idx)=>{
        const line = el(`
          <div class="row" style="margin-top:6px;">
            <span class="tag">#${idx+1}</span>
            <input style="max-width:110px" placeholder="reps" value="${s.reps}">
            <input style="max-width:140px" placeholder="weight" value="${s.weight}">
            <button class="small" data-del>Delete</button>
          </div>
        `);
        line.querySelector("[data-del]").onclick = () => { sets.splice(idx,1); if(!sets.length) sets.push({reps:"",weight:""}); renderSets(); };
        setsDiv.appendChild(line);
      });
    }

    block.querySelector("[data-add]").onclick = () => { sets.push({reps:"",weight:""}); renderSets(); };
    block.querySelector("[data-save]").onclick = () => {
      const rows = setsDiv.querySelectorAll(".row");
      const newSets = [];
      rows.forEach(r=>{
        const inputs = r.querySelectorAll("input");
        newSets.push({ reps: inputs[0].value, weight: inputs[1].value });
      });
      state.workoutLogs[logKey][client.id][ex] = newSets;
      client.daily[t].workoutDone = true;
      client.daily[t].workoutMins = 45;
      save(state);
      renderSessionPRs();
      alert("Saved workout sets (demo).");
    };
    block.querySelector("[data-history]").onclick = () => {
      state.ui.selectedExercise = ex;
      state.ui.view = "history";
      save(state);
      render();
    };

    renderSets();
    wArea.appendChild(block);
  });

  // save today (weight/waist/note + compliance)
  root.querySelector("#saveDailyBtn").onclick = () => {
    client.daily[t].nutritionCompliancePct = clamp(Number(root.querySelector("#comp").value), 0, 100);
    client.daily[t].bodyWeightKg = root.querySelector("#bw").value.trim();
    client.daily[t].waistCm = root.querySelector("#waist").value.trim();
    client.daily[t].dayNote = root.querySelector("#dayNote").value.trim();
    save(state);
    alert("Saved today (demo).");
  };

  // save check-in
  root.querySelector("#saveCheckBtn").onclick = () => {
    client.daily[t].selfReport = {
      soreness: Number(root.querySelector("#sore").value),
      mood: Number(root.querySelector("#mood").value),
      energy: Number(root.querySelector("#ener").value),
      digestion: Number(root.querySelector("#dig").value)
    };
    save(state);
    alert("Saved check-in (demo).");
  };

  root.querySelector("#toCoachBtn").onclick = () => { state.ui.view = "coach"; save(state); render(); };
  root.querySelector("#toProgressBtn").onclick = () => { state.ui.view = "progress"; save(state); render(); };
  root.querySelector("#toHistoryBtn").onclick = () => { state.ui.view = "history"; save(state); render(); };
  root.querySelector("#toMsgBtn").onclick = () => { state.ui.view = "messages"; save(state); render(); };
}

/** ========= Progress view ========= */
function viewProgress(state){
  const root = document.getElementById("app");
  root.innerHTML = "";

  const clientId = state.ui.selectedClientId || "c1";
  const client = state.clients.find(c=>c.id===clientId) || state.clients[0];
  ensureClientToday(client);

  const t = todayISO();
  const last14 = [];
  for (let i=0;i<14;i++){
    const d = addDays(t, -i);
    last14.push({ date:d, ...(client.daily[d] || {}) });
  }

  const wk = compute7d(client);

  function delta(a,b){
    if (a===null || a===undefined || b===null || b===undefined) return "‚Äî";
    const diff = a-b;
    const s = diff>0 ? "+" : "";
    return `${s}${diff.toFixed(1)}`;
  }
  const today = client.daily[t];
  const sevenAgo = client.daily[addDays(t,-7)] || {};

  root.appendChild(el(`
    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div class="row">
          <span class="tag">Progress</span>
          <span class="tag">${client.name}</span>
          <span class="tag">Today: ${t}</span>
        </div>
        <div class="row">
          <button class="small" id="exportJson">Backup JSON</button>
          <button class="small" id="exportAllCsv">Export All CSV</button>
          <label class="row" style="margin:0;gap:6px;">
            <input id="importFile" type="file" accept=".json" style="width:auto;">
            <span class="muted">Restore JSON</span>
          </label>
          <button class="small" id="toCoach">Coach</button>
          <button class="small" id="toClient">Client</button>
          <button class="small" id="toHistory">History</button>
        </div>
      </div>

      <hr class="hr">

      <h2>Weekly snapshot</h2>
      <div class="kpi">
        <div class="box"><div class="muted">Avg weight (7d)</div><div><b>${wk.avgWeight ? wk.avgWeight.toFixed(1) : "‚Äî"}</b> kg</div></div>
        <div class="box"><div class="muted">Avg waist (7d)</div><div><b>${wk.avgWaist ? wk.avgWaist.toFixed(1) : "‚Äî"}</b> cm</div></div>
        <div class="box"><div class="muted">Weight change (7d)</div><div><b>${delta((today?.bodyWeightKg!==""?Number(today?.bodyWeightKg):null), (sevenAgo?.bodyWeightKg!==""?Number(sevenAgo?.bodyWeightKg):null))}</b> kg</div></div>
        <div class="box"><div class="muted">Waist change (7d)</div><div><b>${delta((today?.waistCm!==""?Number(today?.waistCm):null), (sevenAgo?.waistCm!==""?Number(sevenAgo?.waistCm):null))}</b> cm</div></div>
        <div class="box"><div class="muted">Avg nutrition</div><div><b>${wk.avgCompliance}</b>%</div></div>
        <div class="box"><div class="muted">Workouts</div><div><b>${wk.workouts}</b>/7</div></div>
      </div>

      <hr class="hr">

      <h2>Personal Records (estimated 1RM)</h2>
      <p class="muted">Calculated from your logged sets (Epley). Click an exercise to open history.</p>
      <div class="tablewrap">
        <table>
          <thead>
            <tr>
              <th>Exercise</th>
              <th>Best set</th>
              <th>Estimated 1RM</th>
              <th>Date</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="prTable"></tbody>
        </table>
      </div>

      <hr class="hr">

      <h2>Last 14 days</h2>
      <div class="tablewrap">
        <table>
          <thead>
            <tr>
              <th>Date</th><th>Weight</th><th>Waist</th><th>Sleep</th><th>Steps</th><th>Nutrition%</th><th>Workout</th><th>Check-in</th><th>Note</th>
            </tr>
          </thead>
          <tbody id="p14"></tbody>
        </table>
      </div>

      <p class="hint">Tip: Use Backup JSON weekly so you never lose progress if browser storage clears.</p>
    </div>
  `));

  // PR table
  const prBody = root.querySelector("#prTable");
  const prs = computePRsForClient(state, client.id);
  if (!prs.length){
    prBody.appendChild(el(`<tr><td colspan="5" class="muted">No PRs yet ‚Äî log a workout (sets/reps/weight) to populate this.</td></tr>`));
  } else {
    prs.slice(0, 40).forEach(pr=>{
      const tr = el(`
        <tr style="cursor:pointer;">
          <td><b>${pr.exercise}</b></td>
          <td>${pr.bestSet}</td>
          <td><b>${pr.bestE1rm.toFixed(1)}</b></td>
          <td class="muted">${pr.date}</td>
          <td><button class="small" data-open>Open history</button></td>
        </tr>
      `);
      tr.onclick = (ev)=>{
        if (ev.target && ev.target.closest("button")) return;
        state.ui.selectedExercise = pr.exercise;
        state.ui.view = "history";
        save(state);
        render();
      };
      tr.querySelector("[data-open]").onclick = ()=>{
        state.ui.selectedExercise = pr.exercise;
        state.ui.view = "history";
        save(state);
        render();
      };
      prBody.appendChild(tr);
    });
  }

  // last 14
  const tbody = root.querySelector("#p14");
  last14.forEach(d=>{
    tbody.appendChild(el(`
      <tr>
        <td><b>${d.date}</b></td>
        <td>${fmt(d.bodyWeightKg)}</td>
        <td>${fmt(d.waistCm)}</td>
        <td>${fmt(d.sleepHrs)}h</td>
        <td>${fmt(d.steps)}</td>
        <td>${fmt(d.nutritionCompliancePct)}%</td>
        <td>${d.workoutDone ? "Done":"No"}</td>
        <td class="muted">S:${fmt(d.selfReport?.soreness)} M:${fmt(d.selfReport?.mood)} E:${fmt(d.selfReport?.energy)} D:${fmt(d.selfReport?.digestion)}</td>
        <td class="muted">${(d.dayNote || "‚Äî").slice(0,80)}</td>
      </tr>
    `));
  });

  root.querySelector("#exportJson").onclick = () => exportBackupJSON(state);
  root.querySelector("#exportAllCsv").onclick = () => exportAllCSV(state);
  root.querySelector("#importFile").onchange = (e) => {
    const f = e.target.files?.[0];
    if (f) importBackupJSON(f);
  };
  root.querySelector("#toCoach").onclick = () => { state.ui.view="coach"; save(state); render(); };
  root.querySelector("#toClient").onclick = () => { state.ui.view="client"; save(state); render(); };
  root.querySelector("#toHistory").onclick = () => { state.ui.view="history"; save(state); render(); };
}

/** ========= History view (exercise history) ========= */
function viewHistory(state){
  const root = document.getElementById("app");
  root.innerHTML = "";

  const clientId = state.ui.selectedClientId || "c1";
  const client = state.clients.find(c=>c.id===clientId) || state.clients[0];
  ensureClientToday(client);

  const exercises = listExercisesForClient(state, client.id);
  if (!exercises.length){
    root.appendChild(el(`
      <div class="card">
        <h2>Exercise History</h2>
        <p class="muted">No logged workouts yet. Log sets/reps/weight in Client view.</p>
        <div class="row">
          <button class="small" id="toClient">Client</button>
          <button class="small" id="toProgress">Progress</button>
          <button class="small" id="toCoach">Coach</button>
        </div>
      </div>
    `));
    root.querySelector("#toClient").onclick = () => { state.ui.view="client"; save(state); render(); };
    root.querySelector("#toProgress").onclick = () => { state.ui.view="progress"; save(state); render(); };
    root.querySelector("#toCoach").onclick = () => { state.ui.view="coach"; save(state); render(); };
    return;
  }

  // pick current selected exercise
  const selEx = exercises.includes(state.ui.selectedExercise) ? state.ui.selectedExercise : exercises[0];
  state.ui.selectedExercise = selEx;
  save(state);

  const history = computeExerciseHistory(state, client.id, selEx);
  const prs = computePRsForClient(state, client.id);
  const prMatch = prs.find(p=>p.exercise===selEx);

  const last = history[0];
  const prev = history[1];
  const trend = (last && prev) ? (last.bestE1rm - prev.bestE1rm) : null;

  root.appendChild(el(`
    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div class="row">
          <span class="tag">History</span>
          <span class="tag">${client.name}</span>
        </div>
        <div class="row">
          <button class="small" id="toClient">Client</button>
          <button class="small" id="toProgress">Progress</button>
          <button class="small" id="toCoach">Coach</button>
        </div>
      </div>

      <hr class="hr">

      <div class="split">
        <div>
          <h2>Exercise</h2>
          <label>Select exercise</label>
          <select id="exSel">
            ${exercises.map(x=>`<option value="${x}" ${x===selEx?"selected":""}>${x}</option>`).join("")}
          </select>
          <div class="hint">History uses your logged sets to compute ‚Äúbest e1RM per day‚Äù (Epley).</div>
        </div>
        <div>
          <h2>Quick stats</h2>
          <div class="kpi">
            <div class="box"><div class="muted">PR e1RM</div><div><b>${prMatch ? prMatch.bestE1rm.toFixed(1) : "‚Äî"}</b></div></div>
            <div class="box"><div class="muted">PR set</div><div><b>${prMatch ? prMatch.bestSet : "‚Äî"}</b></div></div>
            <div class="box"><div class="muted">Last session</div><div><b>${last ? last.bestE1rm.toFixed(1) : "‚Äî"}</b></div></div>
            <div class="box"><div class="muted">Trend (vs prior)</div><div><b>${trend===null ? "‚Äî" : (trend>=0?"+":"") + trend.toFixed(1)}</b></div></div>
          </div>
        </div>
      </div>

      <hr class="hr">

      <h2>Last sessions</h2>
      <div class="tablewrap">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Best set</th>
              <th>Best e1RM</th>
              <th>Sets logged</th>
            </tr>
          </thead>
          <tbody id="histBody"></tbody>
        </table>
      </div>

      <p class="hint">Tip: in Client ‚Üí Workout logging, press <b>History</b> next to an exercise to jump here.</p>
    </div>
  `));

  const histBody = root.querySelector("#histBody");
  if (!history.length){
    histBody.appendChild(el(`<tr><td colspan="4" class="muted">No history for this exercise yet.</td></tr>`));
  } else {
    history.slice(0, 20).forEach(h=>{
      histBody.appendChild(el(`
        <tr>
          <td><b>${h.date}</b></td>
          <td>${h.bestSet}</td>
          <td><b>${h.bestE1rm.toFixed(1)}</b></td>
          <td class="muted">${h.setCount}</td>
        </tr>
      `));
    });
  }

  root.querySelector("#exSel").onchange = (e)=>{
    state.ui.selectedExercise = e.target.value;
    save(state);
    render();
  };
  root.querySelector("#toClient").onclick = () => { state.ui.view="client"; save(state); render(); };
  root.querySelector("#toProgress").onclick = () => { state.ui.view="progress"; save(state); render(); };
  root.querySelector("#toCoach").onclick = () => { state.ui.view="coach"; save(state); render(); };
}

/** ========= Messages view ========= */
function viewMessages(state){
  const root = document.getElementById("app");
  root.innerHTML = "";

  const clientId = state.ui.selectedClientId || "c1";
  const client = state.clients.find(c=>c.id===clientId) || state.clients[0];

  const header = el(`
    <div class="row" style="justify-content:space-between;margin-bottom:12px;">
      <div class="row">
        <span class="tag">Messages</span>
        <span class="tag">Thread: Coach ‚Üî ${client.name}</span>
      </div>
      <div class="row">
        <button class="small" id="backBtn">Back</button>
      </div>
    </div>
  `);

  const card = el(`
    <div class="card">
      <div id="msgs" style="display:flex;flex-direction:column;gap:8px;"></div>
      <div class="row" style="margin-top:10px;">
        <input id="msgInput" placeholder="Type a message..." />
        <button class="primary" id="sendBtn">Send</button>
      </div>
    </div>
  `);

  root.appendChild(header);
  root.appendChild(card);

  function displayNameForSender(id){
    const u = state.users.find(x=>x.id===id);
    if (u) return u.name;
    if (id===client.id) return client.name;
    if (id==="u1") return "Coach (Demo)";
    return "User";
  }

  function renderMsgs(){
    const box = card.querySelector("#msgs");
    box.innerHTML = "";
    state.messages
      .slice()
      .sort((a,b)=>a.at.localeCompare(b.at))
      .filter(m => (m.to===client.id || m.from===client.id))
      .forEach(m=>{
        const mine = m.from===state.session.userId;
        box.appendChild(el(`
          <div class="card ${mine?'ok':'warn'}" style="border-radius:12px;margin:0;align-self:${mine?'flex-end':'flex-start'};max-width:78%;">
            <div class="muted" style="font-size:12px;"><b>${displayNameForSender(m.from)}</b> ‚Ä¢ ${new Date(m.at).toLocaleString()}</div>
            <div>${m.text}</div>
          </div>
        `));
      });
  }
  renderMsgs();

  card.querySelector("#sendBtn").onclick = () => {
    const text = card.querySelector("#msgInput").value.trim();
    if (!text) return;
    state.messages.push({ id:"m"+(state.messages.length+1), from:state.session.userId, to:client.id, at:new Date().toISOString(), text });
    card.querySelector("#msgInput").value = "";
    save(state);
    renderMsgs();
  };

  header.querySelector("#backBtn").onclick = () => { state.ui.view = "coach"; save(state); render(); };
}

/** ========= Client add/edit modal ========= */
function openClientModal(state, {mode, clientId}){
  const existing = mode==="edit" ? state.clients.find(c=>c.id===clientId) : null;

  const overlay = el(`
    <div style="position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;padding:16px;z-index:50;">
      <div class="card" style="max-width:720px;width:100%;">
        <h2>${mode==="add" ? "Add client" : "Edit client"}</h2>
        <div class="split">
          <div>
            <label>Name</label>
            <input id="name" value="${existing?.name || ""}" placeholder="e.g., Luke Abbey" />
            <label>Email</label>
            <input id="email" value="${existing?.email || ""}" placeholder="e.g., luke@example.com" />
            <label>Notes</label>
            <textarea id="notes" placeholder="Goals, injuries, key context...">${existing?.profile?.notes || ""}</textarea>
          </div>
          <div>
            <label>Constraints (comma separated)</label>
            <input id="constraints" value="${(existing?.profile?.constraints || []).join(", ")}" placeholder="e.g., coeliac, dairy_free" />
            <label>Age</label>
            <input id="age" type="number" value="${existing?.profile?.age || 30}" />
            <label>Height (cm)</label>
            <input id="height" type="number" value="${existing?.profile?.heightCm || 170}" />
            <label>Weight (kg)</label>
            <input id="weight" type="number" value="${existing?.profile?.weightKg || 70}" />
          </div>
        </div>
        <div class="row" style="justify-content:flex-end;margin-top:10px;">
          <button id="cancel">Cancel</button>
          <button class="primary" id="save">${mode==="add" ? "Add" : "Save"}</button>
        </div>
      </div>
    </div>
  `);

  overlay.querySelector("#cancel").onclick = () => overlay.remove();
  overlay.querySelector("#save").onclick = () => {
    const name = overlay.querySelector("#name").value.trim();
    const email = overlay.querySelector("#email").value.trim().toLowerCase();
    if (!name || !email) return alert("Name + email required.");
    const notes = overlay.querySelector("#notes").value.trim();
    const constraints = overlay.querySelector("#constraints").value.split(",").map(s=>s.trim()).filter(Boolean);

    const age = Number(overlay.querySelector("#age").value) || 30;
    const heightCm = Number(overlay.querySelector("#height").value) || 170;
    const weightKg = Number(overlay.querySelector("#weight").value) || 70;

    if (mode==="add"){
      const newId = "c" + (Math.max(0, ...state.clients.map(c=>Number(c.id.slice(1))||0)) + 1);
      const c = seedClient(newId, name, email, notes, constraints);
      c.profile.age = age; c.profile.heightCm = heightCm; c.profile.weightKg = weightKg;
      state.clients.push(c);
      state.ui.selectedClientId = c.id;
    } else {
      existing.name = name;
      existing.email = email;
      existing.profile.notes = notes;
      existing.profile.constraints = constraints;
      existing.profile.age = age;
      existing.profile.heightCm = heightCm;
      existing.profile.weightKg = weightKg;
    }

    save(state);
    overlay.remove();
    render();
  };

  document.body.appendChild(overlay);
}



/** ========= Diet templates + Diet plan editing ========= */
function uid(){
  try{ return crypto.randomUUID(); } catch(e){
    return 'id_' + Math.random().toString(16).slice(2) + '_' + Date.now();
  }
}
function deepCopy(obj){ return JSON.parse(JSON.stringify(obj)); }
function computeMacrosFromMeals(meals){
  let kcal=0,p=0,c=0,f=0;
  (meals||[]).forEach(m=>{
    (m.items||[]).forEach(i=>{
      kcal += Number(i.kcal)||0;
      p += Number(i.p)||0;
      c += Number(i.c)||0;
      f += Number(i.f)||0;
    });
  });
  return {kcal: Math.round(kcal), p: Math.round(p), c: Math.round(c), f: Math.round(f)};
}
function normalizeDietTemplate(tpl){
  const t = tpl || {};
  t.id = t.id || uid();
  t.name = t.name || 'Untitled template';
  t.notes = t.notes || '';
  t.meals = Array.isArray(t.meals) ? t.meals : [];
  t.macros = t.macros || computeMacrosFromMeals(t.meals);
  t.updatedAt = t.updatedAt || Date.now();
  return t;
}

function exportDietTemplates(state){
  downloadText(`diet-templates-${todayISO()}.json`, JSON.stringify(state.dietTemplates || [], null, 2));
}
function importDietTemplatesFromFile(file, state){
  const r = new FileReader();
  r.onload = () => {
    try{
      const parsed = JSON.parse(r.result);
      const arr = Array.isArray(parsed) ? parsed : (parsed?.dietTemplates || parsed?.templates || []);
      if (!Array.isArray(arr)) throw new Error('Not an array');
      state.dietTemplates = state.dietTemplates || [];
      arr.forEach(x=> state.dietTemplates.push(normalizeDietTemplate(x)));
      save(state);
      alert(`Imported ${arr.length} template(s).`);
      render();
    } catch(e){
      alert('Could not import. Please upload a JSON array of diet templates.');
    }
  };
  r.readAsText(file);
}

function openDietTemplateEditor(state, {templateId}={}){
  state.dietTemplates = state.dietTemplates || [];
  const isEdit = !!templateId;
  const existing = isEdit ? state.dietTemplates.find(t=>t.id===templateId) : null;
  const working = normalizeDietTemplate(deepCopy(existing || { id: uid(), name:'', notes:'', macros:{kcal:'',p:'',c:'',f:''}, meals:[] }));

  const overlay = el(`
    <div style="position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;padding:16px;z-index:999;">
      <div class="card" style="max-width:980px;width:100%;max-height:85vh;overflow:auto;">
        <h2>${isEdit ? 'Edit diet template' : 'New diet template'}</h2>
        <p class="muted">Edit name/macros/notes. Meals are edited as JSON for speed (you can paste from ChatGPT or spreadsheets).</p>

        <label>Name</label>
        <input id="dt_name" value="${(working.name||'').replaceAll('"','&quot;')}" />

        <label>Notes</label>
        <textarea id="dt_notes">${working.notes||''}</textarea>

        <div class="split" style="margin-top:10px;">
          <div>
            <h3>Macros</h3>
            <div class="row">
              <input id="dt_kcal" style="max-width:140px" placeholder="kcal" value="${working.macros?.kcal ?? ''}" />
              <input id="dt_p" style="max-width:140px" placeholder="protein" value="${working.macros?.p ?? ''}" />
              <input id="dt_c" style="max-width:140px" placeholder="carbs" value="${working.macros?.c ?? ''}" />
              <input id="dt_f" style="max-width:140px" placeholder="fat" value="${working.macros?.f ?? ''}" />
            </div>
            <div class="hint">Tip: leave blank and click ‚ÄúAuto-calc from meals‚Äù if your meals include kcal/P/C/F.</div>
            <button class="small" id="dt_autocalc" style="margin-top:8px;">Auto-calc from meals</button>
          </div>
          <div>
            

<h3>Meals</h3>
<div class="hint">Add meal slots and items. Enter calories + macros manually (no JSON needed).</div>

<div class="card" style="border-radius:14px;margin-top:10px;">
  <b>üçé Food library</b>
  <div class="hint" style="margin-top:6px;">Search once and click to add an item into a meal.</div>
  <div class="row" style="gap:8px;flex-wrap:wrap;margin-top:10px;align-items:center;">
    <button class="small" id="addCustomFoodBtn">+ Add custom food</button>
    <input id="foodSearch" placeholder="Search foods (e.g. chicken, rice, yogurt)" style="min-width:240px;flex:1;">
    <select id="foodCat" style="max-width:200px;">
      <option value="All">All categories</option>
      <option value="Protein">Protein</option>
      <option value="Carb">Carb</option>
      <option value="Fat">Fat</option>
      <option value="Veg">Veg</option>
      <option value="General">Other</option>
    </select>
    <select id="foodMealTarget" style="max-width:220px;">
      <option value="0">Add to: first meal</option>
    </select>
  </div>
  <div id="foodResults" style="margin-top:10px;"></div>
  <div id="customFoodsList" style="margin-top:12px;"></div>
</div>

<div id="dt_meals_ui" style="margin-top:10px;"></div>

<div class="row" style="margin-top:10px;gap:10px;flex-wrap:wrap;">
  <button class="small" id="dt_add_meal">+ Add meal slot</button>
  <button class="small" id="dt_sync_json">Sync to JSON</button>
  <label class="row" style="margin:0;gap:8px;align-items:center;">
    <input type="checkbox" id="dt_show_json" />
    <span class="muted">Show advanced JSON</span>
  </label>
</div>

<div id="dt_json_wrap" style="display:none;margin-top:10px;">
  <div class="hint">Advanced: you can still paste JSON here if you want. Editing below updates the UI when you click ‚ÄúSync from JSON‚Äù.</div>
  <textarea id="dt_meals" style="min-height:220px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace;white-space:pre;">${JSON.stringify(working.meals||[], null, 2)}</textarea>
  <div class="row" style="gap:10px;flex-wrap:wrap;margin-top:8px;">
    <button class="small" id="dt_sync_from_json">Sync from JSON</button>
  </div>
</div>


        <div class="row" style="justify-content:flex-end;margin-top:10px;">
          <button id="dt_cancel">Cancel</button>
          <button class="primary" id="dt_save">Save</button>
        </div>
      </div>
    </div>
  `);



  // ----- Meals UI builder (no JSON required) -----
  function sanitizeNum(v){
    const n = Number(v);
    return isFinite(n) ? n : 0;
  }
  function renderMealsUI(meals){
    const mount = overlay.querySelector('#dt_meals_ui');
    if (!mount) return;

    const safeMeals = (meals||[]).map(m=>({ slot: m.slot || '', items: (m.items||[]).map(it=>({
      food: it.food||'', kcal: sanitizeNum(it.kcal), p: sanitizeNum(it.p), c: sanitizeNum(it.c), f: sanitizeNum(it.f)
    })) }));

    mount.innerHTML = safeMeals.map((m, mi)=>{
      const items = m.items || [];
      const rows = items.map((it, ii)=>`
        <div class="row" style="gap:8px;flex-wrap:wrap;align-items:center;margin-top:8px;">
          <input list="foodLibList" data-mi="${mi}" data-ii="${ii}" data-k="food" placeholder="Food item (type to search)" value="${esc(it.food)}" style="min-width:220px;flex:1;">
          <input data-mi="${mi}" data-ii="${ii}" data-k="kcal" placeholder="kcal" value="${esc(it.kcal)}" style="max-width:110px;">
          <input data-mi="${mi}" data-ii="${ii}" data-k="p" placeholder="P" value="${esc(it.p)}" style="max-width:90px;">
          <input data-mi="${mi}" data-ii="${ii}" data-k="c" placeholder="C" value="${esc(it.c)}" style="max-width:90px;">
          <input data-mi="${mi}" data-ii="${ii}" data-k="f" placeholder="F" value="${esc(it.f)}" style="max-width:90px;">
          <button class="small" data-fill-item="${mi}:${ii}">Fill</button>
          <button class="small" data-copy-item="${mi}:${ii}">Copy</button>
          <button class="small" data-remove-item="${mi}:${ii}">Remove</button>
        </div>
      `).join("");

      return `
        <div class="card" style="border-radius:14px;margin-top:10px;">
          <div class="row" style="justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap;">
            <div class="row" style="gap:10px;align-items:center;flex-wrap:wrap;flex:1;">
              <b style="min-width:90px;">Meal slot</b>
              <input data-mi="${mi}" data-k="slot" placeholder="e.g. Breakfast" value="${esc(m.slot)}" style="min-width:220px;flex:1;">
            </div>
            <div class="row" style="gap:8px;flex-wrap:wrap;">
              <button class="small" data-add-item="${mi}">+ Add item</button>
              <button class="small" data-remove-meal="${mi}">Remove meal</button>
            </div>
          </div>
          ${rows || '<div class="hint" style="margin-top:10px;">No items yet.</div>'}
        </div>
      `;
    }).join("") + (safeMeals.length ? "" : '<div class="hint">No meals yet. Click ‚ÄúAdd meal slot‚Äù.</div>');

    // wire buttons
    mount.querySelectorAll('[data-add-item]').forEach(btn=>{
      btn.onclick = () => {
        const mi = Number(btn.getAttribute('data-add-item'));
        working.meals = working.meals || [];
        working.meals[mi] = working.meals[mi] || {slot:'', items:[]};
        working.meals[mi].items = working.meals[mi].items || [];
        working.meals[mi].items.push({food:'',kcal:0,p:0,c:0,f:0});
        renderMealsUI(working.meals);
        refreshMealTargetOptions();
        renderFoodLibrary();
        syncJsonFromWorking(true);
      };
    });
    mount.querySelectorAll('[data-remove-meal]').forEach(btn=>{
      btn.onclick = () => {
        const mi = Number(btn.getAttribute('data-remove-meal'));
        working.meals = (working.meals||[]).filter((_,i)=>i!==mi);
        renderMealsUI(working.meals);
        refreshMealTargetOptions();
        renderFoodLibrary();
        syncJsonFromWorking(true);
      };
    });
    mount.querySelectorAll('[data-remove-item]').forEach(btn=>{
      btn.onclick = () => {
        const [mi,ii] = btn.getAttribute('data-remove-item').split(':').map(Number);
        if (!working.meals || !working.meals[mi]) return;
        working.meals[mi].items = (working.meals[mi].items||[]).filter((_,i)=>i!==ii);
        renderMealsUI(working.meals);
        refreshMealTargetOptions();
        renderFoodLibrary();
        syncJsonFromWorking(true);
      };
    });


    mount.querySelectorAll('[data-fill-item]').forEach(btn=>{
      btn.onclick = () => {
        const [mi,ii] = btn.getAttribute('data-fill-item').split(':').map(Number);
        const it = working?.meals?.[mi]?.items?.[ii];
        if (!it) return;
        const f = findFoodByName(it.food);
        if (!f) { alert("No exact match found in library. Pick an option from the suggestions or type the exact name."); return; }
        it.kcal = f.kcal; it.p = f.p; it.c = f.c; it.f = f.f;
        renderMealsUI(working.meals);
        refreshMealTargetOptions();
        renderFoodLibrary();
        syncJsonFromWorking(true);
      };
    });

    mount.querySelectorAll('[data-copy-item]').forEach(btn=>{
      btn.onclick = () => {
        const [mi,ii] = btn.getAttribute('data-copy-item').split(':').map(Number);
        const it = working?.meals?.[mi]?.items?.[ii];
        if (!it) return;
        working.meals[mi].items.splice(ii+1, 0, {food:it.food, kcal:it.kcal, p:it.p, c:it.c, f:it.f});
        renderMealsUI(working.meals);
        refreshMealTargetOptions();
        renderFoodLibrary();
        syncJsonFromWorking(true);
      };
    });

    // live input changes
    mount.querySelectorAll('input[data-k="slot"]').forEach(inp=>{
      inp.oninput = () => {
        const mi = Number(inp.getAttribute('data-mi'));
        working.meals = working.meals || [];
        working.meals[mi] = working.meals[mi] || {slot:'', items:[]};
        working.meals[mi].slot = inp.value;
      };
    });

    mount.querySelectorAll('input[data-ii]').forEach(inp=>{
      inp.oninput = () => {
        const mi = Number(inp.getAttribute('data-mi'));
        const ii = Number(inp.getAttribute('data-ii'));
        const k = inp.getAttribute('data-k');
        working.meals = working.meals || [];
        working.meals[mi] = working.meals[mi] || {slot:'', items:[]};
        working.meals[mi].items = working.meals[mi].items || [];
        working.meals[mi].items[ii] = working.meals[mi].items[ii] || {food:'',kcal:0,p:0,c:0,f:0};
        if (k === 'food') working.meals[mi].items[ii].food = inp.value;
        else working.meals[mi].items[ii][k] = sanitizeNum(inp.value);
      };
      inp.onblur = () => {
        const k2 = inp.getAttribute('data-k');
        if (k2 !== 'food') return;
        const mi2 = Number(inp.getAttribute('data-mi'));
        const ii2 = Number(inp.getAttribute('data-ii'));
        const it2 = working?.meals?.[mi2]?.items?.[ii2];
        if (!it2) return;
        const f2 = findFoodByName(it2.food);
        if (f2) {
          it2.kcal = f2.kcal; it2.p = f2.p; it2.c = f2.c; it2.f = f2.f;
          renderMealsUI(working.meals);
          syncJsonFromWorking(true);
        }
      };
    });
  }

  function syncJsonFromWorking(force=true){
    const ta = overlay.querySelector('#dt_meals');
    if (!ta) return;
    if (!force){
      // if advanced JSON is visible, don't overwrite user's edits unless forced
      const wrap = overlay.querySelector('#dt_json_wrap');
      if (wrap && wrap.style.display !== 'none') return;
    }
    ta.value = JSON.stringify(working.meals||[], null, 2);
  }

  function readMealsFromUI(){
    const meals = (working.meals||[]).map(m=>{
      const slot = (m.slot||'').trim();
      const items = (m.items||[]).map(it=>({
        food: (it.food||'').trim(),
        kcal: sanitizeNum(it.kcal),
        p: sanitizeNum(it.p),
        c: sanitizeNum(it.c),
        f: sanitizeNum(it.f),
      })).filter(it=>it.food || it.kcal || it.p || it.c || it.f);
      return { slot: slot || 'Meal', items };
    }).filter(m=>m.items.length || (m.slot && m.slot.trim()));
    return meals;
  }
  // ----------------------------------------------

  overlay.querySelector('#dt_cancel').onclick = () => overlay.remove();


  // Meals UI init
  working.meals = working.meals || [];
  renderMealsUI(working.meals);
  refreshMealTargetOptions();
  renderFoodLibrary();
  syncJsonFromWorking(true);

  const foodSearch = overlay.querySelector('#foodSearch');
  const foodCat = overlay.querySelector('#foodCat');
  const foodMealTarget = overlay.querySelector('#foodMealTarget');
  if (foodSearch) foodSearch.oninput = () => renderFoodLibrary();
  if (foodCat) foodCat.onchange = () => renderFoodLibrary();
  if (foodMealTarget) foodMealTarget.onchange = () => renderFoodLibrary();

  const addCustomFoodBtn = overlay.querySelector('#addCustomFoodBtn');
  if (addCustomFoodBtn) addCustomFoodBtn.onclick = () => {
    openCustomFoodModal(state);
  };

  const addMealBtn = overlay.querySelector('#dt_add_meal');
  if (addMealBtn) addMealBtn.onclick = () => {
    working.meals = working.meals || [];
    working.meals.push({slot:'', items:[{food:'',kcal:0,p:0,c:0,f:0}]});
    renderMealsUI(working.meals);
    syncJsonFromWorking(true);
  };

  const showJson = overlay.querySelector('#dt_show_json');
  const jsonWrap = overlay.querySelector('#dt_json_wrap');
  if (showJson && jsonWrap) showJson.onchange = () => {
    jsonWrap.style.display = showJson.checked ? 'block' : 'none';
    if (showJson.checked) syncJsonFromWorking(true);
  };

  const syncJsonBtn = overlay.querySelector('#dt_sync_json');
  if (syncJsonBtn) syncJsonBtn.onclick = () => syncJsonFromWorking(true);

  const syncFromJsonBtn = overlay.querySelector('#dt_sync_from_json');
  if (syncFromJsonBtn) syncFromJsonBtn.onclick = () => {
    try{
      const meals = JSON.parse(overlay.querySelector('#dt_meals').value || '[]');
      working.meals = (meals||[]);
      renderMealsUI(working.meals);
    } catch(e){
      console.error(e);
      alert('Meals JSON is invalid.');
    }
  };

  overlay.querySelector('#dt_autocalc').onclick = () => {
    try{
      const meals = JSON.parse(overlay.querySelector('#dt_meals').value || '[]');
      const m = computeMacrosFromMeals(meals);
      overlay.querySelector('#dt_kcal').value = m.kcal;
      overlay.querySelector('#dt_p').value = m.p;
      overlay.querySelector('#dt_c').value = m.c;
      overlay.querySelector('#dt_f').value = m.f;
    } catch(e){
      alert('Meals JSON is invalid. Fix JSON first.');
    }
  };

  overlay.querySelector('#dt_save').onclick = () => {
    const name = overlay.querySelector('#dt_name').value.trim();
    if (!name) return alert('Name is required.');

    let meals = [];
    try{ meals = readMealsFromUI(); }
    catch(e){ console.error(e); return alert('Please check meal inputs.'); }

    const tpl = normalizeDietTemplate({
      id: working.id,
      name,
      notes: overlay.querySelector('#dt_notes').value.trim(),
      macros: {
        kcal: Number(overlay.querySelector('#dt_kcal').value) || 0,
        p: Number(overlay.querySelector('#dt_p').value) || 0,
        c: Number(overlay.querySelector('#dt_c').value) || 0,
        f: Number(overlay.querySelector('#dt_f').value) || 0,
      },
      meals
    });
    tpl.updatedAt = Date.now();

    if (isEdit){
      const idx = state.dietTemplates.findIndex(t=>t.id===templateId);
      if (idx>=0) state.dietTemplates[idx] = tpl;
    } else {
      state.dietTemplates.push(tpl);
    }

    save(state);
    overlay.remove();
    render();
  };

  document.body.appendChild(overlay);
}

function openClientDietPlanEditor(state, clientId){
  const client = state.clients.find(c=>c.id===clientId);
  if (!client) return;

  const base = client.activeDietPlan
    ? deepCopy(client.activeDietPlan)
    : (()=>{
        const tpl = state.dietTemplates?.find(t=>t.id===client.assignedTemplateId);
        if (tpl) return { planId: uid(), sourceTemplateId: tpl.id, name: tpl.name, notes: tpl.notes||'', macros: tpl.macros||computeMacrosFromMeals(tpl.meals), meals: deepCopy(tpl.meals||[]), assignedAt: Date.now(), assignedBy:'coach' };
        return { planId: uid(), sourceTemplateId: null, name: 'Custom plan', notes:'', macros: deepCopy(client.macroTargets?.training||{kcal:0,p:0,c:0,f:0}), meals: [], assignedAt: Date.now(), assignedBy:'coach' };
      })();

  const overlay = el(`
    <div style="position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;padding:16px;z-index:999;">
      <div class="card" style="max-width:980px;width:100%;max-height:85vh;overflow:auto;">
        <h2>Edit active diet plan (${client.name})</h2>
        <p class="muted">This edits the client‚Äôs plan only (does not change the template library).</p>

        <label>Plan name</label>
        <input id="cp_name" value="${(base.name||'').replaceAll('"','&quot;')}" />

        <label>Notes</label>
        <textarea id="cp_notes">${base.notes||''}</textarea>

        <h3 style="margin-top:10px;">Macros</h3>
        <div class="row">
          <input id="cp_kcal" style="max-width:140px" placeholder="kcal" value="${base.macros?.kcal ?? ''}" />
          <input id="cp_p" style="max-width:140px" placeholder="protein" value="${base.macros?.p ?? ''}" />
          <input id="cp_c" style="max-width:140px" placeholder="carbs" value="${base.macros?.c ?? ''}" />
          <input id="cp_f" style="max-width:140px" placeholder="fat" value="${base.macros?.f ?? ''}" />
        </div>

        <h3 style="margin-top:10px;">Meals JSON</h3>
        <textarea id="cp_meals" style="min-height:220px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;">${JSON.stringify(base.meals||[], null, 2)}</textarea>

        <div class="row" style="justify-content:flex-end;margin-top:10px;">
          <button id="cp_cancel">Cancel</button>
          <button class="primary" id="cp_save">Save plan</button>
        </div>
      </div>
    </div>
  `);

  overlay.querySelector('#cp_cancel').onclick = () => overlay.remove();
  overlay.querySelector('#cp_save').onclick = () => {
    const name = overlay.querySelector('#cp_name').value.trim();
    if (!name) return alert('Plan name is required.');

    let meals = [];
    try{ meals = JSON.parse(overlay.querySelector('#cp_meals').value || '[]'); }
    catch(e){ return alert('Meals JSON is invalid.'); }

    client.activeDietPlan = {
      planId: base.planId || uid(),
      sourceTemplateId: base.sourceTemplateId || null,
      name,
      notes: overlay.querySelector('#cp_notes').value.trim(),
      macros: {
        kcal: Number(overlay.querySelector('#cp_kcal').value) || 0,
        p: Number(overlay.querySelector('#cp_p').value) || 0,
        c: Number(overlay.querySelector('#cp_c').value) || 0,
        f: Number(overlay.querySelector('#cp_f').value) || 0,
      },
      meals,
      assignedAt: base.assignedAt || Date.now(),
      assignedBy: 'coach',
      updatedAt: Date.now(),
    };

    client.dietPlanHistory = client.dietPlanHistory || [];
    client.dietPlanHistory.push({
      planId: client.activeDietPlan.planId,
      name: client.activeDietPlan.name,
      at: Date.now(),
      note: 'Coach edited active plan'
    });

    // keep macroTargets in sync for existing UI
    client.macroTargets = client.macroTargets || {training:{kcal:0,p:0,c:0,f:0}, rest:{kcal:0,p:0,c:0,f:0}};
    client.macroTargets.training = deepCopy(client.activeDietPlan.macros);

    save(state);
    overlay.remove();
    alert('Saved client diet plan.');
    render();
  };

  document.body.appendChild(overlay);
}

function viewDiet(state){
  const root = document.getElementById('app');
  root.innerHTML = '';

  state.dietTemplates = (state.dietTemplates || []).map(normalizeDietTemplate);
  save(state);

  const wrap = el(`
    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div>
          <h1>Diet templates</h1>
          <p class="muted">Create/edit templates, then assign them to clients. Import/export lets you ‚Äúload‚Äù template packs.</p>
        </div>
        <div class="row">
          <label class="row" style="margin:0;gap:6px;">
            <input id="dt_import" type="file" accept=".json" style="width:auto;" />
            <span class="muted">Import</span>
          </label>
          <button class="small" id="dt_export">Export</button>
          <button class="primary" id="dt_new">New template</button>
          <button class="small" id="dt_back">Back to coach</button>
        </div>
      </div>

      <hr class="hr" />
      <div id="dt_list"></div>

      <div class="hint">Tip: Export a ‚Äútemplate pack‚Äù once, then import it on any new device/browser.</div>
    </div>
  `);
  root.appendChild(wrap);

  const list = wrap.querySelector('#dt_list');
  function paint(){
    list.innerHTML = '';
    if (!state.dietTemplates.length){
      list.appendChild(el('<div class="card warn" style="border-radius:12px;"><b>No plans yet</b><div class="muted">Click ‚ÄúNew template‚Äù to create one.</div></div>'));
      return;
    }

    state.dietTemplates
      .slice()
      .sort((a,b)=> (b.updatedAt||0)-(a.updatedAt||0))
      .forEach(tpl=>{
        const row = el(`
          <div class="card" style="border-radius:12px;margin-bottom:10px;">
            <div class="row" style="justify-content:space-between;align-items:flex-start;">
              <div>
                <b>${tpl.name}</b>
                <div class="muted">${tpl.notes ? tpl.notes.slice(0,120) : '‚Äî'}</div>
                <div class="row" style="margin-top:6px;">
                  <span class="tag">${tpl.macros?.kcal ?? 0} kcal</span>
                  <span class="tag">P ${tpl.macros?.p ?? 0}</span>
                  <span class="tag">C ${tpl.macros?.c ?? 0}</span>
                  <span class="tag">F ${tpl.macros?.f ?? 0}</span>
                  <span class="tag">Meals: ${(tpl.meals||[]).length}</span>
                </div>
              </div>
              <div class="row">
                <button class="small" data-edit>Edit</button>
                <button class="small" data-dup>Duplicate</button>
                <button class="small danger" data-del>Delete</button>
              </div>
            </div>
          </div>
        `);
        row.querySelector('[data-edit]').onclick = ()=> openDietTemplateEditor(state, {templateId: tpl.id});
        row.querySelector('[data-dup]').onclick = ()=>{
          const copy = deepCopy(tpl);
          copy.id = uid();
          copy.name = (copy.name||'Template') + ' (copy)';
          copy.updatedAt = Date.now();
          state.dietTemplates.push(copy);
          save(state);
          paint();
        };
        row.querySelector('[data-del]').onclick = ()=>{
          if (!confirm('Delete this template?')) return;
          state.dietTemplates = state.dietTemplates.filter(x=>x.id!==tpl.id);
          // also detach from clients
          (state.clients||[]).forEach(c=>{ if (c.assignedTemplateId===tpl.id) c.assignedTemplateId=''; });
          save(state);
          paint();
        };
        list.appendChild(row);
      });
  }
  paint();

  wrap.querySelector('#dt_new').onclick = ()=> openDietTemplateEditor(state);
  wrap.querySelector('#dt_export').onclick = ()=> exportDietTemplates(state);
  wrap.querySelector('#dt_back').onclick = ()=> { state.ui.view='coach'; save(state); render(); };
  wrap.querySelector('#dt_import').onchange = (e)=>{
    const f = e.target.files?.[0];
    if (f) importDietTemplatesFromFile(f, state);
  };
}

/** ========= Router ========= */
function render(){
  setEnvPill();
  const state = migrateState(load());

  state.ui = state.ui || { view:"landing", selectedClientId: state.clients?.[0]?.id || "", coach:{alertsOnly:false}, selectedExercise:"Bench Press" };

  // selected client sanity
  if (state.clients?.length && (!state.ui.selectedClientId || !state.clients.find(c=>c.id===state.ui.selectedClientId))){
    state.ui.selectedClientId = state.clients[0].id;
    save(state);
  }

  // ensure today's daily row exists
  (state.clients || []).forEach(ensureClientToday);

  setHeaderSession(state);
  if (state.session) wireTopNav(state);

  const root = document.getElementById("app");
  root.innerHTML = "";

  if (!state.session){
    if (state.ui.view==="landing") return viewLanding(state);
    if (state.ui.view==="pricing") return viewPricing(state);
    state.ui.view="login"; save(state);
    return viewLogin(state);
  }

  const user = state.users.find(u=>u.id===state.session.userId);

  if (state.ui.view==="landing") return viewLanding(state);
  if (state.ui.view==="pricing") return viewPricing(state);
  if (state.ui.view==="messages") return viewMessages(state);
  if (state.ui.view==="progress") return viewProgress(state);
  if (state.ui.view==="history") return viewHistory(state);
  if (state.ui.view==="diet") return (user.role==="coach" ? viewDiet(state) : viewClient(state));

  if (user.role==="coach"){
    if (state.ui.view==="client") return viewClient(state);
    state.ui.view="coach"; save(state);
    return viewCoach(state);
  }

  // client role: lock to their clientId
  state.ui.selectedClientId = user.clientId || "c1";
  state.ui.view = "client";
  save(state);
  return viewClient(state);
}

// logout
document.getElementById("logoutBtn").onclick = () => {
  const state = load();

  state.session = null;
  state.ui.view = "landing";
  save(state);
  render();
};

render();

/** ========= Genetics Editor ========= */
function openGeneticsEditor(state, clientId){
  state.ui = state.ui || {};
  state.ui.geneticsEditingClientId = clientId;
  save(state);
  render();
}

</script>
</body>
</html>
